


<html>

      <head>
      
            <title>name constraints in x509 certificate</title>

            <base href='https://javascript-2020.github.io/blog/25-09-29/name-constraints-in-x509-certificate/name-constraints-in-x509-certificate.html'>
            <link rel=canonical href='https://ext-code.com/blog/25-09-29/name-constraints-in-x509-certificate/name-constraints-in-x509-certificate.html'>
            
            <meta name=viewport content='width=device-width, initial-scale=1'>
            <link rel=icon type='image/png' href='/blog/image/blog-30.png'>
            
            <link rel=stylesheet href='/blog/css/blog.css'>
            


            
            <script src='https://www.cryptool.org/wasm/openssl.js'></script>

            <script init>
                                                                                console.clear();
                                                                                console.log('name-constraints-in-x509-certificate');
                                                                                console.log();
                                                                                console.json=v=>console.log(JSON.stringify(v,null,4));
        var mod     = {};

        var ext;
        var $;
        var datatype;
        var menumod;
        var keydown;

        var menu;

        async function init(){


              menu                = mod.menumod();
              
              config              = mod['code-block']();
              cmd                 = mod['code-block']();
              
              config.initmod({ext,$,datatype,menu});
              cmd.initmod({ext,$,datatype,menu});
              
              await config.init();
              await cmd.init();
              
              
              initdom(document.body);
              
        }//init


        init.stack            = [init];
        init.stack.ct         = 0;
        init.stack.total      = 1;
        Object.defineProperty(init.stack,'add',{get:()=>{init.stack.total++}});
        Object.defineProperty(init.stack,'complete',{get:()=>{
        
              init.stack.ct++;
              if(init.stack.ct>=init.stack.total){
                                                                                //console.log('*** complete');
                    init.stack.ct       = 0;
                    init.stack.total    = 0;
                    var list    = [...init.stack];
                    init.stack.length   = 0;
                    list.forEach(fn=>fn());
              }
              
        }});

        
(async()=>{

        init.stack.add;

        ({ext}   = await import('https://libs.ext-code.com/js/io/ext-loader/ext-loader.m.js'));
        
        [$,datatype,menumod,keydown]    = await ext.load.libs(
              'js/dom/$.js',
              'js/core/datatype.js',
              'js/dom/menumod/menumod.js',
              'js/dom/keydown/keydown.js'              
        );
        
        init.stack.complete;

})();

            </script init>
            
            <style>

  #desc
    {margin-bottom:30px}
    
  #config
    {display:block;margin-bottom:30px}
    
  #cmd
    {display:block;margin-bottom:30px}
    
  #fs
    {font-family:monospace;white-space:pre-wrap;margin:10px;padding:10px;border:1px solid lightblue;
      display:flex;flex-direction:column;line-height:1.4}
    
  #output
    {font-family:monospace;white-space:pre-wrap;margin:10px;padding:10px;border:1px solid lightgray;line-height:1.4}
    
  input
    {font-size:16px;padding:5px 10px}
  input[type=button]
    {cursor:pointer}

    
            </style>
      </head>
      
      
      <body>


      
            <h3>
                  add name constraints to a x509 certificate
            </h3>


            <div id=desc>

add name constraints to a x509 certificate
            
            </div>

            <div>
                  ca-ext.ini
            </div>
            
            <code-block api id=config>
                  <script src='https://html-loader-1024713184986.us-central1.run.app/'></script>
[ req ]
distinguished_name = req_distinguished_name
x509_extensions = v3_ca
prompt = no

[ req_distinguished_name ]
CN = My Test CA

[ v3_ca ]
basicConstraints = critical, CA:TRUE
keyUsage = critical, keyCertSign, cRLSign
subjectKeyIdentifier = hash
nameConstraints = critical, @nc

[ nc ]
permitted;DNS.1 = .example.com
permitted;DNS.2 = .internal.local
excluded;DNS.1 = .malicious.com
permitted;IP.1 = 192.168.0.0/255.255.0.0
            
            
            </code-block>
            
            <code-block id=cmd>
                  <script src='https://html-loader-1024713184986.us-central1.run.app/'></script>
                  
openssl genrsa -out ca.key.pem 1024
openssl req -new -key ca.key.pem -out ca.csr -extensions v3_ca -config ca-ext.ini
openssl x509 -req -in ca.csr -signkey ca.key.pem -extfile ca-ext.ini -extensions v3_ca -out ca.crt

            </code-block>
      
            <div>
                  <input value=run type=button>
            </div>
            
            <div id=fs>
            </div>
            
            <div id=output></div>
            
      </body>
      
      <script>


        var root;
        var config;
        var cmd;
        var output;
        
        
        var btn   = {};
        
        
        
        function initdom(rootnode){
        
              root                          = rootnode;
              
              
              var node                      = $(root,'#config');
              config.initdom(node,{mode:'text'});
              
              var node                      = $(root,'#cmd');
              cmd.initdom(node,{mode:'text'});
              
              
              
              $('[value=run]').onclick      = btn.run;
              
              
              output                        = $(root,'#output');
              
              
              config.focus();
              
        }//initdom



  //:


        btn.run   = async function(){
        
              openssl       = openssl({stdout,stderr});
              var Module    = await openssl.init();
              console.log(Module);
              
              //var txt   = $('#config').textContent;
              var txt   = config.getvalue();
              
              
              Module.FS.writeFile('ca-ext.ini',txt);
              var snapshot    = openssl.fs.snapshot(Module);
                                                                                console.log('***',snapshot);
              openssl.fs.set(snapshot);
              
              
              //var txt     = $('#cmd').textContent;
              var txt     = cmd.getvalue();
              txt         = txt.trim();
              var list    = txt.split('\n');
              var cmds    = list.map(line=>{
              
                    line        = line.trim();
                    var args    = line.split(' ');
                    args.shift();
                                                                                console.log(args);
                    return args;
                    
              });


              var n   = cmds.length;
              for(var i=0;i<n;i++){
              
                    var args    = cmds[i];
                                                                                console.log(i,cmd);
                    var str   = 'openssl '+args.join(' ');
                    disp(str);
                    
                    await openssl.run(...args);
              
              }//for
              
              //await openssl.run('genrsa','-out','ca.key.pem','1024');
              //await openssl.run('rsa','-in','ca.key.pem','-text','-noout');
              
              $('#fs').replaceChildren();
              var fs    = openssl.fs.complete();
                                                                                console.log(fs);
              for(var path in fs){
              
                    var path2   = path.slice(1);
                    let blob    = new Blob([fs[path]]);
                    let url     = window.URL.createObjectURL(blob);
                    let a       = document.createElement('a');
                    a.href      = url;
                    a.textContent   = path2;
                    a.download      = path2;
                    $('#fs').append(a);
                    
              }//for
        
        }//run

        
        function disp(txt){
        
              var div   = document.createElement('div');
              div.textContent   = txt;
              output.append(div);
              
        }//disp
        
        
        function stdout(txt){
        
              var str   = '[ stdout ] '+txt;
              var div   = document.createElement('div');
              div.textContent   = str;
              output.append(div);
              console.log(str);
              
        }//stdout
        
        
        function stderr(txt){
        
              var str   = '[ stderr ] '+txt;
              var div   = document.createElement('div');
              div.textContent   = str;
              output.append(div);
              console.log(str);
              
        }//stderr

  //:
  
  
        function openssl(params){
        
          var obj   = {};
          
              var initial;
              var snapshot;
              var fs    = {};
              obj.fs    = fs;
      
              
              obj.init    = function(){return init()}
              
              async function init(){
                                                                                console.log('init');
                    var Module    = {print,printErr,onRuntimeInitialized};
                    await EmscrJSR_openssl(Module);
                                                                                console.log(1);
                    return Module;
                    
                    
                    function print(txt){
                    
                          if(params.stdout){
                                params.stdout(txt);
                          }
                          //output.textContent   += txt+'\n';
                          
                    }//print
      
                    
                    function printErr(txt){
                    
                          if(params.stderr){
                                params.stderr(txt);
                          }
                          //output.textContent    += '[stderr] '+txt+'\n';
                          
                    }//printErr
      
                    
                    function onRuntimeInitialized(){
                                                                                      console.log("OpenSSL ready");
                                                                                      console.log(Module);
                            if(!initial){
                                                                                      console.log('initial');
                                  initial   = fs.snapshot(Module);
                            }
                            if(snapshot){
                                  fs.restore(Module,snapshot);
                            }
                            //resolve(Module);
                            
                    }//onRuntimeInitialized
                          
              }//init
              
              
              
              obj.run   = async function(){
              
                    var Module    = await init();
                    
                    Module.callMain([...arguments]);
                    snapshot    = fs.snapshot(Module);
                    
                    return Module;
                    
              }//run
        
      
      
              fs.snapshot   = function(Module,path='/'){
                                                                                      //console.log('fs.snapshot');
                    var snapshot    = {};
                    var entries     = Module.FS.readdir(path);
                  
                    entries.forEach((entry) => {
                    
                          if(entry==='.'||entry==='..')return;
                          
                          var fullPath    = path+entry;
                                                                                      //console.log('fullpath',fullPath);
                          try{
                          
                                var stats   = Module.FS.stat(fullPath);
                            
                                if(Module.FS.isFile(stats.mode)){
                                                                                      //console.log('fullpath',fullPath);
                                      var uint8             = Module.FS.readFile(fullPath);
                                      snapshot[fullPath]    = uint8;
                                }
                                if(Module.FS.isDir(stats.mode)){
                                      Object.assign(snapshot,fs.snapshot(Module,fullPath+'/')); // recurse
                                }
                                
                          }//try
                          catch(err){
                          }//catch
                      
                    });
                  
                    return snapshot;
                    
              }//snapshotfs
              
              
              fs.restore    = function(Module,snapshot){
                                                                                //console.log('fs.restore');
                    Object.entries(snapshot).forEach(([path,content])=>{
                    
                          var parts     = path.split("/").slice(1,-1);
                          var current   = "/";
                          
                          parts.forEach((part) => {
                          
                                var next    = current+'/'+part;
                                
                                try{
                                
                                      Module.FS.mkdir(next);
                                      
                                }//try
                                catch(err){
                                                                          // already exists
                                }//catch
                                
                                current   = next;
                          });
                                                                                //console.log(path);
                          Module.FS.writeFile(path,content);
                          
                    });
                    
              }//restore
              
              
              fs.set    = function(snap){
              
                    snapshot    = snap;
                    
              }//fs.set
              
              
              fs.diff   = function(snap1,snap2){
              
                    var k1        = Object.keys(snap1);
                    var s1        = new Set(k1);
                    var k2        = Object.keys(snap2);
                    var s2        = new Set(k2);
                    var d         = s2.difference(s1);
                    var result    = {};
                    d.forEach(key=>result[key]=snap2[key]);
                    return result;
                    
              }//diff
              
              
              fs.complete   = function(){
              
                    var result    = fs.diff(initial,snapshot);
                    return result;
                    
              }//complete
              
              
          return obj;
        
        }//openssl

  //:
  
  init.stack.complete;
  
  
      </script>      
            
</html>


