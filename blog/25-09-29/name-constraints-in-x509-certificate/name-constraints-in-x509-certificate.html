


<html>

      <head>
      
            <title>name constraints in x509 certificate</title>

            <base href='https://javascript-2020.github.io/blog/25-09-29/name-constraints-in-x509-certificate/name-constraints-in-x509-certificate.html'>
            <link rel=canonical href='https://ext-code.com/blog/25-09-29/name-constraints-in-x509-certificate/name-constraints-in-x509-certificate.html'>
            
            <meta name=viewport content='width=device-width, initial-scale=1'>
            <link rel=icon type='image/png' href='/blog/image/blog-30.png'>
            
            <link rel=stylesheet href='/blog/css/blog.css'>
            


            
            <script src='https://www.cryptool.org/wasm/openssl.js'></script>

            <script init>
                                                                                console.clear();
                                                                                console.log('name-constraints-in-x509-certificate');
                                                                                console.log();
                                                                                console.json=v=>console.log(JSON.stringify(v,null,4));
        var mod     = {};

        var ext;
        var $;
        var datatype;


        async function init(){
        
              initdom(document.body);
              
        }//init


        init.stack            = [];
        init.stack.ct         = 0;
        init.stack.total      = 1;
        Object.defineProperty(init.stack,'add',{get:()=>{init.stack.total++}});
        Object.defineProperty(init.stack,'complete',{get:()=>{init.stack.ct++;init.stack.ct>=init.stack.total && init()}});
        
(async()=>{

        init.stack.add;

        var {ext}   = await import('https://libs.ext-code.com/js/io/ext-loader/ext-loader.m.js');
        console.log(ext.toString())
        
        [$,datatype]    = await ext.load.libs(
              'js/dom/$.js',
              'js/core/datatype.js',
        );
        
        init.stack.complete;

})();

            </script init>
            
      </head>
      
      
      <body>


      
            <h3>
                  add name constraints to a x509 certificate
            </h3>


            <div id=desc>

add name constraints to a x509 certificate
            
            </div>

            <div>
                  ca-ext.ini
            </div>
            
            <code id=config>

[ req ]
distinguished_name = req_distinguished_name
x509_extensions = v3_ca
prompt = no

[ req_distinguished_name ]
CN = My Test CA

[ v3_ca ]
basicConstraints = critical, CA:FALSE
keyUsage = critical, keyCertSign, cRLSign
subjectKeyIdentifier = hash
nameConstraints = critical, @nc

[ nc ]
permitted;DNS.1 = .example.com
permitted;DNS.2 = .internal.local
excluded;DNS.1 = .malicious.com
permitted;IP.1 = 192.168.0.0/255.255.0.0
            
            
            </code>
            
            <code id=cmd>

openssl genrsa -out ca.key.pem 1024
openssl req -new -key ca.key.pem -out ca.csr -subj "/C=US/O=Example/OU=CA" -extensions v3_ca -config ca-ext.ini
openssl x509 -req -in ca.csr -signkey ca.key.pem -extfile ca-ext.ini -extensions v3_ca -out ca.crt


            </code>
      
            <div>
                  <input value=run type=button>
            </div>
            
            <div id=fs></div>
            
            <div id=output></div>
            
      </body>
      
      <script>


        var root;
        
        var btn   = {};
        
        
        
        function initdom(rootnode){debugger;
        
              root                          = rootnode;
              
              $('[value=run]').onclick      = btn.run;
              
              
              
        }//initdom



  //:


        btn.run   = async function(){
        
              openssl       = openssl({stdout,stderr});
              var Module    = await openssl.init();
              console.log(Module);
              
              var txt   = $('#config').textContent;
              console.log(txt);
              
              Module.fs.writeFile('/ca-ext.ini',txt);
              
              var txt     = $('#cmd').textContent;
              txt         = txt.trim();
              var list    = txt.split('\n');
              list.forEach(line=>{
              
                    line        = line.trim();
                    var args    = line.split(' ');
                    args.shift();
                    console.log(args);
                    
              });
              
              
              
              //await openssl.run('genrsa','-out','ca.key.pem','1024');
              //await openssl.run('rsa','-in','ca.key.pem','-text','-noout');
              
              //var fs    = openssl.fs.complete();
              //console.log(fs);
              
        
        }//run

        
        function stdout(txt){
        
              console.log('[ stdout ]',txt);
              
        }//stdout
        
        
        function stderr(txt){
        
              console.log('[ stderr ]',txt);
              
        }//stderr

  //:
  
  
        function openssl(params){
        
          var obj   = {};
          
              var initial;
              var snapshot;
              var fs    = {};
              obj.fs    = fs;
      
              
              obj.init    = function(){return init()}
              
              async function init(){
      
                    var Module    = {print,printErr,onRuntimeInitialized};
                    await EmscrJSR_openssl(Module);
                    return Module;
                    
                    
                    function print(txt){
                    
                          if(params.stdout){
                                params.stdout(txt);
                          }
                          //output.textContent   += txt+'\n';
                          
                    }//print
      
                    
                    function printErr(txt){
                    
                          if(params.stderr){
                                params.stderr(txt);
                          }
                          //output.textContent    += '[stderr] '+txt+'\n';
                          
                    }//printErr
      
                    
                    function onRuntimeInitialized(){
                                                                                      console.log("OpenSSL ready");
                                                                                      console.log(Module);
                            if(!initial){
                                  initial   = fs.snapshot(Module);
                            }
                            if(snapshot){
                                  fs.restore(Module,snapshot);
                            }
                            //resolve(Module);
                            
                    }//onRuntimeInitialized
                          
              }//init
              
              
              
              obj.run   = async function(){
              
                    var Module    = await init();
                    
                    Module.callMain([...arguments]);
                    snapshot    = fs.snapshot(Module);
                    
                    return Module;
                    
              }//run
        
      
      
              fs.snapshot   = function(Module,path='/'){
              
                    var snapshot    = {};
                    var entries     = Module.FS.readdir(path);
                  
                    entries.forEach((entry) => {
                    
                          if(entry==='.'||entry==='..')return;
                          
                          var fullPath    = path+entry;
                                                                                      //console.log('fullpath',fullPath);
                          try{
                          
                                var stats   = Module.FS.stat(fullPath);
                            
                                if(Module.FS.isFile(stats.mode)){
                                      var uint8             = Module.FS.readFile(fullPath);
                                      snapshot[fullPath]    = uint8;
                                }
                                if(Module.FS.isDir(stats.mode)){
                                      Object.assign(snapshot,snapshotFS(Module,fullPath+'/')); // recurse
                                }
                                
                          }//try
                          catch(err){
                          }//catch
                      
                    });
                  
                    return snapshot;
                    
              }//snapshotfs
              
              
              fs.restore    = function(Module,snapshot) {
              
                    Object.entries(snapshot).forEach(([path,content])=>{
                    
                          var parts     = path.split("/").slice(1,-1);
                          var current   = "/";
                          
                          parts.forEach((part) => {
                          
                                var next    = current+'/'+part;
                                
                                try{
                                
                                      Module.FS.mkdir(next);
                                      
                                }//try
                                catch(err){
                                                                          // already exists
                                }//catch
                                
                                current   = next;
                          });
                      
                          Module.FS.writeFile(path,content);
                          
                    });
                    
              }//restore
              
              
              fs.diff   = function(snap1,snap2){
              
                    var k1        = Object.keys(snap1);
                    var s1        = new Set(k1);
                    var k2        = Object.keys(snap2);
                    var s2        = new Set(k2);
                    var d         = s2.difference(s1);
                    var result    = {};
                    d.forEach(key=>result[key]=snap2[key]);
                    return result;
                    
              }//diff
              
              
              fs.complete   = function(){
              
                    var result    = fs.diff(initial,snapshot);
                    return result;
                    
              }//complete
              
              
          return obj;
        
        }//openssl

  //:
  
  init.stack.complete;
  
  
      </script>      
            
</html>


