        
      <link rel=stylesheet href='https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css'>
        
      <style>

  body
    {display:flex;flex-direction:column;gap:10px}
    
  #terminal
    {height:500px}
        
      </style>

      <h3>rollup example</h3>
      
      <iframe id=iframe></iframe>
      
      <div id=terminal></div>

      
      <script>        

(()=>{

        var term;
        var webcontainer;
        var files   = {};

        
        var packages          = ['espree',];
        var filename          = 'espree.m.js';

        
        async function setup(){
        
              var {Terminal}    = await import('https://cdn.jsdelivr.net/npm/@xterm/xterm/+esm');
              var {FitAddon}    = await import('https://cdn.jsdelivr.net/npm/@xterm/addon-fit/+esm');
              
              term                = new Terminal();
              var fitAddon        = new FitAddon();
              term.loadAddon(fitAddon);
              term.open(terminal);
              fitAddon.fit();
                                                                                console.clear();
                                                                                console.log('rollup example');
                                                                                console.log();        
        }//setup
        
        
        setTimeout(start,50);
        
        
        async function start(){
                                                                                
              await setup();

              
              packages.shift(
                    'rollup',
                    '@rollup/plugin-commonjs',
                    '@rollup/plugin-node-resolve',
                    '@rollup/plugin-json',
                    'rollup-plugin-polyfill-node'
              );


              for(var key in files){
              
                    files[key]   = {file:{contents:files[key]};
                    
              }//for


                                                                                console.log('download ...');              
              var {WebContainer}    = await import('https://cdn.jsdelivr.net/npm/@webcontainer/api/+esm');
              
                                                                                console.log('booting ...');
              webcontainer          = await WebContainer.boot();
              
                                                                                console.log('mounting file system ...');
              await webcontainer.mount(files);
              
              
                                                                                
              await package_json();
              await install();
                                                                                
              await rollup();                                                                        
                                                                                
              await server();
                                                                                console.log('done.');
                                                                                
              
              async function package_json(){
                                                                                console.log('npm install ( package.json ) ...');
                    var process   = await webcontainer.spawn('npm',['install']);
                    var stream    = new WritableStream({write(data){console.term(data)}});
                    process.output.pipeTo(stream)
                    var code      = await process.exit;
                    if(code!=0){
                                                                                console.log('an error occurred');
                    }
                    return code;
              
              }//package_json
              
              
              async function install(){
                                                                                var str   = packages.join(' ');
                                                                                console.log('npm install',str,'...');
                    packages.unshift('install');
                    var process   = await webcontainer.spawn('npm',packages);
                    var stream    = new WritableStream({write(data){console.term(data)}});
                    process.output.pipeTo(stream)
                    var code      = await process.exit;
                    if(code!=0){
                                                                                console.log('an error occurred');
                    }
                    return code;
                    
              }//install
              
              
              async function rollup(){
                                                                                console.log('rollup ...');
                    var process   = await webcontainer.spawn('npx',['-y','rollup','--config','rollup.config.js']);
                    
                    var stream    = new WritableStream({write(data){console.term(data)}});
                    process.output.pipeTo(stream);
                    
                    var code      = await process.exit;
                    if(code!=0){
                                                                                console.log('an error occurred');
                    }
                    return code;
              
              }//rollup
              

              async function server(){
                                                                                console.log('launching server ...');
                    webcontainer.on('server-ready',(port,url)=>iframe.src=url);
              
                    var process   = await webcontainer.spawn('node',['server.js']);
                    
                    var stream    = new WritableStream({write(data){console.term(data)}});
                    process.output.pipeTo(stream);
                    
                    var code      = await process.exit;
                    if(code!=0){
                                                                                console.log('an error occurred');
                    }
                    return code;
                    
              }//server
              
        }//start
        

  //:
  
        
        files['package.json']   = `
        
              {
                    "name": "node-test",
                    "version": "1.0.0",
                    "scripts": {
                    }
              }
        
        `;
        
        
        files['rollup.config.js']   = `

              import resolve from '@rollup/plugin-node-resolve';
              import commonjs from '@rollup/plugin-commonjs';
              import json from '@rollup/plugin-json';              
              import nodePolyfills from 'rollup-plugin-polyfill-node';

              export default {
                input     : 'index.js',
                output    : {
                                  file      : ${filename},
                                  format    : 'es'
                                  
                                  //format    : 'iife', // or 'umd'
                                  //name      : 'EspreeBundle'    // This becomes window.EspreeBundle


                },
                plugins   : [
                                  commonjs(),
                                  json(),
                                  nodePolyfills(),
                                  resolve({preferBuiltins:false})
                            ]
              };

        `;


        files['entry.js']   = `
        
              import * as espree from 'espree';
              export {espree};
              
        `;

        
        files['server.js']    = `
        
              var port          = 3000;
          
              require('http').createServer(request).listen(port);
              
              var fs    = require('fs');
                                                                                          console.log('listening',port);
          
              function request(req,res){
                                                                                          console.log(req.method,req.url);
                    res.setHeader('access-control-allow-origin','*');
                    
                    if(req.method==='OPTIONS'){    //  cors
                          res.writeHead(204);
                          res.end();
                          return;
                    }
          
                    if(req.url==='/${filename}'){
                          var stream    = fs.createReadStream(${filename});
                          res.writeHead(200,{'content-type':'application/octet-stream'});
                          stream.pipe(res);
                          return;
                    }
          
                    res.writeHead(200,{'content-type':'text/html'});
                    res.end(\`
                          
                          <a href='${filename}'>${filename}</a>
                          
                    \`);
          
              }//request
        
        `;
        

  //:
  
  
        var console   = {};
        console.term    = function(){
                          
                                window.console.log.apply(window.console,arguments);
                                term.write.apply(term,arguments);
                                
                          }//term
        console.clear   = function(){
                          
                                window.console.clear();
                                term.reset();
                                
                          }//clear
        console.log     = function(){
        
                                window.console.log(window.console,arguments);
                                term.writeln.apply(term,arguments);
                                
                          }//log



})();


</script>



