
      <link rel=stylesheet href='https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css'>
      
      <style>
      
  body
    {margin:20px;display:flex;flex-direction:column;gap:10px;font-family:arial}
    
  iframe
    {width:100%;height:300px}
    
  #terminal
    {height:500px}
    
      </style>
      
      <h3>rollup example</h3>
      
      <iframe id=iframe></iframe>
      
      <div id=terminal></div>
      
      
      <script>
      
(()=>{

        var term;
        var webcontainer;
        var files   = {};
        
        
        var packages          = ['espree'];
        var filename          = 'espree.m.js';
        
        files['entry.js']   = `
        
              import * as espree from 'espree';
              export {espree};
              
              //export default espree;  // iife / umd
              
        `;
        
        
        files['index.html']   = `
        
              <div style='display:flex;flex-direction:column;gap:10px'>
              
                    <h4>index.html</h4>
                    
                    <input value=download type=button onclick='download()'>
                    <br>
                    <a href='/test.html'>test</a>
                    <br>
                    <a href='/test2.html'>test-2</a>
                    
              </div>
              
              <script>
              
                    async function download(){
                    
                          var res       = await fetch('${filename}');
                          var blob      = await res.blob();
                          var url       = URL.createObjectURL(blob);
                          var a         = document.createElement('a');
                          a.href        = url;
                          a.download    = '${filename}';
                          a.click();
                          
                    }//download
                    
              </scr`+`ipt>
              
        `;
        
        
        files['test.html']    = `
        
              <div style='display:flex;flex-direction:column;gap:10px'>
              
                    <h4>test.html</h4>
                    
                    <a href='/'>home</a>
                    <div id=output style='white-space:pre;font-family:monospace'></div>
              </div>
              
              <script type=module>
              
                    import {espree} from '/espree.m.js';
                    
                    var js    = 'let a=42';
                    test(js);
                    
                    
                    function test(js){
                    
                          log(js);
                          
                          var err;
                          try{
                          
                                var result            = espree.parse(js,{ecmaVersion:'latest'});
                                
                          }
                          catch(err2){
                          
                                err   = err2;
                                
                          }
                          if(err){
                                log(err.toString());
                                return;
                          }
                          
                          var str   = JSON.stringify(result,null,4);
                          log(str);
                          
                    }//test
                    
                    
                    function log(){
                    
                          var str   = [...arguments].join(' ');
                          output.textContent   += str+'\\n';
                          
                    }//log
                    
              </scr`+`ipt>
              
        `;
        
        files['test2.html']    = `
        
              <div style='display:flex;flex-direction:column;gap:10px'>
              
                    <h4>test2.html</h4>
                    
                    <a href='/'>home</a>
                    <div id=output style='white-space:pre;font-family:monospace'></div>
              </div>
              
              <script src='espree.js'></scr`+`ipt>
              <script>
                                                                                console.log(espree);
                    var js    = 'let a=42';
                    test(js);
                    
                    
                    function test(js){
                    
                          log(js);
                          
                          var err;
                          try{
                          
                                var result            = espree.parse(js,{ecmaVersion:'latest'});
                                
                          }
                          catch(err2){
                          
                                err   = err2;
                                
                          }
                          if(err){
                                log(err.toString());
                                return;
                          }
                          
                          var str   = JSON.stringify(result,null,4);
                          log(str);
                          
                    }//test
                    
                    
                    function log(){
                    
                          var str   = [...arguments].join(' ');
                          output.textContent   += str+'\\n';
                          
                    }//log
                    
              </scr`+`ipt>
              
        `;
        
        
        async function setup(){
        
              var {Terminal}    = await import('https://cdn.jsdelivr.net/npm/@xterm/xterm/+esm');
              var {FitAddon}    = await import('https://cdn.jsdelivr.net/npm/@xterm/addon-fit/+esm');
              
              term                = new Terminal();
              var fitAddon        = new FitAddon();
              term.loadAddon(fitAddon);
              term.open(terminal);
              fitAddon.fit();
                                                                                console.clear();
                                                                                console.log('rollup example');
                                                                                console.log();
        }//setup
        
        
        setTimeout(start,50);
        
        
        async function start(){
        
              await setup();
              
              
              for(var key in files){
              
                    files[key]   = {file:{contents:files[key]}};
                    
              }//for
              
              
                                                                                console.log('download ...');
              var {WebContainer}    = await import('https://cdn.jsdelivr.net/npm/@webcontainer/api/+esm');
              
                                                                                console.log('booting ...');
              webcontainer          = await WebContainer.boot();
              
                                                                                console.log('mounting file system ...');
              await webcontainer.mount(files);
              
              
              await install();
              await package_json();
              await install_rollup();
              
              
              await rollup();
              
              await server();
                                                                                console.log('done.');
                                                                                
                                                                                
              async function install(){
                                                                                var str   = packages.join(' ');
                                                                                console.log('npm install',str,'...');
                    packages.unshift('install');
                    var process   = await webcontainer.spawn('npm',packages);
                    var stream    = new WritableStream({write(data){term.write(data)}});
                    process.output.pipeTo(stream)
                    var code      = await process.exit;
                    if(code!=0){
                                                                                console.log('an error occurred');
                    }
                    return code;
                    
              }//install
              
              
              async function package_json(){
                                                                                console.log('npm install ( package.json ) ...');
                    var process   = await webcontainer.spawn('npm',['install']);
                    var stream    = new WritableStream({write(data){term.write(data)}});
                    process.output.pipeTo(stream)
                    var code      = await process.exit;
                    if(code!=0){
                                                                                console.log('an error occurred');
                    }
                    return code;
                    
              }//package_json
              
              
              async function install_rollup(){
              
                    var packages    = [
                          'rollup',
                          '@rollup/plugin-commonjs',
                          '@rollup/plugin-node-resolve',
                          '@rollup/plugin-json',
                          'rollup-plugin-polyfill-node'
                    ];
                                                                                console.log('npm install',packages.join(' '),'...');
                    packages.unshift('install');
                    
                    var process   = await webcontainer.spawn('npm',packages);
                    var stream    = new WritableStream({write(data){term.write(data)}});
                    process.output.pipeTo(stream)
                    var code      = await process.exit;
                    if(code!=0){
                                                                                console.log('an error occurred');
                    }
                    return code;
                    
              }//install_rollup
              
              
              async function rollup(){
                                                                                console.log('perform rollup ...');
                    var process   = await webcontainer.spawn('npx',['-y','rollup','--config','rollup.config.js']);
                    
                    var stream    = new WritableStream({write(data){term.write(data)}});
                    process.output.pipeTo(stream);
                    
                    var code      = await process.exit;
                    if(code!=0){
                                                                                console.log('an error occurred');
                    }
                    return code;
                    
              }//rollup
              
              
              async function server(){
                                                                                console.log('launching server ...');
                    webcontainer.on('server-ready',(port,url)=>{
                                                                                console.log('server : ',url,port);
                          iframe.src    = url;
                          
                    });
                    
                    var process   = await webcontainer.spawn('node',['server.js']);
                    
                    var stream    = new WritableStream({write(data){term.write(data)}});
                    process.output.pipeTo(stream);
                    
                    var code      = await process.exit;
                    if(code!=0){
                                                                                console.log('an error occurred');
                    }
                    return code;
                    
              }//server
              
        }//start
        
        
  //:
  
  
        files['package.json']   = `
        
              {
                    "name": "node-test",
                    "version": "1.0.0",
                    "scripts": {
                    }
              }
              
        `;
        
        
        files['rollup.config.js']   = `
        
              import resolve from '@rollup/plugin-node-resolve';
              import commonjs from '@rollup/plugin-commonjs';
              import json from '@rollup/plugin-json';
              import nodePolyfills from 'rollup-plugin-polyfill-node';
              
              export default {
                input     : 'entry.js',
                output    : {
                                  file      : '${filename}',
                                  format    : 'es'
                                  
                                  //format    : 'iife',         // or 'umd'
                                  //name      : 'espree',       // This becomes window.espree
                                  //exports   : 'default',
                                  
                },
                plugins   : [
                                  commonjs(),
                                  json(),
                                  nodePolyfills(),
                                  resolve({preferBuiltins:false})
                            ]
              };
              
        `;
        
        
        files['server.js']    = `
        
              var port          = 3000;
              
              require('http').createServer(request).listen(port);
              
              var fs    = require('fs');
                                                                                          console.log('listening',port);
                                                                                          
              function request(req,res){
                                                                                          console.log(req.method,req.url);
                    if(cors(req,res))return;
                    
                    if(req.url==='/${filename}'){
                          var stream    = fs.createReadStream('${filename}');
                          res.writeHead(200,{'content-type':'text/javascript'});
                          stream.pipe(res);
                          return;
                    }
                    
                    if(req.url==='/test.html'){
                          var stream    = fs.createReadStream('test.html');
                          res.writeHead(200,{'content-type':'text/html'});
                          stream.pipe(res);
                          return;
                    }
                    if(req.url==='/test2.html'){
                          var stream    = fs.createReadStream('test2.html');
                          res.writeHead(200,{'content-type':'text/html'});
                          stream.pipe(res);
                          return;
                    }
                    
                    var stream    = fs.createReadStream('index.html');
                    res.writeHead(200,{'content-type':'text/html'});
                    stream.pipe(res);
                    
              }//request
              
              
              function cors(req,res){
              
                    res.setHeader('access-control-allow-origin','*');
                    
                    if(req.method!=='OPTIONS'){
                          return;
                    }
                    
                    res.writeHead(204);
                    res.end();
                    return true;
                    
              }//cors
              
              
        `;
        
        
})();


</script>



