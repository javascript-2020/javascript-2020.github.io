

<auto-save>

      <template shadowrootmode=open>
      
            <style>
            
  :host
    {font-family:arial;display:inline-flex;align-items:center}
    
  check-box, .menu-root
    {display:flex !important}
    
  .menu
    {display:flex;flex-direction:column;position:absolute;
      left:0;top:35px;width:350px}
      
  .menu [type=checkbox]
    {width:20px;height:20px;margin:0}
    
  .menu-item
    {gap:20px}
    
  .menu-item .menu-label
    {width:120px;text-align:right}
    
    
  input
    {font-size:16px;padding:5px 10px}
  input[type=button]
    {cursor:pointer}
    
    
            </style>
            
            
            <check-box id=autosave></check-box>
            
            <div class=menu-root>
            
                  <img class=menu-icon>
                  
                  <div class=menu style='display:none'>
                  
                        <div class=menu-title>
                              save menu
                        </div>
                        
                        <div class=menu-item>
                              <div class=menu-label>
                                    autosave
                              </div>
                              <input id=timer-chk type=checkbox checked>
                              <input id=timer-value value=300 style='width:60px'>
                        </div>
                        
                        <div id=trim class=menu-item>
                              <div class=menu-label>
                                    trim on save
                              </div>
                              <input type=checkbox checked>
                        </div>
                        
                  </div menu>
                  
            </div menu-root>
            
      </template>
      
      
      <script>
      
      
(function auto_save({mod,dom,host}){

  var obj   = {
        version   : 'v1.0',
  };
  
        var df=true,did='auto-save'
        ;
        
        
        
        var $,menu,save,log,keydown
        ;
        
        obj.initmod   = function(params){
        
              $           = mod.rd(params,'$',$);
              menu        = mod.rd(params,'menu',menu);
              save        = mod.rd(params,'save',save);
              log         = mod.rd(params,'log',log);
              keydown     = mod.rd(params,'keydown',keydown);
              
        }//initmod
        
        
  //:
  
  
        obj.checked         = false;
        
        
        var savemenu;
        
        var timer           = {};
        timer.timer         = null;
        timer.chk           = null;
        timer.time          = null;
        timer.onclick       = null;
        
        
  //:
  
  
        obj.init    = function(){
                                                                                debug('init',obj.version);
                                                                                
              customElements.define('check-box',checkbox);
              
              
        }//init
        
        
  //:
  
  
        obj.initdom   = function(){
                                                                                debug('initdom');
              var shadow    = host.shadowRoot;
              
              menu.add.style(shadow);
              
              autosave                                = $(shadow,'#autosave');
              
              savemenu                                = $(shadow,'.menu');
              $(shadow,'.menu-icon').onclick          = menu.click(savemenu,savemenu_callback);
              menu.input.norm(savemenu);
              
              timer.chk                               = $(savemenu,'#timer-chk');     //':scope>div:nth-of-type(2) [type=checkbox]');
              timer.chk.onclick                       = timer.onclick;
              timer.time                              = $(savemenu,'#timer-value');   //':scope>div:nth-of-type(2) input:not([type])');
              
              
        }//initdom
        
        
  //:
  
  
  
        function savemenu_kd(e){
                                                                                console.log(e.target);
              if(e.target.nodeName=='INPUT'){
                    return;
              }
              return false;
              
        }//savemenu_kd
        
        
        function savemenu_callback(type){
                                                                                console.log('savemenu_callback',arguments);
              if(type=='show'){
                    timer.time.focus();
                    //$(savemenu,':scope>div:nth-of-type(2) input:not([type])').focus();
                    keydown.add(savemenu_kd);
              }
              if(type=='hide'){
                    keydown.rem(savemenu_kd);
              }
              
        }//savemenu_callback
        
        
        timer.onclick   = function(){
                                                                                debug('savetimer.click');
              clearTimeout(timer.timer);
              
              if(timer.chk.checked){
                    var value   = timer.time.value;
                    value       = Number(value);
                    if(isNaN(value)){
                          log.red('invalid autosave time, using 300s');
                          value   = 300;
                    }
                    fn();
              }
              
              
              function fn(){
              
                    if(!autosave.checked){
                          return;
                    }
                                                                                debug('savetimer',value);
                    save();
                    
                    if(timer.chk.checked){
                          var ms    = value*1000;
                          setTimeout(fn,ms);
                    }
                    
              }//fn
              
        }//timer.onclick
        
        
  //:
  
  
        class checkbox extends HTMLElement {
        
              constructor() {
                                                                                //console.log('checkbox-one');
                    super();
                    
                    var root              = this;
                    
                    var template          = $(host,'template#check-box');
                    var shadow            = root.attachShadow({mode:'open'});
                    shadow.appendChild(template.content);
                    
                    var chk         = shadow.querySelector('[type=checkbox]');
                    chk.onchange     = e=>{
                                                                                debug('autosave.chk onchange',chk,checked);
                                              obj.checked    = chk.checked;
                                              timer.onclick();
                                              
                                              if(typeof root.onchange=='function'){
                                                    root.onchange(e);
                                              }
                                              
                                      }//onchange
                                      
                    Object.defineProperty(root,'checked',{get:()=>chk.checked,set:v=>chk.checked=v});
                    
                    if(root.hasAttribute('checked')){
                          chk.checked   = true;
                    }
                    if('checked' in root){
                          chk.checked   = root.checked;
                    }
                    
                    
                    setTimeout(()=>{
                    
                          var str   = root.textContent.trim();
                          if(str==''){
                                root.textContent    = root.id;
                          }
                          
                    },50);
                    
                    
              }//constructor
              
        }//class
        
        
  //:
  
  
        function debug(...args){
        
              if(!df && !obj.df)return;
              args.unshift(`[ ${did} ]`);
              var fmt     = Array.from({length:args.length}).fill('%O').join(' ');
              var args2   = [fmt].concat(args);
              console.groupCollapsed.apply(console,args2);
              console.trace();
              console.groupEnd();
              
        }//debug
        
        
        
  return obj;
  
//auto_save
});


      </script>
      
      
      
      
      
      <template id=check-box>
      
            <style>
            
  :host
    {}
    
  .slider
    {position:relative;display:inline-flex;align-items:center;cursor:pointer;border:1px solid gray;border-radius:3px;height:30px;box-sizing:border-box;padding:0 5px}
  .slider input
    {opacity:0;width:0;height:0}
  .slider .label
    {margin-left:30px}
  .slider .hldr
    {position:absolute;top:4px;left:5px;width:30px;height:20px;background-color:#ccc}
  .slider .hldr:before
    {position:absolute;content:"";height:17px;width:17px;left:2px;bottom:2px;background-color:white;transition:.2s}
  .slider input:checked + .hldr
    {background-color:#2196F3}
  .slider input:checked + .hldr:before
    {transform:translateX(9px)}
  .slider .hldr
    {border-radius:34px}
  .slider .hldr:before
    {border-radius:50%}
    
            </style>
            
            <label id=autosave class=slider>
                  <span class=track></span>
                  <input type=checkbox>
                  <span class=hldr></span>
                  <span class=label>
                        <slot></slot>
                  </span>
            </label>
            
      </template>
      
      
      
      
      
      
      
      
      
</auto-save>


