


<html>

      <head>
      
            <base href='https://javascript-2020.github.io/utils/editors/srcdoc/srcdoc.html'>
            <link rel=icon type='image/png' href='images/srcdoc.png'>
<!--
            <link rel=stylesheet href='/utils/css/utils.css'>
-->

            <script init>
                                                                                console.clear();
                                                                                console.json=v=>console.log(JSON.stringify(v));
        var version       = 'v1.0';
            
        var df            = true;


        var ext;
        var $;
        var datatype;
        var github;


        async function init(){
                                                                                debug('init',version);

              await initdom(document.body);


              init.complete();

              
        }//init


        init.stack            = [];
        init.stack.ct         = 0;
        init.stack.total      = 1;
        init.stack.mode       = '';
        init.stack.complete   = false;
        Object.defineProperty(init.stack,'add',{get:()=>{
              init.stack.total++;
              init.stack.mode && console[init.stack.mode]('add',init.stack.ct,init.stack.total);
        }});
        Object.defineProperty(init.stack,'complete',{get:()=>{
              init.stack.ct++;
              init.stack.mode && console[init.stack.mode]('complete',init.stack.ct,init.stack.total);
              init.stack.ct>=init.stack.total && init();
        }});
        
        //  (typeof init!='undefined' && init?.stack && init.stack.add)
        //  (typeof init!='undefined' && init?.stack && init.stack.complete)

        
        init.complete   = function(){
          
              init.complete.stack.forEach(fn=>fn());
              
        }//complete
        
        init.complete.stack   = [];
        init.complete.add     = fn=>init.complete.stack.push(fn);

                  

(async()=>{
  
        init.stack.add;
        
        var token   = localStorage['github-token'];
        var url;
        var headers;
        if(token){
              url       = 'https://api.github.com/repos/javascript-2020/ext-code/contents/ext-loader.js';
              headers   = {accept:'application/vnd.github.raw',authorization:`bearer ${token}`};
        }else{
              url       = 'https://raw.githubusercontent.com/javascript-2020/ext-code/main/ext-loader.js';
        }
        
        await fetch(url,{headers}).then(res=>res.text()).then(complete);

            
        async function complete(txt){

              ext           = eval(txt);
              var promise   = ext.load.libs(
                    'js/dom/$.js.api',
                    'js/core/datatype.js',
                    'github/github.js'
              );
              [$,datatype,github]   = await promise;

              init.stack.complete;

        }//ext_fn

})();


            </script init>
            
            
            <style>
        
  html
    {height:100%}
  body
    {height:calc(100% - 16px);display:flex;flex-direction:column}
  
  #url-root
    {display:flex;}
  #url
    {flex:1;padding:5px 10px;font-size:16px}
  
  iframe
    {flex:1;border:none}
        
            </style>
            
      </head>
      
      
      <body>
      
            <div id=url-root>
                  <input id=url autocomplete=off spellcheck=false>
                  <input type=button value=go>
            </div>
            
            <iframe></iframe>
      
            <script>
                                                                                debug(version);
        
        var input;
        var iframe;

        
        var btn           = {};


    //:

    
        function initdom(){
                                                                                debug('initdom');
          
              input                         = $('#url');
              
              $('[value=go]').onclick       = btn.go;      
              
              
              iframe                        = $('iframe');
              
              
        }//initdom
        
        
        btn.go    = async function(){
          
              var url   = input.value;
              var url   = github.parse(url);
              
              var err;
              
              try{
                
                    var res   = await fetch(url);
                    
              }//try
              
              catch(err2){
                
                    err   = err2;
                    
              }//catch
              
              if(err){
                    alert(err.toString());
                    return;
              }

      
              var html;        
              if(github.parse.is.api(url)){
                    var json    = await res.json();
                    var b64     = json.content;
                    html        = window.atob(b64);
              }else{
                    html        = await res.text();
              }
              
              iframe.srcdoc    = html;
              
        }//go
                  



/*



        parse.github    = function(url){
        
              url   = window.decodeURIComponent(url);
              if(!url.startsWith('http')){
                    url   = 'https://'+url;
              }
              url   = new URL(url);
              var result;
              if(url.hostname=='javascript-2020.github.io'){
                    result    = parse.github.io(url);
              }
              if(url.hostname=='github.com'){
                    if(url.pathname.indexOf('blob')!=-1){
                          result    = parse.github.file(url);
                    }else 
                    if(url.pathname.indexOf('tree')!=-1){
                          result    = parse.github.dir(url);
                    }else{
                          result    = parse.github.repo(url);
                    }
              }
              var {owner,repo,branch,path}    = result;
              
              var api   = true;
              var url   = parse.github.build(api,null,owner,repo,branch,path);
              
              return url;
              
        }//parse

        parse.github.is   = {};
      
        parse.github.build    = function(api,token,owner,repo,branch,path){

              var url   = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`;
              var headers;
              if(api){
                    if(!token){
                          token     = localStorage.getItem('github-token');
                    }
                    if(token){
                          headers   = {authorization:`Bearer ${token}`};
                    }
                    url             = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;                                
              }                          
              return url;

        }//build
        
        
        
        parse.github.is.api   = function(url){
          
          
              if(url.includes('api.github.com')){
                    return true;
              }
              return false;
              
        }//api
        
        parse.github.is.raw   = function(url){
          
              if(url.includes('raw.githubusercontent.com')){
                    return true;
              }
              return false;
              
        }//raw
        
        
        //  https://javascript-2020.github.io/html-components/log/log.html
        parse.github.io   = function(url){
                                                                  debug('github.io');
              var i         = url.hostname.indexOf('.');
              var owner     = url.hostname.slice(0,i);
              var repo      = url.hostname;
              var branch    = 'main';
              var path      = url.pathname.slice(1);
              return {owner,repo,branch,path};
              
        }//github.io

        
        //  https://github.com/javascript-2020/libs
        parse.github.repo   = function(url){
                                                                  debug('repo');
              var parts     = url.pathname.split('/');
              var owner     = parts.shift();
              var repo      = parts.shift();
              var branch    = 'main';
              var path      = '';
              return {owner,repo,branch,path};
              
        }//repo

        
        //  https://github.com/javascript-2020/libs/blob/main/docker/nodejs-min.dockerfile
        parse.github.file   = function(url){
                                                                  debug('file');
              var parts     = url.pathname.split('/');
              parts.shift();
              var owner     = parts.shift();
              var repo      = parts.shift();
              parts.shift();
              var branch    = parts.shift();
              var path      = parts.join('/');
              return {owner,repo,branch,path};
        
        }//file
        

        //  https://github.com/javascript-2020/libs/tree/main/docker
        parse.github.dir=function(url){
                                                                  debug('dir');
              var parts     = url.pathname.split('/');
              var owner     = parts.shift();
              var repo      = parts.shift();
              parts.shift();
              var branch    = parts.shift();
              var path      = parts.join('/');
              return {owner,repo,branch,path};
              
        }//dir

                  
*/



  //:
  
  
        window.onmessage    = function(e){
          
              var str     = e.data;
              var json    = JSON.parse(str);
              
              switch(json.type){
                
                case 'load'   : onmsg.load(json);       break;
                
              }//switch
              
        }//onmessage
        
        
        onmsg.load    = function(json){
          
              input.value   = json.url;
              
              if(json.auto){
                    btn.go();
              }
              
        }//load
        
        
  //:
  
                  
        function debug(){
          
              if(!df){
                    return;
              }
              var str   = [...arguments].join(' ');
              console.log(`[ srcdoc ]`,str);
              
        }//debug
        
        
        
        
        
        
                  
            </script>
      </body>
      
</html>