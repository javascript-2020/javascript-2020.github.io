

<output-html>

      <template shadowrootmode=open>
      
            <style>
            
  :host
    {display:flex;flex-direction:column;height:100%}
    
  #hdr
    {display:flex}
    
  .radio
    {border:1px solid lightgray;padding:2px 10px;border-radius:5px;cursor:pointer;display:flex;align-items:center}
    
  #hldr
    {flex:1;box-sizing:border-box;position:relative}
  iframe
    {width:100%;height:100%}
  #glass
    {position:absolute;left:0;top:0;width:100%;height:100%;display:none}
    
            </style>
            
            <div id=hdr>
                  <span id=allow-scripts class=radio>
                        <input type=checkbox checked>
                        allow-scripts
                  </span>
                  <span id=allow-modals class=radio>
                        <input type=checkbox checked>
                        allow-modals
                  </span>
                  <span id=allow-popups class=radio>
                        <input type=checkbox checked>
                        allow-popups
                  </span>
                  
                  <div style='flex:1'></div>
                  
                  <span id=console-show class=radio>
                        <input type=checkbox checked>
                        console
                  </span>
                  <span id=console-echo class=radio>
                        <input type=checkbox checked>
                        echo
                  </span>
                  <span id=console-persist class=radio>
                        <input type=checkbox>
                        persist
                  </span>
                  <span id=console-clear class=radio>
                        clear
                  </span>
                  
                  <button id=kill style='margin-right:20px'>kill</button>
            </div>
            
            
            <!--
            https://sandbox-ext-code-com-1024713184986.us-central1.run.app/html-sandbox/html-sandbox.html
            https://ext-code-test.com/html-sandbox/html-sandbox.html
            -->
            <div id=hldr>
                  <iframe src='https://sandbox-ext-code-com-1024713184986.us-central1.run.app/html-sandbox/html-sandbox.html'
                          sandbox='allow-scripts allow-same-origin allow-forms allow-downloads allow-pointer-lock allow-popups-to-escape-sandbox'
                          allow='clipboard-write; clipboard-read; camera; microphone; geolocation; accelerometer; gyroscope; magnetometer; payment; usb; serial; bluetooth;
                                  xr-spatial-tracking; autoplay; encrypted-media; picture-in-picture; screen-wake-lock; web-share'
                  ></iframe>
                  <div id=glass></div>
            </div>
            
            <web-console component h=150></web-console>
            
      </template>
      
      <script>
      
(function output_html({mod,dom,host}){

  var obj   = {
        version   : 'v2.0',
  };
        var df=false,did='output-html'
        ;
        
        
        
        var ext,$
        ;
        
        obj.initmod=function(params){
        
              ext   = mod.rd(params,'ext',ext);
              $     = mod.rd(params,'$',$);
              
        }//initmod
        
        
  //vars:-
  
  
        var webconsole;
        
        
        var chk   = {};
        
        var hldr;
        var iframe;
        var def_sandbox;
        var glass;
        
        
        var btn   = {};
        obj.on    = {};
        
        
  //:
  
  
        obj.init    = async function(){
        
              await mod.auto();
              
              webconsole    = mod['web-console'];
              
              
        }//init
        
        
  //:
  
  
        obj.initdom   = function(rootnode){
        
              shadow                                    = host.shadowRoot;
              
              var style                                 = $(shadow,'style');
              $.stylesheet.insert(style,'button','.icon');
              
              
              var hdr                                   = $(shadow,'#hdr');
              
              chk['allow-scripts']                      = $.chkbox(hdr,'#allow-scripts');
              chk['allow-modals']                       = $.chkbox(hdr,'#allow-modals');
              chk['allow-popups']                       = $.chkbox(hdr,'#allow-popups');
              
              chk['console-show']                       = $.chkbox(hdr,'#console-show',btn.show_console);
              chk['console-echo']                       = $.chkbox(hdr,'#console-echo');
              chk['console-persist']                    = $.chkbox(hdr,'#console-persist');
              $(shadow,'#console-clear').onclick        = btn.clear_console;
              
              $(hdr,'#kill').onclick                    = btn.kill;
              
              
              hldr                                      = $(shadow,'#hldr');
              iframe                                    = $(shadow,'iframe');
              def_sandbox                               = iframe.getAttribute('sandbox');
              glass                                     = $(shadow,'#glass');
              
              
        }//initdom
        
        
  //:
  
  
        btn.kill    = function(){
        
              kill();
              
        }//kill
        
        
        btn.show_console    = function(chk){
        
              if(chk.checked){
                    webconsole.host.style.display   = '';
              }else{
                    webconsole.host.style.display   = 'none';
              }
              
        }//show_console
        
        
        btn.clear_console   = function(){
        
              webconsole.clear();
              if(chk['console-echo'].checked){
                    console.clear();
              }
              
        }//clear_console
        
        
        obj.glass   = function(show=true){
        
              var display     = 'none';
              if(show){
                    display   = 'block';
              }
              glass.style.display    = display;
              
        }//glass
        
        
        obj.horiz   = function(){
        
              host.style.width     = '100%';
              host.style.height    = '50%';
              
        }//horiz
        
        
        obj.vert    = function(){
        
              host.style.width    = '50%';
              host.style.height   = '100%';
              
        }//vert
        
        
        
        build.sandbox   = function(){
        
              var attr      = def_sandbox;
                                                                                console.log(attr);
              var tokens    = new Set(attr.split(/\s+/).filter(Boolean));
              
              if(!chk['allow-scripts'].checked){
                    tokens.delete('allow-scripts');
              }
              if(chk['allow-modals'].checked){
                    tokens.add('allow-modals');
              }
              if(chk['allow-popups'].checked){
                    tokens.add('allow-popups');
              }
              
              var attr      = [...tokens].join(' ');
                                                                                console.log(attr);
              iframe.setAttribute('sandbox',attr);
              
        }//sandbox
        
        
        obj.srcdoc    = function(html){
        
              iframe.remove();
              iframe    = iframe.cloneNode();
              
              build.sandbox();
              
              hldr.append(iframe);
              
              
              if(!chk['console-persist'].checked){
                    webconsole.clear();
                    if(chk['console-echo'].checked){
                          console.clear();
                    }
              }
              
              iframe.srcdoc   = html;
              
        }//srcdoc
        
        
        obj.sandbox   = function(html){
                                                                                debug('sandbox');
              iframe.remove();
              iframe    = iframe.cloneNode();
              
              build.sandbox();
              iframe.onload   = onload;
              hldr.append(iframe);
              
              function onload(){
                                                                                console.log('onload');
                    if(!chk['console-persist'].checked){
                          webconsole.clear();
                          if(chk['console-echo'].checked){
                                console.clear();
                          }
                    }
                    
                    var echo    = chk['console-echo'].checked;
                    iframe.contentWindow.postMessage({type:'run',html,echo},'*');
                    
              }//onload
              
        }//sandbox
        
        
        obj.kill    = function(){return kill()}    //d
        
        function kill(){
        
              var niframe       = iframe.cloneNode(true);
              niframe.srcdoc    = null;
              hldr.replaceChild(niframe,iframe);
              iframe            = niframe;
              
        }//kill
        
        
  //:
  
  
        obj.on.message    = function(json){
                                                                                console.log('output.message',json);
              var {name,args}   = json;
              webconsole[name].apply(null,args);
              
        }//message
        
        
  //:
  
  
        function debug(...args){
        
              if(!df && !obj.df)return;
              args.unshift(`[ ${did} ]`);
              var fmt     = Array.from({length:args.length}).fill('%O').join(' ');
              var args2   = [fmt].concat(args);
              console.groupCollapsed.apply(console,args2);
              console.trace();
              console.groupEnd();
              
        }//debug
        
        
        
        
  return obj;
  
})//output_html

      </script>
      
</output-html>

