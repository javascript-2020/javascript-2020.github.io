

<output-console v2.0>

      <template shadowrootmode=open>
      
            <style>
            
  :host
    {font-family:arial}
    
  #root
    {height:100%;display:flex;flex-direction:column}
  #hdr
    {display:flex;align-items:center;margin:0;margin-bottom:5px}
  #spc
    {flex:1}
  .radio
    {border:1px solid lightgray;padding:2px 10px;border-radius:5px;cursor:pointer;display:flex;align-items:center}
    
  #isolate
    {margin-right:10px}
  #console-clear
    {margin-right:10px}
  #word-wrap
    {margin-right:20px;/*color:gray*/}
    
  #output-type
    {display:flex}
    
  #iframe-show
    {margin-right:20px}
    
  #kill
    {font-size:16px;padding:5px 10px;min-width:60px}
    
  #output-hldr
    {flex:1;position:relative}
  #output
    {width:100%;height:100%;position:absolute;left:0;top:0;
      overflow:auto;border:2px solid lightgray;box-sizing:border-box;
      padding:10px;margin:0;
      word-break:break-all;
      font-size:16px;line-height:1.5;
    }
  #output-console
    {width:100%;height:100%;position:absolute;left:0;top:0}
    
            </style>
            
            <div id=root>
                  <div id=hdr>
                  
                        <span id=isolate class=radio>
                              <input type=checkbox>
                              isolate
                        </span>
                        
                        <span id=allow-modals class=radio>
                              <input type=checkbox checked>
                              allow-modals
                        </span>
                        <span id=allow-popups class=radio style='margin-right:30px'>
                              <input type=checkbox checked>
                              allow-popups
                        </span>
                        
                        <div style='flex:1'></div>
                        
                        <span id=output-type>
                              <span id=pretty-print class=radio>
                                    <input type=checkbox checked>
                                    prettyPrint
                              </span>
                              <span id=console class=radio>
                                    <input type=checkbox>
                                    console
                              </span>
                        </span>
                        
                        <span id=console-echo class=radio>
                              <input type=checkbox checked>
                              echo
                        </span>
                        <span id=console-persist class=radio>
                              <input type=checkbox>
                              persist
                        </span>
                        <span id=console-clear class=radio>
                              clear
                        </span>
                        
                        <span id=word-wrap class=radio>
                              <input type=checkbox checked>
                              wrap
                        </span>
                        
                        <span id=iframe-show class=radio>
                              <input type=checkbox checked>
                              iframe
                        </span>
                        
                        <button id=kill>kill</button>
                        
                  </div>
                  
                  <div id=output-hldr>
                        <pre id=output>
                        </pre>
                        <div id=output-console style='display:none'>
                        </div>
                  </div>
                  
            </div>
            
      </template>
      
      <script>
      
(function output_console({mod,host}){

  var obj   = {
        version   : 'v2.0',
  };
  
        var df=true,did='output-console'
        ;
        
        
        
        var ext,$
        ;
        
        obj.initmod   = function(params){
        
              ext   = params.ext;
              $     = params.$;
              
        }//initmod
        
        
  //vars:-
  
        var inspect;
        var jsconsole;
        var style;
        
        var con             = {};
        con.log             = console.log;
        con.clear           = console.clear;
        con.error           = console.error;
        
        
        var root;
        var shadow;
        
        var output;
        var cur             = {};
        
        var iframe;
        obj.iframe;
        var sandbox_url     = 'https://sandbox.ext-code.com/js-sandbox/js-sandbox.html';
        var sandbox_def     = 'allow-scripts allow-same-origin allow-forms allow-downloads allow-pointer-lock';
        var sandbox_allow   = `clipboard-write; clipboard-read; camera; microphone; geolocation; accelerometer; gyroscope; magnetometer; payment; usb; serial; bluetooth;
                                  xr-spatial-tracking; autoplay; encrypted-media; picture-in-picture; screen-wake-lock; web-share`;
                                  
        var fn              = {};
        var chk             = {};
        var btn             = {};
        btn.console         = {};
        btn.iframe          = {};
        obj.on              = {};
        
        
  //:
  
  
        obj.init    = async function(){
                                                                                debug('init',obj.version);
              await libs();
              
        }//init
        
        
        async function libs(){
        
              var list      = [];
              
              var promise   = ext.load.libs('js/string/inspect.js').then(result=>{
              
                   [inspect]    = result;
                   
              });
              list.push(promise);
              
              var promise   = ext.load.libs('js/dom/web-console/web-console.js').then(result=>{
              
                    [jsconsole]   = result;
                    jsconsole.initmod({ace});
                    jsconsole.init();
                    
              });
              list.push(promise);
              
              var promise   = ext.text.libs('js/dom/web-console/web-console.css').then(result=>{
              
                    var [css]           = result;
                    style               = document.createElement('style');
                    style.textContent   = css;
                    
                    
              });
              list.push(promise);
              
              
              await Promise.all(list);
                                                                                //console.log(inspect);
                                                                                
        }//libs
        
        
  //:
  
  
        obj.initdom   = function(rootnode){
                                                                                debug('initdom');
              shadow                                    = host.shadowRoot;
              
              root                                      = $(shadow,'#root');
              
              chk.isolate                               = $.chkbox(shadow,'#isolate');
              chk.isolate.checked                       = window.crossOriginIsolated;
              
              chk['allow-modals']                       = $.chkbox(shadow,'#allow-modals');
              chk['allow-popups']                       = $.chkbox(shadow,'#allow-popups');
              
              var r                                     = $(shadow,'#output-type');
              chk.type                                  = $.chkbox.group(r,'#pretty-print','#console');
              chk.type.callback                         = btn.type;
              /*
              chk.pretty                                = $.chkbox(shadow,'#pretty-print');
              chk.console                               = $.chkbox(shadow,'#console');
              */
              
              chk['console-echo']                       = $.chkbox(shadow,'#console-echo');
              chk['console-persist']                    = $.chkbox(shadow,'#console-persist',false);
              $(shadow,'#console-clear').onclick        = btn.console.clear;
              
              chk.wrap                                  = $.chkbox(shadow,'#word-wrap',btn.wrap);
              
              chk.iframe                                = $.chkbox(shadow,'#iframe-show',btn.iframe.show);
              
              $(shadow,'#kill').onclick                 = btn.kill;
              
              
              output                                    = $(shadow,'#output');
              cur.root                                  = output;
              
              shadow.append(style);
              
              create.iframe();
              
              
        }//initdom
        
        
  //:
  
  
/*
        btn.isolate   = function(chk){
        
              if(chk.checked){
                    sandbox_url  += '?isolate';
              }else{
                    var i         = ssandbox_url.indexOf('?');
                    sandbox_url   = sandbox_url.slice(0,i);
              }
              
        }//isolate
*/


        btn.type    = function(chk,id){
        
              console.log(arguments);
              console.log(id);
              
              switch(id){
              
                case 'console'        : break;
                case 'pretty-print'   : break;
                
              }//switch
        }//type
        
        
        btn.console.clear   = function(){
                                                                                debug('btn.clear');
              clear();
              
        }//clear
        
        
        btn.wrap    = function(chk){
                                                                      //console.log('wrap',v);
              if(chk.checked){
                    output.style.whiteSpace   = 'pre-wrap';
              }else{
                    output.style.whiteSpace   = '';
              }
              
        }//wrap
        
        
        btn.kill    = function(){
                                                                                debug('btn.kill');
              kill();
              
        }//kill
        
        
        btn.iframe.show   = function(chk){
                                                                                debug('btn.iframe.show');
              if(!iframe)return;
              
              if(chk.checked){
                    iframe.style.display    = '';
              }else{
                    iframe.style.display    = 'none';
              }
              
        }//show
        
        
  //:
  
  
        obj.on.message    = function(json){
                                                                                //console.log('output.message',json);
              var {name,args}   = json;
              //webconsole[name].apply(null,args);
              fn[name].apply(null,args);
              
        }//message
        
        
  //:
  
  
        obj.run   = async function(js,params={}){
                                                                                debug('run');
              var sandbox   = (()=>{
              
                    var console                 = {};
                    console.log                 = log;
                    console.clear               = clear;
                    console.error               = error;
                    console.write               = write;
                    
                    console.group               = window.console.group.bind(window.console);
                    console.groupCollapsed      = window.console.groupCollapsed.bind(window.console);
                    console.groupEnd            = window.console.groupEnd.bind(window.console);
                    console.trace               = window.console.trace.bind(window.console);
                    console.info                = window.console.info.bind(window.console);
                    
                    
                    async function run(js){
                    
                          if(!chk.persist){
                                clear();
                          }
                          
                          if(params.async){
                                js      = '(async()=>{\n'+js+'\n})()';
                          }
                          
                          var result    = await eval(js);
                          return result;
                          
                    }//run
                    
                    
                    run.kill    = function(){
                    }//kill
                    
                    
                    return run;
                    
              })();
              
              var result    = await sandbox(js);
              
              if(result){
                    console.log(result);
              }
              
              //console.log     = con.log;
              //console.clear   = con.clear;
              //console.error   = con.error;
              
              
              
        }//run
        
        
        build.sandbox   = function(){
        
              var attr      = sandbox_def;
                                                                                //console.log(attr);
              var tokens    = new Set(attr.split(/\s+/).filter(Boolean));
              /*
              if(!chk['allow-scripts'].checked){
                    tokens.delete('allow-scripts');
              }
              */
              if(chk['allow-modals'].checked){
                    tokens.add('allow-modals');
              }
              if(chk['allow-popups'].checked){
                    tokens.add('allow-popups');
              }
              
              var attr      = [...tokens].join(' ');
                                                                                debug(attr);
              iframe.setAttribute('sandbox',attr);
              
        }//sandbox
        
        
        create.iframe   = function({onload}={}){
        
              iframe            = document.createElement('iframe');
              obj.iframe        = iframe;
              
              iframe.onload           = onload;
              
              build.sandbox();
              
              iframe.setAttribute('allow',sandbox_allow);
                                                                                debug(sandbox_allow);
              var src              = sandbox_url;
              if(chk.isolate.checked){
                    src  += '?isolate';
              }
              iframe.src    = src;
                                                                                debug(src);
              iframe.style.cssText    = 'box-sizing:border-box';
              if(!chk.iframe.checked){
                    iframe.style.display    = 'none';
              }
              
              root.append(iframe);
              //document.body.append(iframe)
              //cur.root.append(iframe);
              
        }//iframe
        
        
        obj.run.iframe2    = async function(js,params={}){
                                                                                debug('run.iframe2');
              var resolve,promise=new Promise(res=>resolve=res);
              
              if(iframe){
                    iframe.remove();
              }
              
              create.iframe({onload});
              
              return promise;
              
              
              async function onload(){
              
                    iframe.onload   = null;
                    iframe.contentWindow.focus();
                    
                    if(!chk['console-persist'].checked){
                          clear();
                    }
                    
                    var echo    = chk['console-echo'].checked;
                    
                    if(params.async){
                          js      = '(async()=>{\n'+js+'\n})()';
                    }
                    
                    iframe.contentWindow.postMessage({type:'run',js,echo},'*');
                    //var result    = await win.eval(js);
                    
                    
                    resolve();
                    
                    
              }//onload
              
        }//iframe
        
        
        obj.kill    = function(){return kill()}
        
        function kill(){
        
              if(!iframe)return;
              iframe.remove();
              
        }//kill
        
        
        
        obj.set   = function(root){
        
              if(root){
                    cur.root    = root;
              }else{
                    cur.root    = output;
              }
              
        }//set
        
        
  //:
  
  
        function disp(){
        
              var txt           = build(arguments);
              var div           = document.createElement('div');
              div.textContent   = txt;
              cur.root.append(div);
              
              cur.node    = div;
              
              if(txt==''){
                    div.style.height    = '16px';
              }
              
              cur.root.scrollTop    = 999999999;
              
              return div;
              
        }//disp
        
        
        obj.clear   = function(){return clear()}
        fn.clear    = function(){return clear.apply(null,arguments)}
        
        function clear(){
        
        /*
              if(chk['console-echo'].checked){
                    con.clear.call(window.console);
              }
        */
        
              cur.root.replaceChildren();
              
        }//clear
        
        
        obj.log   = function(){return log.apply(null,arguments)}
        fn.log    = function(){return log.apply(null,arguments)}
        
        function log(){
        
              /*
              if(chk['console-echo'].checked){
                    //con.log.apply(window.console,arguments);
                    window.console.groupCollapsed.apply(window.console,arguments);
                    window.console.trace();
                    window.console.groupEnd();
              }
              */
              
              var div   = disp.apply(null,arguments);
              return div;
              
/*
              var txt           = build(arguments);
              var div           = document.createElement('div');
              div.textContent   = txt;
              cur.root.append(div);
              
              cur.node    = div;
              
              if(txt==''){
                    div.style.height    = '16px';
              }
              
              cur.root.scrollTop    = 999999999;
*/

              return div;
              
        }//log
        
        
        obj.groupCollapsed    = function(){return groupCollapsed.apply(null,arguments)}
        fn.groupCollapsed     = function(){return groupCollapsed.apply(null,arguments)}
        
        function groupCollapsed(...args){
        
              /*
              if(chk['console-echo'].checked){
                    window.console.groupCollapsed.apply(window.console,args);
              }
              */
              
              var out   = format(arguments);
              var div   = disp.apply(null,out);
              return div;
              
        }//groupCollapsed
        
        
        obj.error   = function(){return error.apply(null,arguments)}
        fn.error    = function(){return error.apply(null,arguments)}
        
        function error(){
        
              /*
              if(chk['console-echo'].checked){
                    con.error.apply(window.console,arguments);
              }
              */
              
              var node            = log.apply(null,arguments);
              node.style.color    = 'red';
              return node;
              
        }//error
        
        
        
        
        obj.node    = function(){return node.apply(null,arguments)}
        fn.node     = function(){return node.apply(null,arguments)}
        
        function node(node){
        
              node    = create(node);
              
              cur.root.append(node);
              
              return node;
              
        }//node
        
        
        
        obj.write    = function(){return write.apply(null,arguments)}
        fn.write    = function(){return write.apply(null,arguments)}
        
        function write(){
        
              var txt   = build(arguments);
              
              var span            = document.createElement('span');
              span.textContent    = txt;
              
              if(cur.node){
                    cur.node.append(span);
              }else{
                    cur.root.append(span);
              }
              return span;
              
        }//write
        
        
        
        
  //:
  
  
        function datatype(v){return Object.prototype.toString.call(v).slice(8,-1).toLowerCase()}
        
        
        function format(args){
        
              if(typeof args[0]!=='string')return args;
              
              let fmt         = args[0];
              let out         = [];
              let argIndex    = 1;
              
              out.push(fmt.replace(/%[sdifoO]/g,match=>{
              
                    var val   = args[argIndex++];
                    
                    switch (match) {
                    
                      case '%s'   : return ''+val;
                      case '%d'   :
                      case '%i'   : return parseInt(val, 10);
                      case '%f'   : return parseFloat(val);
                      case '%o'   :
                      case '%O'   : return format.fn(val);
                      default     : return match;
                      
                    }//switch
                    
              }));
              
              
              while(argIndex<args.length){
              
                    var v   = args[argIndex++];
                    out.push(v);
                    
              }//while
              
              return out;
              
              
              function fn(val){
              
                    if(val===null)return 'null';
                    if(val===undefined)return 'undefined';
                    
                    switch(typeof val){
                    
                      case 'number'   : return val;
                      case 'string'   : return val;
                      
                    }//switch
                    
                    return JSON.stringify(val,null,4);
              }//fn
              
        }//format
        
        
        format.fn   = function(val,seen=new WeakSet()){
        
              if(val === null)return 'null';
              if(val === undefined)return 'undefined';
              
                                                                                  // Prevent circular references
              if(typeof val==='object' || typeof val==='function'){
                    if(seen.has(val))return '[ Circular ]';
                    seen.add(val);
              }
              
                                                                                  // Primitive types
              switch(typeof val){
              
                case 'number'     : return String(val);
                case 'string'     : return val;
                case 'boolean'    : return String(val);
                case 'bigint'     : return val.toString() + 'n';
                case 'symbol'     : return val.toString();
                case 'function'   : return `[Function${val.name ? ': '+val.name : ''}]`;
                
              }//switch
              
              
              var type    = datatype(val);
                                                                                console.log('format.fn',type);
              if(type=='array'){
                    val       = val.map(v=>format.fn(v,seen));
                    var str   = val.join(', ')
                    return '['+str+']';
              }
              
              if(type=='date'){//val instanceof Date){
                    return `Date("${val.toISOString()}")`;
              }
              
              if(val instanceof RegExp){
                    return val.toString();
              }
              
              if(val instanceof Error){
                    return `${val.name}: ${val.message}`;
              }
              
              if(val instanceof Map){
                    const entries = [];
                    for (const [k, v] of val.entries()) {
                      entries.push(`${fn(k, seen)} => ${format.fn(v, seen)}`);
                    }
                    return `Map { ${entries.join(', ')} }`;
              }
              
              if(val instanceof Set){
                    const entries   = [...val].map(v=>format.fn(v,seen));
                    return `Set { ${entries.join(', ')} }`;
              }
              
              if(ArrayBuffer.isView(val) && !(val instanceof DataView)){
                    return `${val.constructor.name} [ ${Array.from(val).join(', ')} ]`;
              }
              
              if(val instanceof Node){
                    if(val.nodeType===1){
                          return `<${val.tagName.toLowerCase()}>`;
                    }
                    return val.toString();
              }
              
              if(typeof val==='object'){
                    const entries   = Object.entries(val).map(([k,v])=>{
                    
                          return `${k}: ${format.fn(v,seen)}`;
                          
                    });
                    return `{ ${entries.join(', ')} }`;
              }
              
              try{
              
                    return JSON.stringify(val);
                    
              }//try
              catch{
              
                    return String(val);
                    
              }//catch
              
        }//fn
        
        
        
        function build(args){
        
              var str     = '';
              var args    = [...args];
              args        = args.map(v=>{
              
                    var type    = datatype(v);
                    switch(type){
                    
                      case 'function'         :
                      case 'asyncfunction'    : str   = v.toString();       break;
                      case 'string'           : str   = v;                  break;
                      default                 : str   = inspect(v);         break;
                      
                    }//switch
                    return str;
                    
              });
              
              var txt   = args.join(' ');
              return txt;
              
        }//build
        
        
        function create(node){
        
              var type    = datatype(node);
              switch(type){
              
                case 'string'   : node    = create.string(node);        break;
                
              }//switch
              return node;
              
        }//create
        
        
        create.string   = function(str){
        
              var node    = document.createElement(str);
              return node;
              
        }//string
        
        
  //:
  
  
        obj.horiz   = function(){
        
              host.style.width    = '100%';
              host.style.height   = '50%';
              
        }//horiz
        
        
        obj.vert    = function(){
        
              host.style.width    = '50%';
              host.style.height   = '100%';
              
        }//vert
        
        
  //:
  
  
  
        function debug(...args){
        
              if(!df && !obj.df)return;
              args.unshift(`[ ${did} ]`);
              var fmt     = Array.from({length:args.length}).fill('%O').join(' ');
              var args2   = [fmt].concat(args);
              console.groupCollapsed.apply(console,args2);
              console.trace();
              console.groupEnd();
              
        }//debug
        
        
        
        
        
  return obj;
  
//output_console
})


      </script>
      
      
</output-console>



