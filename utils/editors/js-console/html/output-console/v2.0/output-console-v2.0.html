

<output-console v2.0>

      <template shadowrootmode=open>
      
            <style>
            
  :host
    {font-family:arial}
    
  #root
    {height:100%;display:flex;flex-direction:column}
  #hdr
    {display:flex;align-items:center;margin:0;margin-bottom:5px}
    
  #spc
    {flex:1}
    
  .ext-button
    {border:1px solid lightgray;padding:2px 5px;cursor:pointer;display:flex;align-items:center;margin-right:10px}
  .ext-button [type=checkbox]
    {margin:0;margin-left:5px;cursor:pointer}
    
  button
    {font-size:16px;margin-right:10px}
    
  #output
    {flex:1;
      overflow:auto;border:2px solid lightgray;box-sizing:border-box;
      padding:10px;margin:0;
      word-break:break-all;
      font-size:16px;line-height:1.5;
    }
    
            </style>
            
            <div id=root>
                  <div id=hdr>
                        <span id=spc></span>
                        <div id=console-persist class=ext-button>console.persist<input type=checkbox></div>
                        <div id=console-log class=ext-button>console.log<input type=checkbox checked></div>
                        <div id=word-wrap class=ext-button>wrap<input type=checkbox checked></div>
                        <button id=clear>clear</button>
                        <button id=kill>kill</button>
                  </div>
                  
                  <pre id=output>
                  </pre>
            </div>
            
      </template>
      
      <script>
      
(function output_console({mod,dom,host}){
                                                                                //console.log('output');
  var obj   = {
        version   : 'v2.0',
  };
  
  
      var ext,$
      ;
      
      obj.initmod   = function(params){
      
            ext   = params.ext;
            $     = params.$;
            
      }//initmod
      
      
  //vars:-
  
      var inspect;
      
      var con             = {};
      con.log             = console.log;
      con.clear           = console.clear;
      con.error           = console.error;
      
      
      var root;
      var shadow;
      
      var output;
      var cur             = {};
      
      var iframe;
      obj.iframe;
      
      
      
      var chk             = {};
      var btn             = {};
      
      
  //:
  
  
      obj.init    = async function(){
      
            await libs();
            
      }//init
      
      
      async function libs(){
      
            [inspect]   = await ext.load.libs('js/string/inspect.js');
            console.log(inspect);
            
      }//libs
      
      
  //:
  
  
      obj.initdom   = function(rootnode){
      
            shadow                          = host.shadowRoot;
            
            chk.persist                     = $.chkbox(shadow,'#console-persist',false);
            chk.log                         = $.chkbox(shadow,'#console-log',false);
            chk.wrap                        = $.chkbox(shadow,'#word-wrap',wrap);
            
            $(shadow,'#clear').onclick      = btn.clear;
            $(shadow,'#kill').onclick       = btn.kill;
            
            
            output                          = $(shadow,'#output');
            cur.root                        = output;
            
            
            wrap(chk.wrap.checked);
            
            
      }//initdom
      
      
      btn.kill    = function(){
      
            kill();
            
      }//kill
      
      
      btn.clear   = function(){
      
            clear();
            
      }//clear
      
      
      function wrap(chk){
                                                                    //console.log('wrap',v);
            if(chk.checked){
                  output.style.whiteSpace   = 'pre-wrap';
            }else{
                  output.style.whiteSpace   = '';
            }
            
      }//wrap
      
      
      obj.run   = async function(js,params={}){
                                                                    console.log('run');
            var sandbox   = (()=>{
            
                  var console                 = {};
                  console.log                 = log;
                  console.clear               = clear;
                  console.error               = error;
                  console.write               = write;
                  
                  console.group               = window.console.group.bind(window.console);
                  console.groupCollapsed      = window.console.groupCollapsed.bind(window.console);
                  console.groupEnd            = window.console.groupEnd.bind(window.console);
                  console.trace               = window.console.trace.bind(window.console);
                  console.info                = window.console.info.bind(window.console);
                  
                  
                  async function run(js){
                  
                        if(!chk.persist){
                              clear();
                        }
                        
                        if(params.async){
                              js      = '(async()=>{\n'+js+'\n})()';
                        }
                        
                        var result    = await eval(js);
                        return result;
                        
                  }//run
                  
                  
                  run.kill    = function(){
                  }//kill
                  
                  
                  return run;
                  
            })();
            
            var result    = await sandbox(js);
            
            if(result){
                  console.log(result);
            }
            
            //console.log     = con.log;
            //console.clear   = con.clear;
            //console.error   = con.error;
            
            
            
      }//run
      
      
      obj.run.iframe    = async function(js,params={}){
                                                                    console.log('run.iframe');
            var resolve,promise=new Promise(res=>resolve=res);
            
            if(iframe){
                  iframe.remove();
            }
            
            iframe          = document.createElement('iframe');
            obj.iframe      = iframe;
            iframe.srcdoc   = '';
            iframe.onload   = onload;
            cur.root.append(iframe);
            
            return promise;
            
            
            async function onload(){
            
                  setTimeout(complete,100);
                  
            }//onload
            
            async function complete(){
            
                  var win             = iframe.contentWindow;
                  win.focus();
                  win.console.log     = log;
                  win.console.clear   = clear;
                  win.console.error   = error;
                  win.console.write   = write;
                  
                  if(!chk.persist){
                        clear();
                  }
                  
                  if(params.async){
                        js      = '(async()=>{\n'+js+'\n})()';
                  }
                  
                  var result    = await win.eval(js);
                  resolve(result);
                  
                  //iframe.remove();
                  
            }//onload
            
      }//iframe
      
      
      obj.run.iframe2    = async function(js,params={}){
                                                                    console.log('run.iframe2');
            var resolve,promise=new Promise(res=>resolve=res);
            
            if(iframe){
                  iframe.remove();
            }
            
            if(params.async){
                  js      = '(async()=>{\n'+js+'\n})()';
            }
            
            
            
/*
            var html        = `
                  <script>
                  
                        window.addEventListener('message',({data})=>{
                        console.log('message',data);
                              var {js}    = data;
                        console.log(js);
                              window.eval(js);
                              
                        });
                        
                  </scr`+`ipt>
            `;
            
            
var html    = `

<script type="module">
  window.addEventListener("message", async (event) => {
      try {
        // Wrap the code in a module so dynamic import works
        const blob = new Blob([event.data.js], { type: "text/javascript" });
        const url = URL.createObjectURL(blob);
        await import(url);
        URL.revokeObjectURL(url);
      } catch (e) {
        console.error("Module error:", e);
      }
  });
</scr`+`ipt>


`;


*/


              var html    = `
              
                    <script>
                    
                          ${js}
                          
                    </scr`+`ipt>
              `;
              
              
              var html    = `
              
                    <script>
                          window.addEventListener('message',({data})=>{
                          console.log('message',data);
                                var {type}    = data;
                                if(type==='run'){
                                      run();
                                }
                                
                          });
                          
                    </scr`+`ipt>
                    
                    <script type=module>
                    
                    window.run=function(){
                    
                          ${js}
                          
                    }//run
                    
                    </scr`+`ipt>
              `;
              
              
              
              
              
            iframe            = document.createElement('iframe');
            obj.iframe        = iframe;
            iframe.style.display    = 'none';
            iframe.sandbox    = 'allow-scripts allow-same-origin';
            var blob          = new Blob([html],{type:'text/html'});
            var url           = window.URL.createObjectURL(blob);
            iframe.src        = url;
            iframe.onload     = onload;
            cur.root.append(iframe);
            
            return promise;
            
            
            async function onload(){
            
                  //setTimeout(complete,100);
                  
            //}//onload
            
            
            //async function complete(){
            
                  var win             = iframe.contentWindow;
                  
                  win.focus();
                  win.console.log     = log;
                  win.console.clear   = clear;
                  win.console.error   = error;
                  win.console.write   = write;
                  
                  if(!chk.persist){
                        clear();
                  }
                  
                  iframe.contentWindow.postMessage({type:'run'});
                  
                  //var result    = await win.eval(js);
                  //resolve(result);
                  
                  //iframe.remove();
                  
            }//onload
            
      }//iframe
      
      
      obj.kill    = function(){return kill()}
      
      function kill(){
      
            if(!iframe)return;
            iframe.remove();
            
      }//kill
      
      
      
      obj.set   = function(root){
      
            if(root){
                  cur.root    = root;
            }else{
                  cur.root    = output;
            }
            
      }//set
      
      
  //:
  
  
  
      obj.clear   = function(){return clear()}
      
      function clear(){
      
            if(chk.log.checked){
                  con.clear.call(window.console);
            }
            
            cur.root.replaceChildren();
            
      }//clear
      
      
      obj.log   = function(){return log.apply(log,arguments)};
      
      function log(){
      
            if(chk.log.checked){
                  //con.log.apply(window.console,arguments);
                  window.console.groupCollapsed.apply(window.console,arguments);
                  window.console.trace();
                  window.console.groupEnd();
            }
            
            var txt           = build(arguments);
            var div           = document.createElement('div');
            div.textContent   = txt;
            cur.root.append(div);
            
            cur.node    = div;
            
            if(txt==''){
                  div.style.height    = '16px';
            }
            
            cur.root.scrollTop    = 999999999;
            
            return div;
            
      }//log
      
      
      obj.error   = function(){return error.apply(null,arguments)}
      
      function error(){
      
            if(chk.log.checked){
                  con.error.apply(window.console,arguments);
            }
            var node            = log.apply(null,arguments);
            node.style.color    = 'red';
            return node;
            
      }//error
      
      
      
      
      obj.node    = function(){return node.apply(null,arguments)}
      
      function node(node){
      
            node    = create(node);
            
            cur.root.append(node);
            
            return node;
            
      }//node
      
      
      
      obj.write    = function(){return write.apply(null,arguments)}
      
      function write(){
      
            var txt   = build(arguments);
            
            var span            = document.createElement('span');
            span.textContent    = txt;
            
            if(cur.node){
                  cur.node.append(span);
            }else{
                  cur.root.append(span);
            }
            return span;
            
      }//write
      
      
  //:
  
  
      function build(args){
      
            var str     = '';
            var args    = [...args];
            args        = args.map(v=>{
            
                  var type    = datatype(v);
                  switch(type){
                  
                    case 'function'         :
                    case 'asyncfunction'    : str   = v.toString();       break;
                    case 'string'           : str   = v;                  break;
                    default                 : str   = inspect(v);         break;
                    
                  }//switch
                  return str;
                  
            });
            
            var txt   = args.join(' ');
            return txt;
            
      }//build
      
      
      function create(node){
      
            var type    = datatype(node);
            switch(type){
            
              case 'string'   : node    = create.string(node);        break;
              
            }//switch
            return node;
            
      }//create
      
      
      create.string   = function(str){
      
            var node    = document.createElement(str);
            return node;
            
      }//string
      
      
  //:
  
  
      obj.horiz   = function(){
      
            host.style.width    = '100%';
            host.style.height   = '50%';
            
      }//horiz
      
      
      obj.vert    = function(){
      
            host.style.width    = '50%';
            host.style.height   = '100%';
            
      }//vert
      
      
  //:
  
  
  
  return obj;
  
})//output_console

      </script>
      
</output-console>

