

<output-root v2.0>

      <template shadowrootmode=open>
      
            <style>
                  
  :host
    {font-family:arial}
  
  #root
    {height:100%;display:flex;flex-direction:column}
  #hdr
    {display:flex;align-items:center;margin:0;margin-bottom:5px}
  
  #spc
    {flex:1}
  
  .ext-button
    {border:1px solid lightgray;padding:2px 5px;cursor:pointer;display:flex;align-items:center;margin-right:10px}
  .ext-button [type=checkbox]
    {margin:0;margin-left:5px;cursor:pointer}
  
  button
    {font-size:16px;margin-right:10px}
  
  #output
    {flex:1;
      overflow:auto;border:2px solid lightgray;box-sizing:border-box;
      padding:10px;margin:0;
      word-break:break-all;
      font-size:16px;line-height:1.5;
    }
                  
            </style>
            
            <div id=root>
                  <div id=hdr>
                        <span id=spc></span>
                        <div id=console-persist class=ext-button>console.persist<input type=checkbox></div>
                        <div id=console-log class=ext-button>console.log<input type=checkbox checked></div>
                        <div id=word-wrap class=ext-button>wrap<input type=checkbox checked></div>
                        <button id=clear>clear</button>
                        <button id=kill>kill</button>
                  </div>
                  
                  <pre id=output>
                  </pre>
            </div>
            
      </template>
      
      <script>
      
(function output({mod,root,node}){
                                                                                console.log('output');
  var obj   = {};

      
      var ext,$
      ;
      
      obj.initmod   = function(params){
        
            ext   = params.ext;
            $     = params.$;
            
      }//initmod
      
      
  //vars:-

      var inspect;
  
      var con             = {};
      con.log             = console.log;
      con.clear           = console.clear;
      con.error           = console.error;
      
      
      var root;
      var shadow;
      
      var output;
      var cur             = {};
      
      var iframe;
      obj.iframe;


      
      var chk             = {};
      var btn             = {};

      
  //:

  
      obj.init    = async function(){
      
            libs();
            
      }//init


      async function libs(){
        
            [inspect]   = await ext.load.libs('js/string/inspect.js');
            
      }//libs

      
  //:

  
      obj.initdom   = function(rootnode){
      
            root                            = $.$(rootnode,'output-root');
            shadow                          = root.shadowRoot;
            
            chk.persist                     = $.chkbox(shadow,'#console-persist',false);
            chk.log                         = $.chkbox(shadow,'#console-log',false);
            chk.wrap                        = $.chkbox(shadow,'#word-wrap',wrap);
            
            $(shadow,'#clear').onclick      = btn.clear;
            $(shadow,'#kill').onclick       = btn.kill;
            
            
            output                          = $(shadow,'#output');
            cur.root                        = output;


            wrap(chk.wrap.checked);

            
      }//initdom
      
      
      btn.kill    = function(){
        
            kill();
            
      }//kill
      
      
      btn.clear   = function(){
        
            clear();
            
      }//clear
      
      
      function wrap(chk){
                                                                    //console.log('wrap',v);
            if(chk.checked){
                  output.style.whiteSpace   = 'pre-wrap';
            }else{
                  output.style.whiteSpace   = '';
            }
            
      }//wrap

      
      obj.run   = async function(js,params){
                                                                    console.log('run');
            var sandbox   = (()=>{
            
                  console.log     = log;
                  console.clear   = clear;
                  console.error   = error;

                  
                  async function run(js){
                  
                        if(!chk.persist){
                              clear();
                        }
                        
                        if(params.async){
                              js      = '(async()=>{\n'+js+'\n})()';
                        }
                        
                        var result    = await eval(js);
                        return result;
                        
                  }//run
                  
                  
                  run.kill    = function(){
                  }//kill
                  
                  
                  return run;
                        
            })();
            
            var result    = await sandbox(js);
            
            if(result){
                  console.log(result);
            }
            
            console.log     = con.log;
            console.clear   = con.clear;
            console.error   = con.error;
            
        
      }//run
      
      
      obj.run.iframe    = async function(js,params){
                                                                    console.log('run.iframe');
            var resolve,promise=new Promise(res=>resolve=res);
            
            if(iframe){
                  iframe.remove();
            }
            
            iframe          = document.createElement('iframe');
            obj.iframe      = iframe;
            iframe.srcdoc   = '';
            iframe.onload   = onload;
            root.append(iframe);
            
            return promise;
            
            
            async function onload(){
            
                  var win             = iframe.contentWindow;
                  win.focus();
                  win.console.log     = log;
                  win.console.clear   = clear;
                  win.console.error   = error;
                  
                  if(!chk.persist){
                        clear();
                  }
                  
                  if(params.async){
                        js      = '(async()=>{\n'+js+'\n})()';
                  }
                  var result    = await win.eval(js);
                  resolve(result);
                  
                  //iframe.remove();
                  
            }//onload
            
      }//iframe
      
      
      obj.kill    = function(){return kill()}
      
      function kill(){
        
            if(!iframe)return;
            iframe.remove();
            
      }//kill



      obj.set   = function(node){
        
            if(node){
                  cur.root    = node;
            }else{
                  cur.root    = output;
            }
            
      }//set
      

  //:
  
  
      
      obj.clear   = function(){return clear()}
      
      function clear(){
        
            if(chk.log.checked){
                  con.clear.call(window.console);
            }
            
            cur.root.replaceChildren();
            
      }//clear
      
      
      obj.log   = function(){return log.apply(log,arguments)};
      
      function log(){

            if(chk.log.checked){
                  con.log.apply(window.console,arguments);
            }

            var str     = '';
            var args    = [...arguments];
            args        = args.map(v=>{
            
                  var type    = datatype(v);
                  switch(type){
                  
                    case 'function'         :
                    case 'asyncfunction'    : str   = v.toString();       break;
                    case 'string'           : str   = v;                  break;
                    default                 : str   = inspect(v);         break;
                    
                  }//switch
                  return str;
                  
            });
            
            var txt           = args.join(' ');
            var div           = document.createElement('div');
            div.textContent   = txt;
            if(txt==''){
                  div.style.height    = '16px';
            }
            cur.root.append(div);
            
            cur.root.scrollTop    = 999999999;
            
            return div;
        
      }//log


      obj.error   = function(){return error.apply(null,arguments)}
      
      function error(){
        
            if(chk.log.checked){
                  con.error.apply(window.console,arguments);
            }
            var node            = log.apply(null,arguments);
            node.style.color    = 'red';
            return node;
            
      }//error
      
      
      
      
      obj.node    = function(){return node.apply(null,arguments)}
      
      function node(node){
        
            if(typeof node=='string'){
                  var str   = node;
                  node      = document.createElement(str);
            }
            
            cur.root.append(node);
            
            return node;
            
      }//node
      
      
      
      
      
      
      
      
  return obj;
  
})//output
            
      </script>
      
</output-root>

