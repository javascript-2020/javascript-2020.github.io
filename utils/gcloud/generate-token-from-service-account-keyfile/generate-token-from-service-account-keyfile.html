


<html>

      <head>
      
            <style>

  html
    {height:100%}
    
  body
    {height:calc(100% - 40px);display:flex;flex-direction:column;gap:10px;margin:20px}
    
  #output
    {overflow:auto;flex:1;
      white-space:pre-wrap;font-family:monospace;word-break:break-all;
    }


  input
    {font-size:16px;padding:5px 10px}
  input[type=button]
    {cursor:pointer}
    
            </style>
            
      </head>
      
      
      <body>
      
            <div>
                  generate access token from service account keyfile
                  
            </div>
            
            <div>
                  select service account keyfile
            </div>
            
            <div>
                  <input id=file type=file>
            </div>
            
            <div>
                  <input value=copy type=button>
                  <input value=new type=button>
            </div>
            
            <div id=output>
            </div>
            
      </body>

      <script type=module>



        var encoder   = new TextEncoder();

        
        var keyfile;
        var token;
      
        
        document.querySelector('[value=copy]').onclick    = e=>{
        
              if(!token){
                    log('no token');
                    return;
              }
              navigator.clipboard.writeText(token);
              log('token copied');
              
        }//copy


        document.querySelector('[value=new]').onclick    = e=>{
        
              if(!keyfile){
                    alert('no service account file selected');
                    return;
              }
              generate();
              
        }//new
        
        
        file.onchange   = async function(){
      
      
              output.replaceChildren();
              
              var blob      = file.files[0];
              keyfile       = await blob.text();
              keyfile       = JSON.parse(keyfile);
              generate();
            
        }//onchange



        async function generate(){
              
              const assertion    = await buildJwtAssertion({
                     clientEmail      : keyfile.client_email,
                     privateKeyPem    : keyfile.private_key.replace(/\\n/g, '\n'),
                     scope            : 'https://www.googleapis.com/auth/devstorage.read_write'
              });
              const json    = await exchangeForAccessToken(assertion);
              token         = json.access_token;
              
              log(JSON.stringify(json,null,4));
              
              log();
              
              log('token');
              log(token);
              
              log();
              
              navigator.clipboard.writeText(token);
              log('copied to clipboard');
      
      
            
              function base64url(input){
              
                    let bytes;
                    if (typeof input === 'string') bytes = encoder.encode(input);
                    else if (input instanceof ArrayBuffer) bytes = new Uint8Array(input);
                    else if (ArrayBuffer.isView(input)) bytes = new Uint8Array(input.buffer, input.byteOffset, input.byteLength);
                    else throw new TypeError('Unsupported input');
                    let bin = '';
                    for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
                    return btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
                
              }//base64url
      
            
              function pemToArrayBuffer(pem){
              
                    const b64 = pem.replace(/-----BEGIN [^-]+-----/g, '')
                                   .replace(/-----END [^-]+-----/g, '')
                                   .replace(/\s+/g, '');
                    const raw = atob(b64);
                    const buf = new Uint8Array(raw.length);
                    for (let i = 0; i < raw.length; i++) buf[i] = raw.charCodeAt(i);
                    return buf.buffer;
                    
              }
      
            
              async function importPkcs8PrivateKey(pem) {
              
                    const keyData = pemToArrayBuffer(pem);
                    return crypto.subtle.importKey(
                      'pkcs8',
                      keyData,
                      { name: 'RSASSA-PKCS1-v1_5', hash: 'SHA-256' },
                      false,
                      ['sign']
                    );
                    
              }
      
            
              async function signRS256(privateKey, dataToSign) {
              
                    const dataBytes = encoder.encode(dataToSign);
                    const sig = await crypto.subtle.sign(
                      { name: 'RSASSA-PKCS1-v1_5' },
                      privateKey,
                      dataBytes
                    );
                    return new Uint8Array(sig);
                    
              }
      
            
              async function buildJwtAssertion({ clientEmail, privateKeyPem, scope, aud = 'https://oauth2.googleapis.com/token' }) {
              
                    const key = await importPkcs8PrivateKey(privateKeyPem);
                
                    const now = Math.floor(Date.now() / 1000);
                    const header = { alg: 'RS256', typ: 'JWT' };
                    const payload = {
                      iss: clientEmail,
                      scope: Array.isArray(scope) ? scope.join(' ') : scope,
                      aud,
                      iat: now,
                      exp: now + 3600, // 1 hour max
                    };
                
                    const encodedHeader = base64url(JSON.stringify(header));
                    const encodedPayload = base64url(JSON.stringify(payload));
                    const unsigned = `${encodedHeader}.${encodedPayload}`;
                
                    const sig = await signRS256(key, unsigned);
                    const encodedSig = base64url(sig);
                    return `${unsigned}.${encodedSig}`;
                    
              }//build
            
              
              async function exchangeForAccessToken(assertion) {
              
                    const body = new URLSearchParams({
                      grant_type: 'urn:ietf:params:oauth:grant-type:jwt-bearer',
                      assertion
                    });
                    const res = await fetch('https://oauth2.googleapis.com/token', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                      body
                    });
                    if (!res.ok) {
                      throw new Error(`Token exchange failed: ${res.status} ${res.statusText} ${await res.text()}`);
                    }
                    return res.json(); // { access_token, token_type, expires_in }
                    
              }//exchange
            
        
        }//generate

        function log(){
        
              console.log.apply(console,arguments);
              
              var str   = [...arguments].join(' ');
              var div   = document.createElement('div');
              div.textContent   = str;
              div.style.cssText   = 'margin-bottom:10px';
              output.append(div);
              
              output.scrollTop    = output.scrollHeight;
              
        }//log
   
</script>