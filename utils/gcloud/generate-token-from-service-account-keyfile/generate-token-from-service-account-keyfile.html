


<!DOCTYPE html>

<html>

      <head>
            <meta charset=utf-8>
            
            <title>
                  Google Cloud Generate Token From Service Account KeyFile
            </title>
            
            <meta name=description content='google cloud generate token from service account keyfile'>
            
            <base href='https://ext-code.com/utils/gcloud/generate-token-from-service-account-keyfile/'>
            <link rel=canonical href='https://ext-code.com/utils/gcloud/generate-token-from-service-account-keyfile/generate-token-from-service-account-keyfile.html'>
            
            <link rel=icon href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAABxVBMVEVHcExeiuEePYxxkts5VpUuSJpfi+FZht9EddoZQq8zX8RLetxfiNeRbltmkuWVlLPdrlpdcbw6ac46Vqhdh9waQKtggtk3YMbQzcBoidbToFHuzo1kjeEmT7nitmEWOaJTddNHbc5AbtJZfddHcdAeRrAtR5pukttnjuFzluF8iq9Kd9V/nN9qkeHAkFXgqk7ouFxolOkyR5Wwf0RDN1wuQYweNZC7nGpNT3scOJmqkGs6bdg8btg5a9bvmgc/cNlIed1Of+FFdt03aNNdjOdlk+pRguNCdNzi0LVLfN9hkOidgWjvnQpJet9aieUzZM87b9tXh+WQqNtBctrvpiHtlQRUheN4iLAuXcsuWMLmtFXskQKthEzvpB92d5DwqSjrvF7qnxnyrS7l1bqUrN6Bk7lGcNCjkn32tDfq3MSdtueYseEeO6IlRq4/bdV7gp6EcHFBbMyPjpVFaL/GqnfJto08YLytlXOmu+XLnVIyP4g1OHPWpVFVSmrQqWAnU8LisFS9ciVKbMXRgxtacbZcgNHdrFBcfMdbesTRycLSvIqlpaVtj9iln5lwmulSWZDNu5DRpFdjY4vBnGale0y6oHaljnKjk2rgAAAAO3RSTlMAZAMMAh+vr8vhq8cPCGUgwR+qIIrg4+ECi48TSOHF4ODhk+DBcB7HlimJcgZVD/3V8iK/RR/i+Cfe9Mct7OMAAAHbSURBVCjPhdNnW9NAAMDx0qLM2mVZshVQWeLWJr00AWqAEiEE2rSkARE72XtvEVEUhM/LXe4KIc8j/F/kRX7PJTcSk+nOmsofwLIMlVsIN7d1dLX3Dnb6fDzPBwIMqZHwQ6h9nT6eYVm/CACgUEB0ZhP+nVhKJJLJ5Bisn3RMOc2El+Lx+BfYJ10/9vMJl87HYrHR0Wg0OoAa1opOZvj5AbSBEVgPyQuLEH7W8BU2hJqMSF6MiPHUnpKJB+DE93Ylr/cGm+/r1rWzHQ5LkhSG10i+ycB+cXyqO5PypPCaBxGLaFMA+KwFQK1ZNzrAwC2jcB6t3EI9syJFT09zHO3xGBieB8+I1OGvubmZWYGm6RsMj8vHs+D7kbq8LC8uCBx2wl2YJ36qUysr3bIS5LTxFOYc/Gr/+J+/q6n0ifwtpA2njDy/tppKnapXXIC5Hc+MnlH/ra+fqQphUGDBjPaMFT2zi/LBFnx2EC2OAhlGnxlaNbegbGwooSAajL4mjbOdEzTHCYIQDG2mzy/Sm5ChsSyjsakuT8vtrqp6++7jB3dFRXFxTfXjoqLSEsTW+nukN+8r7a9fulwuh8Nhs9ksxh/CWrn2quX//4vVLr94dBu32m/jsjJbif7GJSYFrVsaLrNGAAAAAElFTkSuQmCC'>
            <meta name=viewport content='width=device-width, initial-scale=1'>
            
            <script type='application/ld+json'>
                  {
                        "@context"              : "https://schema.org",
                        "@type"                 : "SoftwareApplication",
                        "name"                  : "Google Cloud Generate Token From Service Account KeyFile",
                        "url"                   : "https://ext-code.com/utils/gcloud/generate-token-from-service-account-keyfile/generate-token-from-service-account-keyfile.html",
                        "author"                : {"@type":"Person","name":"Matthew Richards"},
                        "description"           : "google cloud generate token from service account keyfile",
                        "applicationCategory"   : "DeveloperApplication",
                        "operatingSystem"       : "All",
                        "browserRequirements"   : "Requires JavaScript-enabled browser",
                        "softwareVersion"       : "1.0.0",
                        "offers"                : {"@type":"Offer","price":"0","priceCurrency":"GBP"}
                  }
            </script>
            

            <script src='https://libs.ext-code.com/js/dom/component/component.js'></script>

            <script init>
                                                                                console.clear();
                                                                                console.log('backup-github-repo.html');
                                                                                console.log();
                                                                                console.json=v=>console.log(JSON.stringify(v,null,4));
        var df=true,version='v2.0'
        ;
        
        var ext;
        var $;
        var datatype;
        var menumod;
        var keydown;
        var debug;
        
        var menu;
        
        var hdr;
        var log;
      
      
        async function init(){
          
              menu    = menumod();
              
              hdr     = mod['gcloud-hdr'];
              log     = mod['log-mod'];
              
              hdr.initmod({ext,$,menu});
              log.initmod({ext,$});
              
              await Promise.all([
                    hdr.init(),
                    log.init(),
              ]);
              
              
              initdom();
              
        }//init
        

(async()=>{

        mod.stack.add;
        
        ({ext}    = await import('https://libs.ext-code.com/js/io/ext-loader/ext-loader.m.js'));
          
        var promise   = ext.load.libs(
              'js/dom/$.js',
              'js/core/datatype.js',
              'js/dom/menumod/menumod.js',
              'js/dom/keydown/keydown.js',
              'js/debug/debug.js',
        );
        [$,datatype,menumod,keydown,debug]   = await promise;

  
        //JSZip   = (await import('https://cdn.jsdelivr.net/npm/jszip/+esm')).default;

        mod.stack.complete;
              
})();

            </script>
            
            
            <style>

  html
    {height:100%;font-family:arial}
    
  body
    {height:calc(100% - 40px);display:flex;flex-direction:column;gap:10px;margin:20px}
    
  #output
    {overflow:auto;flex:1;
      white-space:pre-wrap;font-family:monospace;word-break:break-all;
    }


  input
    {font-size:16px;padding:5px 10px}
  input[type=button]
    {cursor:pointer}


.visually-hidden 
  {position:absolute;clip:rect(0 0 0 0);width:1px;height:1px;overflow:hidden;}
    
            </style>
            
      </head>
      
      
      <body>

            <gcloud-hdr component=grp>
                  <h1 class=visually-hidden>generate access token from service account keyfile</h1>
                  <img class=title src='images/' style='top:5px;height:60px' alt='generate access token from service account keyfile'>
                  <time slot=date datetime=2025-11-01>1 Nov 2025</time>
            </gcloud-hdr>
      
            <div>
                  select service account keyfile
            </div>
            
            <div>
                  <input id=file type=file>
            </div>
            
            <div>
                  <input value=copy type=button>
                  <input value=new type=button>
            </div>
            
            <div id=output>
            </div>
            
            <log-mod component></log-mod>
            
      </body>


      <script>
      
        var encoder   = new TextEncoder();

        
        var keyfile;
        var token;

      
        function initdom(){


          
              document.querySelector('[value=copy]').onclick    = e=>{
              
                    if(!token){
                          disp('no token');
                          return;
                    }
                    navigator.clipboard.writeText(token);
                    disp('token copied');
                    
              }//copy
      
      
              document.querySelector('[value=new]').onclick    = e=>{
              
                    if(!keyfile){
                          disp('no service account file selected');
                          return;
                    }
                    generate();
                    
              }//new
              
              
              file.onchange   = async function(){
            
                    var blob      = file.files[0];
                    var txt       = await blob.text();
                    keyfile       = JSON.parse(txt);
                    generate();
                  
              }//onchange


        
        }//initdom
        
        
  //:


        async function generate(){
              
              output.replaceChildren();

              
              const assertion    = await buildJwtAssertion({
                     clientEmail      : keyfile.client_email,
                     privateKeyPem    : keyfile.private_key.replace(/\\n/g, '\n'),
                     scope            : 'https://www.googleapis.com/auth/devstorage.read_write'
              });
              const json    = await exchangeForAccessToken(assertion);
              token         = json.access_token;

              
              disp(JSON.stringify(json,null,4));
              
              disp();
              
              disp('token');
              disp(token);
              
              disp();
              
              navigator.clipboard.writeText(token);
              disp('copied to clipboard');
      
      
            
              function base64url(input){
              
                    let bytes;
                    
                    if(typeof input=='string'){
                          bytes   = encoder.encode(input);
                    }else if(input instanceof ArrayBuffer){
                          bytes   = new Uint8Array(input);
                    }else if(ArrayBuffer.isView(input)){
                          bytes   = new Uint8Array(input.buffer, input.byteOffset, input.byteLength);
                    }else{
                          throw new TypeError('Unsupported input');
                    }
                    
                    var bin   = '';
                    for(var i=0;i<bytes.length;i++){
                      
                          bin  += String.fromCharCode(bytes[i]);
                          
                    }//for
                    
                    var str   = btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
                    return str;
                
              }//base64url
      
            
              function pemToArrayBuffer(pem){
              
                    const b64   = pem.replace(/-----BEGIN [^-]+-----/g, '')
                                        .replace(/-----END [^-]+-----/g, '')
                                        .replace(/\s+/g, '');
                    const raw   = atob(b64);
                    const buf   = new Uint8Array(raw.length);
                    
                    for(let i=0;i<raw.length;i++){
                      
                          buf[i]    = raw.charCodeAt(i);
                            
                    }//fpr
                    
                    return buf.buffer;
                    
              }//pem_buf
      
            
              async function importPkcs8PrivateKey(pem) {
              
                    var keyData   = pemToArrayBuffer(pem);
                    var key       = await crypto.subtle.importKey('pkcs8',keyData,{name:'RSASSA-PKCS1-v1_5',hash:'SHA-256'},false,['sign']);
                    return key
                    
              }//import
      
            
              async function signRS256(privateKey, dataToSign) {
              
                    var dataBytes   = encoder.encode(dataToSign);
                    var sig         = await crypto.subtle.sign({name:'RSASSA-PKCS1-v1_5'},privateKey,dataBytes);
                    var uint8       = new Uint8Array(sig);
                    return uint8;
                    
              }//sign
      
            
              async function buildJwtAssertion({clientEmail,privateKeyPem,scope,aud='https://oauth2.googleapis.com/token'}){
              
                    var key               = await importPkcs8PrivateKey(privateKeyPem);
                
                    var now               = Math.floor(Date.now()/1000);
                    var header            = {alg:'RS256',typ:'JWT'};
                    var payload           = {
                                                  iss     : clientEmail,
                                                  scope   : Array.isArray(scope) ? scope.join(' ') : scope,
                                                  aud     : aud,
                                                  iat     : now,
                                                  exp     : now+3600, // 1 hour max
                                            };
                
                    var encodedHeader     = base64url(JSON.stringify(header));
                    var encodedPayload    = base64url(JSON.stringify(payload));
                    var unsigned          = `${encodedHeader}.${encodedPayload}`;
                
                    var sig               = await signRS256(key,unsigned);
                    var encodedSig        = base64url(sig);
                    var str               = `${unsigned}.${encodedSig}`;
                    return str
                    
              }//build
            
              
              async function exchangeForAccessToken(assertion) {
              
                    var url       = 'https://oauth2.googleapis.com/token';
                    var body      = new URLSearchParams({grant_type:'urn:ietf:params:oauth:grant-type:jwt-bearer',assertion});
                    var headers   = {'Content-Type':'application/x-www-form-urlencoded'};
                    
                    var err;
                    try{
                      
                          var res       = await fetch(url,{method:'psot',headers,body});
                          
                    }//try
                    catch(err2){
                      
                          err   = err2;
                          
                    }//catch
                    if(err){
                                                                                console.error(err);
                          disp(err.toString());
                          return;
                    }
                    
                    if(!res.ok){
                          throw new Error(`Token exchange failed: ${res.status} ${res.statusText} ${await res.text()}`);
                    }
                                                                                // { access_token, token_type, expires_in }
                    var json    = await res.json();
                    return json;
                    
              }//exchange
            
        
        }//generate


        function disp(){
        
              console.log.apply(console,arguments);
              
              var str   = [...arguments].join(' ');
              var div   = document.createElement('div');
              div.textContent   = str;
              div.style.cssText   = 'margin-bottom:10px';
              output.append(div);
              
              output.scrollTop    = output.scrollHeight;
              
        }//disp



   
      </script>
      
      
</html>




