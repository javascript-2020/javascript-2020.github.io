


<html>

      <head>
      
            <title>html-editor</title>

            <base href='https://javascript-2020.github.io/utils/misc/zip/zip.html'>
            
            <link rel=icon type='image/png' href='images/zip-30.png'>

      
            <script init>
            
                                                                                console.clear();
                                                                                console.json=v=>console.log(JSON.stringify(v,null,4));
        var version       = 'v1.0';
            
        var df            = true;


        var mod   = {};
        
        var ext;
        var $;
        var datatype;
        var menumod;
        var keydown;
        var hs;
        
        var jszip;
        
        var filemod;
        var filenav;
        
        var add   = {};
        
        var log;


        var zip;


  //:
  

        async function init(){
                                                                                debug('init',version);

              //keydown                   = keydown();
              menumod                   = menumod();
              //mod.utils.hdr             = mod.utils.hdr();
              //mod.menu.main             = mod.menu.main();
              filemod                   = mod.filemod();
              add.file                  = mod.filemod();
              filenav                   = mod.filenav();
              log                       = mod.log();
              
              //mod.utils.hdr.initmod({ext,$,menu,menumod});
              //mod.menu.main.initmod({ext,$,menumod,editor,filemod});
              filemod.initmod({ext,$,menumod,complete});
              add.file.initmod({ext,$,menumod,complete:add.complete});
              filenav.initmod({ext,$,datatype});
              log.initmod({ext,$});
              
              //mod.menu.main.init();
              //mod.utils.hdr.init();
              filemod.init();
              add.file.init();
              log.init();

  //:
          
              window.onfocus            = null;
              //keydown.add(kd);
              menumod.on.close          = null;

              
              await initdom(document.body);


              zip   = new jszip();
              
              

              init.complete();

              
        }//init


        init.stack            = [];
        init.stack.ct         = 0;
        init.stack.total      = 1;
        init.stack.mode       = '';
        init.stack.complete   = false;
        Object.defineProperty(init.stack,'add',{get:()=>{
              init.stack.total++;
              init.stack.mode && console[init.stack.mode]('add',init.stack.ct,init.stack.total);
        }});
        Object.defineProperty(init.stack,'complete',{get:()=>{
              init.stack.ct++;
              init.stack.mode && console[init.stack.mode]('complete',init.stack.ct,init.stack.total);
              init.stack.ct>=init.stack.total && init();
        }});
        
        //  (typeof init!='undefined' && init?.stack && init.stack.add)
        //  (typeof init!='undefined' && init?.stack && init.stack.complete)

        
        init.complete   = function(){
          
              init.complete.stack.forEach(fn=>setTimeout(fn,50));
              
        }//complete
        
        init.complete.stack   = [];
        init.complete.add     = fn=>init.complete.stack.push(fn);

                  

(async()=>{
  
        init.stack.add;
        
        var token   = localStorage['github-token'];
        var url;
        var headers;
        if(token){
              url       = 'https://api.github.com/repos/javascript-2020/ext-code/contents/ext-loader.js';
              headers   = {accept:'application/vnd.github.raw',authorization:`bearer ${token}`};
        }else{
              url       = 'https://raw.githubusercontent.com/javascript-2020/ext-code/main/ext-loader.js';
        }
        
        await fetch(url,{headers}).then(res=>res.text()).then(complete);

            
        async function complete(txt){

              ext           = eval(txt);
              var promise   = ext.load.libs(
                    'js/dom/$.js.api',
                    'js/core/datatype.js',
                    'js/dom/menumod/menumod.js',
                    'js/dom/keydown/keydown.js',
                    'js/string/hs.js'
              );
              [$,datatype,menumod,keydown,hs]   = await promise;

              init.stack.complete;

        }//ext_fn

})();


(async()=>{
     
        init.stack.add;

        
        jszip   = await import('https://cdn.jsdelivr.net/npm/jszip/+esm');
        jszip   = jszip.default;
        
        console.log(jszip);
        
        init.stack.complete;
        
})();


            </script init>

            
      </head>
      
      
      <body>

            <style>

  html
    {height:100%}
  body
    {height:calc(100% - 40px);margin:20px;font-family:arial;display:flex;flex-direction:column;gap:10px}
  
  .icon
    {border:1px solid gray;border-radius:3px;box-sizing:border-box;width:30px;height:30px;cursor:pointer}
  .spc
    {flex:1}

  #hdr
    {display:flex;align-items:center}

  #info
    {display:flex;gap:10px;flex-direction:column;border-bottom:1px solid lightgray;padding-bottom:10px}
  #info>div
    {display:flex}
  #info label
    {width:60px;text-align:right;margin-right:20px}
    
  #add
    {display:flex;align-items:center;gap:10px}
    
  #view
    {flex:1;display:flex;flex-direction:column;gap:5px;overflow:auto;border:1px solid lightgray;border-radius:5px;padding:10px}
  view>div:nth-of-type(odd)
    {background:#e0e0e0;}
  view>div:nth-of-type(even) 
    {background:lightyellow;}

  input    
    {font-size:16px;padding:5px 10px;box-sizing:border-box}
    
  input[type=button]
    {cursor:pointer}

      
            </style>

      
            <h3>
                  zip
            </h3>
            
            
            <div id=hdr>
            
                  <filemod-api>
                        <script src='https://html-loader-1024713184986.us-central1.run.app/'></script>
                  </filemod-api>
            
                  <input value=save type=button>
                  
            </div>

            
            <div id=info>
       
                  <div>           
                        <label>
                              filename
                        </label>
                        
                        <div id=filename>
                              not set
                        </div>
                  </div>
                  
                  <div>
                        <label>
                              size
                        </label>
                        
                        <div id=size>
                              --
                        </div>
                  </div>
                  
            </div>

            
            <div id=add>

                  <div>
                        add file
                  </div>
                  
                  <filemod-api>
                        <script src='https://html-loader-1024713184986.us-central1.run.app/'></script>
                  </filemod-api>
                  
            </div>

            
            <div id=view>
            
                  <file-nav-api>
                        <script html-loader src='https://html-loader-1024713184986.us-central1.run.app/'></script>
                  </file-nav-api>
            
            </div>


            <log-api>
                  <script src='https://html-loader-1024713184986.us-central1.run.app/'></script>
            </log-api>

            
            <script>


        var size          = 0;
        

        
        var ui            = {};
        ui.view           = {};
        
        var root;
        var view;


        var file;
        var dir;
        
        var btn           = {};


  //:
  
  
        async function initdom(rootnode){
          
              root                                  = rootnode;
              

              filemod.initdom(root);
              
              
              info                                  = $(root,'#info');
              ui.info();
              
              
              add.root                              = $(root,'#add');
              add.file.initdom(add.root);
              
              $(root,'[value=save]').onclick        = btn.save;


              view                                  = $(root,'#view');


              
              log.initdom();


              
        }//initdom


  //:
  
  
        btn.save    = function(){
        }//save
        

  //:
  
  
        ui.info   = function(){
          
              var str   = 'not set';
              if(filemod.cur){
                    str   = filemod.cur.filename;
              }
              $(info,'#filename').textContent   = str;
              
              var str   = hs(size);
              if(size>1024){
                    str  += ' , '+size+' B';              
              }
              $(info,'#size').textContent   = str;
              
        }//info
        
        
        ui.view.add   = function(item,abs){
          
              $(item,'.rem').onclick    = rem;
              
              view.append(item);
              empty.remove();
              
              
              function rem(){
              }//rem
              
        }//add
        
        
  //:
  

        async function source(){
          
              var blob      = await zip.generateAsync({type:'blob'});
              return blob;
              
        }//source
        
        
        function complete(file){
          
              filemod.cur   = file;
              
        }//complete
        
        
        complete.load   = async function(file,blob){
          
              var name    = file.filename;
              var size    = hs(blob.size);

              
              complete(file);
              
              
              var err;
              try{
                
                    zip   = await jszip.loadAsync(blob);
                    
              }//try
              catch(err2){
                
                    err   = err2;
                  
              }//catch
              if(err){
                    alert('error loading zip file\n'+err.toString());
                    return;
              }
              
              
              
              var list      = [];
              var entries   = Object.entries(zip.files);
              var path;
              var entry;
              for([path,entry] of list){
                
                    list.push(path);
                    
              }//for
              
              console.json(list);
              
              //need to add files to view
              
              
        }//load


        complete.save   = function(file,confirm=true){
          
              complete(file);

              if(confirm){
                    log.green(file.filename,'saved');
              }
              
        }//save


    //:


        add.complete    = function(){}
        
        add.complete.load   = function(file,blob){

        
              var nitem   = item.cloneNode(true);
              
              $(nitem,'.filename').textContent    = file.filename;
              $(nitem,'.size').textContent        = hs(blob.size);
              
              ui.view.add(nitem);


              size   += blob.size;
              ui.info();
              
              
              var abs   = file.filename;
              
              zip.file(abs,blob);

              
              
        }//load
        
        
        //add.complete.save   = function(){}


  //:
  
  
        file.rem    = function(){
        }//rem
        
        
        dir.read    = function(){
        }//read
        
        
        dir.par   = function(){
        }//par
        
        
        dir.add   = function(){
        }//add
        
        
        dir.rem   = function(){
        }//rem
        
        
        dir.clear   = function(){
        }//clear
        
        
        dir.dblclick    = function(){
        }//dblclick

        
  //:
  
  
        
  //:
  

        function debug(){
          
              if(!df)return;
              var str   = [...arguments].join(' ');
              console.log('[ zip-html ]',str);
          
        }//debug


  //:
  
  
  init.stack.complete;
        
            </script>
            
      </body>
      
      
</html>


