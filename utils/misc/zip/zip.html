

<!DOCTYPE html>

<html>

      <head>
            <meta charset=utf-8>
            
            <title>
                  zip
            </title>
            
            <meta name=description content='Use this tool to build a zip archive directly in the browser.'>
            
            <base href='https://ext-code.com/utils/misc/zip/'>
            <link rel=canonical href='https://ext-code.com/utils/misc/zip/zip.html'>
            
            <link rel=icon type='image/png' href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAABIFBMVEVHcEwLCQc7MxwAAQEeHh4jHhUuJhIAAAAGBQUCAgIBAQIHBwcBAQILCwsODQwAAAAdGxVXSCM8PD0VEQoAAAMAAADs6u3u7O9fTyr/4HWniT2mpakvLi/r6ezRz9LHxchPRSpbUTHu6+/Ny87w7vG1tLj/4ndUUUywr7NGRUX623Pvxlv01nHl4+eXg0asllD/5Hjx7/Lo5unW1Ne4oVSqjUDt0G3702RUSCVXVla6ubxIPyT50GLlymuTkpQzMjG5o1XfxWjDwsS+vL9gX2CHd0BLSkza2Nvg3+LDq1uqqazZvmXmvVTKycxqaWuBbjc9PT6ZmJr/3m85ODNsXzLRtmZkVi93dXbHr1wmJymGhYh+b0y5pHPFoEbFoUhWTCumkv3wAAAAFnRSTlMAkv8KxfziBXUVJIk4o71D0vTzsDAdMqg2MwAAAa1JREFUKM9104lymkAAgGFTqzVHczQJK9HYzS5iCYcWGoMcIirexHjmaJO8/1t0F2MigfzMLDvzzS7DLCQSQcn9L9FSmRUmtg/S5cYfWoPeGvdVmrK10m/ffwilVc6MDLOUwvL89OqVk1+bqkxTcamtyWpdEIhv8E/A0IDh3PqAq9+0iMcwFmoaItwjHsPN2w4G3KTWbOacs1guAFCoCULnQT+LsE83Z5CsadokG+WWI/hkihBiclFGhU67i4LpeQyDQX5mgM/5Zjx/5D7l83bj6u7D6uT2zprV0n25HX72znE6nXpl5u4F1sOrM2Nx9Ff7DWicnBuoHADonbeyz0//iusMgw7k5d7YvMhehIO1HnrjMntJkiTpklwSnY9MDN65wrK8u4RL17PH0JNYVoR+mFlp8TK34VBXzH4lhit9aFfhEJq6y0dYkqqm5warbTayOd/vL0w4H3q255KtpgEPlgHvKtNry7JEUby2yEWyRhADFS+Cj2nv8OhIz4bSyXvLLWV1JKd7B4f14q+Nil1G7eVS6cz6QI1uYTOMfTzZP0muf6K8k/+Q87BL5D8NUW1MDvRgFwAAAABJRU5ErkJggg=='>
            <meta name=viewport content='width=device-width, initial-scale=1'>
            
            <script type='application/ld+json'>
                  {
                        "@context"              : "https://schema.org",
                        "@type"                 : "SoftwareApplication",
                        "name"                  : "zip",
                        "url"                   : "https://ext-code.com/utils/misc/zip/zip.html",
                        "author"                : {"@type":"Person","name":"Matthew Richards"},
                        "description"           : "Use this tool to build a zip archive directly in the browser.",
                        "applicationCategory"   : "DeveloperApplication",
                        "operatingSystem"       : "All",
                        "browserRequirements"   : "Requires JavaScript-enabled browser",
                        "softwareVersion"       : "1.0.0",
                        "offers"                : {"@type":"Offer","price":"0","priceCurrency":"GBP"}
                  }
            </script>
            
            
            <script src='https://libs.ext-code.com/js/dom/component/v3.0/component.js'></script>
            
            <script init>
            
                                                                                console.clear();
                                                                                console.log('zip-v2.0.html');
                                                                                console.log();
                                                                                console.json=v=>console.log(JSON.stringify(v,null,4));
        var df=true,version='v2.0'
        ;
        
        var jszip;
        
        var ext;
        var $;
        var datatype;
        var menumod;
        var keydown;
        var hs;
        
        var menu;
        
        var hdr;
        var filemod;
        var filenav;
        var add   = {};
        var log;
        
        
        var zip;
        
        
  //:
  
  
        async function init(){
        
        
              //keydown                   = keydown();
              menu                      = menumod();
              
              mod.base.add({ext,$,datatype,keydown,menu,menumod});
              
              
              hdr                       = mod['misc-hdr'];
              //mod.menu.main             = mod.menu.main();
              filemod                   = mod['file-mod'];
              add.file                  = mod['file-add'];
              filenav                   = mod['file-nav'];
              log                       = mod['log-mod'];
              
              hdr.initmod({$,menumod,menu});
              //mod.menu.main.initmod({ext,$,menu,editor,filemod});
              filemod.initmod({ext,$,menumod,menu,complete,source,log});
              add.file.initmod({ext,$,menumod,menu,complete:add.complete,log});
              filenav.initmod({ext,$,datatype});
              filenav.file    = file;
              filenav.dir     = dir;
              log.initmod({ext,$});
              
              await Promise.all([
                    hdr.init(),
                    //mod.menu.main.init(),
                    filemod.init(),
                    add.file.init(),
                    filenav.init(),
                    log.init(),
              ]);
              
  //:
  
              window.onfocus            = null;
              //keydown.add(kd);
              menu.on.close          = null;
              
              
              zip   = new jszip();
              
              
              
              
              initdom(document.body);
              
              
              
        }//init
        
        
        
(async()=>{

        mod.stack.add;
        
        ({ext}    = await import('https://libs.ext-code.com/js/io/ext-loader/ext-loader.m.js'));
        
        var promise   = ext.load.libs(
              'js/dom/$.js',
              'js/core/datatype.js',
              'js/dom/menumod/menumod.js',
              'js/dom/keydown/keydown.js',
              'js/string/hs.js'
        );
        [$,datatype,menumod,keydown,hs]   = await promise;
        
        mod.stack.complete;
        
})();


(async()=>{

        mod.stack.add;
        
        jszip   = await import('https://cdn.jsdelivr.net/npm/jszip/+esm');
        jszip   = jszip.default;
        
        mod.stack.complete;
        
})();


            </script init>
            
            
      </head>
      
      
      <body>
      
            <style>
            
  html
    {height:100%}
  body
    {height:calc(100% - 40px);margin:20px;font-family:arial;display:flex;flex-direction:column;gap:10px}
    
  .icon
    {width:32px;height:32px;border:1px solid gray;border-radius:3px;box-sizing:border-box;cursor:pointer}
  .spc
    {flex:1}
    
  #hdr
    {display:flex;align-items:center;margin-top:20px}
    
  #info
    {display:flex;gap:10px;flex-direction:column;border-bottom:1px solid lightgray;padding-bottom:10px;margin-bottom:20px}
  #info>div
    {display:flex}
  #info label
    {width:60px;text-align:right;margin-right:20px}
    
  #add
    {display:flex;align-items:center;gap:10px}
    
  #view
    {flex:1;display:flex;flex-direction:column;gap:5px;overflow:auto;border:1px solid lightgray;border-radius:5px;padding:10px}
  view>div:nth-of-type(odd)
    {background:#e0e0e0;}
  view>div:nth-of-type(even)
    {background:lightyellow;}
    
  input
    {font-size:16px;padding:5px 10px;box-sizing:border-box}
    
  input[type=button]
    {cursor:pointer}
    
  file-nav
    {height:100%}
    
    
  [value='list files']
    {margin-left:10px}
    
            </style>
            
            
            <misc-hdr component=grp>
                  <img class=title src='image/zip.png' style='top:-15px;height:55px'>
                  <time slot=date datetime=2025-10-31>31 Oct 2025</time>
            </misc-hdr>
            
            
            <div id=hdr>
            
                  <file-mod component></file-mod>
                  
                  <input value=save type=button>
                  <input value='list files' type=button>
                  
            </div>
            
            
            <div id=info>
            
                  <div>
                        <label>
                              filename
                        </label>
                        
                        <div id=filename>
                              not set
                        </div>
                  </div>
                  
                  <div>
                        <label>
                              size
                        </label>
                        
                        <div id=size>
                              --
                        </div>
                  </div>
                  
            </div>
            
            
            <div id=add>
            
                  <div>
                        add file
                  </div>
                  
                  <file-mod id=file-add component></file-mod>
                  
            </div>
            
            
            <div id=view>
            
                  <file-nav component></file-nav>
                  
            </div>
            
            
            <log-mod component></log-mod>
            
            
            <script>
            
            
        var size          = 0;
        
        
        
        var ui            = {};
        ui.view           = {};
        
        var root;
        var view;
        
        
        var file          = {};
        var dir           = {};
        
        var btn           = {};
        
        
  //:
  
  
        async function initdom(rootnode){
        
              root                                          = rootnode;
              
              
              hdr.initdom();
              
              
              filemod.initdom();
              
              
              info                                          = $(root,'#info');
              ui.info();
              
              
              add.root                                      = $(root,'#add');
              add.file.initdom();
              
              $(root,'[value=save]').onclick                = btn.save;
              $(root,'[value="list files"]').onclick        = btn['list-files'];
              
              
              view                                          = $(root,'#view');
              
              filenav.initdom();
              
              
              log.initdom();
              
              
              
        }//initdom
        
        
  //:
  
  
        btn.save    = function(){
        
        
              filemod.save();
              
        }//save
        
        
        btn['list-files']   = function(){
        
              var list    = read();
              console.json(list);
              
        }//test
        
        
  //:
  
  
        ui.info   = async function(){
        
              var str   = 'not set';
              if(filemod.cur){
                    str   = filemod.cur.filename;
              }
              $(info,'#filename').textContent   = str;
              
              var str     = '--';
              var blob    = await source();
              if(blob){
                    var size    = blob.size;
                    
                    var str   = hs(size);
                    if(size>1024){
                          str  += ' , '+size+' B';
                    }
              }
              $(info,'#size').textContent   = str;
              
        }//info
        
        
        ui.view.add   = function(item,abs){
        
              $(item,'.rem').onclick    = rem;
              
              view.append(item);
              empty.remove();
              
              
              function rem(){
              }//rem
              
        }//add
        
        
  //:
  
  
        async function source(){
        
              var blob      = await zip.generateAsync({type:'blob'});
              return blob;
              
        }//source
        
        
        function complete(file){
        
              filemod.cur   = file;
              ui.info();
              
        }//complete
        
        
        complete.load   = async function(file,blob){
                                                                                debug('complete.load');
              menu.close();
              
              var name    = file.filename;
              var size    = hs(blob.size);
              
              
              complete(file);
              
              
              var err;
              try{
              
                    zip   = await jszip.loadAsync(blob);
                    
              }//try
              catch(err2){
              
                    err   = err2;
                    
              }//catch
              if(err){
                    alert('error loading zip file\n'+err.toString());
                    return;
              }
              
              
              display('/');
              
              
        }//load
        
        
        complete.save   = function(file,confirm=true){
        
              complete(file);
              
              if(confirm){
                    log.green(file.filename,'saved');
              }
              
        }//save
        
        
    //:
    
    
        function read(path){
                                                                                console.log('read',path);
              path        ||= '';
              
              var list      = [];
              var entries   = Object.entries(zip.files);
              var fn;
              var entry;
              
              for([fn,entry] of entries){
                                                                                //console.log(fn,entry);
                                                                                console.log(fn);
                    if(!fn.startsWith('/')){
                          fn    = '/'+fn;
                    }
                    
                    if(fn.startsWith(path)){
                                                                                console.log('found');
                          list.push(fn);
                    }
                    
              }//for
              
              return list;
              
        }//read
        
        
        function display(path){
        
              path      ||= filenav.cur.path;
              var list    = read(path);                                                                                //console.json(list);
              
              filenav.display.flat(path,list);
              
              
        }//display
        
        
    //:
    
    
        add.complete    = function(){}
        
        add.complete.load   = function(file,blob){
                                                                                debug.log('add.complete.load',file,blob);
              menu.close();
              
              var path    = filenav.cur.path;
              var abs     = path+file.filename;
              if(abs.startsWith('/')){
                    abs   = abs.slice(1);
              }
              
              zip.file(abs,blob);
              
              ui.info();
              //debugger;
              display();
              
        }//load
        
        
        //add.complete.save   = function(){}
        
        
  //:
  
  
        file.add    = function(path,name){
                                                                                debug('file.add',path,name);
              var abs   = path+name;
              if(abs.startsWith('/')){
                    abs   = abs.slice(1);
              }
              zip.file(abs,'');
              display(path);
              
        }//add
        
        
        file.rem    = function(path,name){
                                                                                debug('file.rem',path,name);
              var abs   = path+name;
              if(abs.startsWith('/')){
                    abs   = abs.slice(1);
              }
              zip.remove(abs);
              display(path);
              
        }//rem
        
        
        file.upload   = function(path,name,blob){
                                                                                debug('file.upload',path,name,blob.size);
              var abs   = path+name;
              if(abs.startsWith('/')){
                    abs   = abs.slice(1);
              }
              zip.file(abs,blob);
              display(path);
              
        }//upload
        
        
        file.download   = async function(path){
                                                                              debug('file.download',path);
              if(path.startsWith('/')){
                    path    = path.slice(1);
              }
              var blob    = await zip.file(path).async('blob');
              
              console.log(blob);
              
              return {blob};
              
        }//download
        
        
/*
        dir.read    = function(){
        
        }//read
*/


        dir.parent    = function(path){
                                                                                debug('dir.par',path);
              display(path);
              
        }//par
        
        
        dir.add   = function(path,name){
                                                                                debug('dir.add',path,name);
              var abs   = path+name;
              if(abs.startsWith('/')){
                    abs   = abs.slice(1);
              }
              zip.folder(abs);
              
              display(path);
              
              return false;
              
        }//add
        
        
        dir.rem   = function(path,name){
        
              var abs   = path+name;
              if(abs.startsWith('/')){
                    abs   = abs.slice(1);
              }
              zip.remove(abs);
              display(path);
              
        }//rem
        
        
        dir.clear   = function(path){
                                                                                debug('dir.clear',path);
              var list    = read(path);
              list        = list.filter(fn=>fn.startsWith(path));
              list        = list.filter(Boolean);
              
              console.json(list);
              
              /*
              list.forEach(fn=>{
              
                    zip.remove(fn);
                    
              });
              */
              
        }//clear
        
        
        dir.dblclick    = function(path,name){
        
              path   += name;
              display(path);
              
        }//dblclick
        
        
  //:
  
  
  
        function debug(){
        
              if(!df)return;
              var str   = [...arguments].join(' ');
              console.log('[ https-file ]',str);
              
        }//debug
        
        
        debug.log   = function(){
        
              if(!df)return;
              
              console.log.apply(console,arguments);
              
              if(debug.trace){
                    console.trace();
              }
              delete debug.trace;
              
        }//log
        
        
        debug.log.trace   = function(){
        
              debug.trace   = true;
              debug.log.apply(null,arguments);
              
        }//trace
        
        
        
            </script>
            
      </body>
      
      
</html>


