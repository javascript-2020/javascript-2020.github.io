

<html>

      <head>

            <title>html-editor</title>

            <base href='https://javascript-2020.github.io/utils/editors/html-editor/html-editor.html'>
            
            <link rel=icon type='image/png' href='images/html-editor-favicon.png'>
            <link rel=stylesheet href='/utils/css/utils.css'>


            <script init>
                                                                                console.clear();
                                                                                console.json=v=>console.log(JSON.stringify(v,null,4));
        var ext;
        var $;
        var datatype;
        var menumod;
        var keydown;

        
        var mod           = {};
      
        var filemod;                                                                                


        async function init(){
                                                                                debug('init',version);

              //keydown                   = keydown();
              menumod                   = menumod();
              filemod                   = mod.filemod();
              log                       = mod.log();

              filemod.initmod({ext,$,menumod,complete});


              log.initmod({ext,$});



              filemod.init();


              log.init();


  //:
          


              init.complete();


  //:
  
  
              await initdom(document.body);

              
              ready();


        }//init


        init.stack            = [];
        init.stack.ct         = 0;
        init.stack.total      = 1;
        init.stack.mode       = '';
        init.stack.complete   = false;
        Object.defineProperty(init.stack,'add',{get:()=>{
              init.stack.total++;
              init.stack.mode && console[init.stack.mode]('add',init.stack.ct,init.stack.total);
        }});
        Object.defineProperty(init.stack,'complete',{get:()=>{
              init.stack.ct++;
              init.stack.mode && console[init.stack.mode]('complete',init.stack.ct,init.stack.total);
              init.stack.ct>=init.stack.total && init();
        }});
        
        //  (typeof init!='undefined' && init?.stack && init.stack.add)
        //  (typeof init!='undefined' && init?.stack && init.stack.complete)

        
        init.complete   = function(){
          
              init.complete.stack.forEach(fn=>fn());
              
        }//complete
        
        init.complete.stack   = [];
        init.complete.add     = fn=>init.complete.stack.push(fn);

                  

(async()=>{
  
        init.stack.add;
        
        var token   = localStorage['github-token'];
        var url;
        var headers;
        if(token){
              url       = 'https://api.github.com/repos/javascript-2020/ext-code/contents/ext-loader.js';
              headers   = {accept:'application/vnd.github.raw',authorization:`bearer ${token}`};
        }else{
              url       = 'https://raw.githubusercontent.com/javascript-2020/ext-code/main/ext-loader.js';
        }
        
        await fetch(url,{headers}).then(res=>res.text()).then(complete);

            
        async function complete(txt){

              ext           = eval(txt);
              var promise   = ext.load.libs(
                    'js/dom/$.js.api',
                    'js/core/datatype.js',
                    'js/dom/menumod/menumod.js',
                    'js/dom/keydown/keydown.js'
              );
              [$,datatype,menumod,keydown,encrypt]   = await promise;

              init.stack.complete;

        }//ext_fn

})();


            </script init>


      

      </head>
      
      
      <body>

            <style id=page-inline>
  html
    {height:100%}
    
  body
    {height:calc(100% - 40px);display:flex;gap:10px}
    
  input
    {font-size:16px;padding:5px 10px}

  .icon
    {border:1px solid gray;border-radius:3px;box-sizing:border-box;width:30px;height:30px;cursor:pointer}
    
  #server-root
    {display:flex;align-items:center;gap:10px}
    
  #status
    {
    }
    
  #message
    {display:flex;flex-direction:column;gap:10px}
    
  #txt
    {display:block;width:100%}
    
  [value=send]
    {display:block}
    
  #view
    {flex:1;display:flex;flex-direction:column;gap:10px;border:1px solid lightgray;border-radius:5px;padding:10px}
    
  .sys
    {border-radius:5px;padding:5px 10px;background:whitesmoke}
    
  .local
    {border:1px solid lightblue;border-radius:5px;padding:5px 10px}
    
  .remote
    {border:1px solid lightblue;border-radius:5px;text-align:right;padding:5px 10px}
    
  .transfer
    {border:1px solid lightgray;border-radius:5px;padding:5px 10px;background:whitesmoke;justify-content:space-between}
    
  .transfer .name
    {}
    
  .transfer .size
    {}
    
    
            </style>
            
            
<!--
            <hdr-grp-api>
                  <script src='https://html-loader-1024713184986.us-central1.run.app/'></script>
                  <img class=title src='images/html-editor.png' style='top:-5px;height:55px'>
                  <span slot=date>11 Jun 2025</span>
            </hdr-grp-api>
-->            

            <div id=server-root>
            
                  <img id=status class=icon src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAAAPFBMVEVHcEzmSD/vQTbsQjjvQTbvQTbqRDruQjftQzjsRDnuQjftQjftQzjuQTbjSD7rRDnqRTvuQjftQzjvQTaizp94AAAAE3RSTlMAD/lh5fEg1p5Pp5GC2AY7J8ZuteK7EAAAAQdJREFUKM+Fk1mShSAMRcMYGRRb9r/XDkgivNdd3g/L4kC4GQBgeRPR1eowGg+f8hl1HdKY1w2H2eui3RwPVUnXD+mkhG71D22DH2ledc1fV7rjmzmyMypzfNM97/ch2uSIAlzir/m/N2eVaiyRaLASKtNh7H9RKaoGuSkPrejl5mF0pu32uCZy/rR/e+XuPwLWb24DqL4NYWSpNyucKIS+7oDzLUF4eewz1gWET8lx8Jaj8IP9OrGG58Q5PZTEbAHh0uDIZXGGLyUetJRlFLXh0w/Op6mooyXEy45XOVOrz12UZnc0lLjtn5ZJvKw0dB2HtSHfw/RoDNPLKL4N8tszeHtE/z7BX1bhJ1cDwoQWAAAAAElFTkSuQmCC'>
                  
                  <label>
                        server
                  </label>
                  
                  <input id=server>
            
                  <input value=connect type=button>
                  
            </div>


            <filemod-api>
                  <script src='https://html-loader-1024713184986.us-central1.run.app/'></script>
            </filemod-api>


            <div id=message>
            
                  <textarea id=txt></textarea>
                  
                  <div>
                        <input value=send type=button>
                  </div>
                  
            </div>

            <div id=view>
            
                  <div class=sys>
                  </div>
                  
                  <div class=local>
                  </div>
                  
                  
                  <div class=remote>
                  </div>

                  <div class=transfer>
                  
                        <div class=name></div>
                        <div class=size></div>
                        
                  </div>
                  
            </div>
                  
            

            <log api>
                  <script src='https://html-loader-1024713184986.us-central1.run.app/'></script>
            </log>

            
      
      </body>



      <script>

        var version                         = 'v1.0';
            
        var df                              = true;

        var img                             = {};
        
        var url                             = 'https://localhost:3001';
        
        var mode;
        var makingOffer                     = false;
        var ignoreOffer                     = false;
        var isSettingRemoteAnswerPending    = false;
        
        
        var root;
        
        var txt;
        
        var view;
        var sys   = {};
        var local;
        var remote;
        var transfer;
        
        
        
        var ws              = {};
        ws.on               = {};
        ws.send             = {};
        var pc              = {};
        pc.on               = {};
        var dc              = {};
        dc.on               = {};
        dc.send             = {};
        var btn             = {};
        var create          = {};
        var send            = {};
        var server          = {};
        var kd              = {};


  //:
  

        function ready(){
          
              server.init();
              
        }//ready
        
        
  //:
  
  
        async function initdom(rootnode){   //c
                                                                                debug('initdom');

                                                                                
              root                                    = rootnode;
              
              keydown.initdom();
              menumod.add.style();

              img.disconnected                        = $(root,'#status').src;
              $(root,'#server').value                 = url;
              $(root,'[value=connect]').onclick       = btn.connect;
              

              filemod.initdom(root);


              //message                                 = $(root,'#message');
              txt                                     = $(root,'#txt');
              txt.onkeydown                           = kd.txt;
              
              view                                    = $(root,'#view');
              
              sys.item                                = $(view,'.sys');
              sys.item.remove();
              
              local                                   = $(view,'.local');
              local.remove();
              
              remote                                  = $(view,'.remote');
              remote.remove();
              
              transfer                                = $(view,'.transfer');
              transfer.remove();
              
              

              log.initdom();




        }//initdom


  //:
  

        btn.connect   = async function(){
                                                                                console.clear();
              var url   = $(root,'#server').value;
              await ws.create(url);
              await pc.create();
              
        }//connect
        
        
  //:
  
  
        kd.txt    = function(e){
          
              if(e.ctrlKey){
                    if(e.key=='Enter'){
                          var str   = txt.value;
                          
                          var nlocal            = local.cloneNode(true);
                          nlocal.textContent    = str;
                          view.append(nlocal);
                          
                          dc.send.txt(str);
                          
                          txt.value   = '';
                          
                          e.preventDefault();
                          return false;
                    }
              }
              
        }//txt
        
        
  //:
  
  
        ws.create   = function(url){
                                                                                debug('ws.create');
              var promise           = new Promise(res=>ws.create.resolve=res);
              
              ws.con                = new WebSocket(url);
              ws.con.onopen         = ws.on.open;
              ws.con.onclose        = ws.on.close;
              ws.con.onerror        = ws.on.error;
              ws.con.onmessage      = ws.on.message;
              
              return promise;
              
        }//create.ws


        ws.on.open    = function(){
                                                                                debug('ws.on.open');
        }//on.open
        
        
        ws.on.close    = function(){
                                                                                debug('ws.on.close');
        }//close
        
        
        ws.on.error   = function(){
                                                                                debug('ws.on.error');          
        }//error
        
        
        ws.on.message   = function({data}){
                                                                                debug('ws.on.message');
                                                                                //debug.log(data);
              data    = JSON.parse(data);
              
              switch(data.type){
                
                case 'init'       : ws.on.message.init(data);         break;
                case 'remote'     : ws.on.message.remote(data);       break;
                case 'offer'      : ws.on.message.offer(data);        break;
                case 'answer'     : ws.on.message.answer(data);       break;
                case 'sdp'        : ws.on.message.sdp(data);          break;
                case 'ice'        : ws.on.message.ice(data);          break;
                                      
                default           :
                                                                                debug('ws.on.message unknown');
              }//switch
              
        }//message
        
        
        ws.on.message.init    = function(data){
                                                                                debug('ws.on.message.init');
                                                                                //debug.log(data);
              mode    = data.mode;
              
              ws.create.resolve();

              
        }//init
        
        
        ws.on.message.remote    = function(){
        }//remotee
        
          
        ws.on.message.offer   = async function({offer}){
                                                                                debug('ws.on.message.offer');
              await pc.con.setRemoteDescription(offer);
              pc.create.answer();
              
        }//offer
        
        
        ws.on.message.answer    = async function({answer}){
                                                                                debug('ws.on.message.answer');
              await pc.con.setRemoteDescription(answer);
              
        }//answer
        
        
        ws.on.message.sdp   = function(data){
        }//sdp
        
        
        ws.on.message.ice   = async function({candidate}){
                                                                                debug('ws.on.message.ice');
                                                                                console.log(candidate);
              var err;
              try{
                
                    await pc.con.addIceCandidate(candidate);
                    
              }//try
              catch(err2){
                
                    err   = err2;
                    
              }//catch
              if(err){
                                                                                console.log('ice candidate error');
                                                                                console.log(err);
                    return;
              }
              
        }//ice
        

  //:
  
  
        ws.send.json    = function(json){
          
              var str   = JSON.stringify(json);
              ws.con.send(str);
              
        }//json
        
        
        ws.send.offer   = function(offer){
                                                                                debug('ws.send.offer');
                                                                                //debug.log(offer);
              ws.send.json({type:'offer',offer});
              
        }//offer


        ws.send.answer    = function(answer){
                                                                                debug('ws.send.answer');
                                                                                //debug.log(answer);
              ws.send.json({type:'answer',answer});
              
        }//answer


        ws.send.ice    = function(candidate){
          
              ws.send.json({type:'ice',candidate});
              
        }//ice
        
        
        
        
  //:
  
        
        pc.create   = function(){
                                                                                debug('pc.create',mode);
              var promise   = new Promise(res=>pc.create.resolve=res);
              
              var config    = {
                
                    //iceServers: [{ urls: "stun:stun.my-stun-server.tld" }],
                    
              };

              pc.con                        = new RTCPeerConnection(config);
              pc.con.onerror                = pc.on.error;
              //pc.con.onnegotiationneeded    = pc.on.negotiationneeded;
              pc.con.onicecandidate         = pc.on.ice;
              pc.con.ondatachannel          = pc.on.datachannel;
              
              pc.con.ontack                 = pc.on.track;
              
              
              if(mode==='polite'){
                    dc.create();
                    pc.create.offer();
              }
              

              return promise;
              
        }//create
        
        
        pc.create.offer   = async function(){
                                                                                debug('pc.create.offer');
              var offer   = await pc.con.createOffer();
              await pc.con.setLocalDescription(offer);
              ws.send.offer(offer);
              
              
        }//offer
        
        
        pc.create.answer    = async function(){
                                                                                debug('pc.create.answer');  
              var answer    = await pc.con.createAnswer();
              await pc.con.setLocalDescription(answer);
              ws.send.answer(answer);
              
        }//answer
        

  //:
  
  
        pc.on.error   = function(){
                                                                                console.log('pc.on.error');
              
        }//error
        
  
        pc.on.ice   = async function({candidate}){
                                                                                debug('pc.on.ice');
                                                                                //console.log(candidate);
              
              try{
                
                    await pc.con.addIceCandidate(candidate);
                
              }//try
              
              catch(err){
                
                    if(!ignoreOffer){
                      throw err;
                    }
                    
              }//catch

      
              ws.send.ice(candidate);
    
              
        }//onice
        



        pc.on.negotiationneeded   = async function(){
                                                                                debug('pc.on.negotiationneeded');
              makingOffer = true;
              pc.create.offer();
    
        }//onnegotiationneeded

        
        async function onsdp({description}){
                                                                                debug('onsdp');
              var readyForOffer     = !makingOffer && (pc.signalingState==='stable' || isSettingRemoteAnswerPending);
              var offerCollision    = description.type === 'offer' && !readyForOffer;
          
              ignoreOffer           = !polite && offerCollision;
              if(ignoreOffer){
                    return;
              }
              
              isSettingRemoteAnswerPending    = description.type==='answer';
              
              await pc.setRemoteDescription(description);
              
              isSettingRemoteAnswerPending    = false;
              
              if(description.type==='offer'){
                    await pc.setLocalDescription();
                    send.sdp(pc.localDescription);
                    
              }
      
        }//sdp




        pc.on.datachannel   = function(e){
                                                                                debug('pc.on.datachannel');
              dc.con                = e.channel;
              dc.con.onmessage      = dc.on.message;
              dc.con.onopen         = dc.on.open;
              dc.con.onclose        = dc.on.close;
              dc.con.onerror        = dc.on.error;
                                                                                
        }//ondatachannel




        pc.on.track   = function({track,streams}){
                                                                                debug('pc.on.track');
                                                                                
        }//ontrack
        
        
  //:
  
  
        dc.create   = function(){
                                                                                debug('dc.create');
              dc.con                = pc.con.createDataChannel('data');
              dc.con.onopen         = dc.on.open;
              dc.con.onclose        = dc.on.close;
              dc.con.onerror        = dc.on.error;
              dc.con.onmessage      = dc.on.message;

        }//create
        
        
        dc.on.open    = function(){
                                                                                debug('dc.on.open');
              dc.send.json({type:'hello'});
              
        }//open
        
        
        dc.on.close   = function(){
                                                                                debug('dc.on.close');
        }//close


        dc.on.error   = function(){
                                                                                console.log('dc.on.error');
          
        }//dc.on.error
          
        
        dc.on.message   = function(e){
                                                                                debug('dc.on.message');
                                                                                console.log(e);
              var data    = e.data;
              var type    = datatype(data);
              switch(type){
                
                case 'string'   : dc.on.message.string(data);       break;
                case 'blob'     : dc.on.message.blob(data);         break;
                
              }//switch
              
        }//dc.on.message
        
        
        dc.on.message.string    = function(data){debugger;
          
              data    = JSON.parse(data);
              switch(data.type){
                
                case 'hello'    : dc.hello(data);       break;
                case 'msg'      : dc.msg(data);         break;
                
              }//switch
              
        }//string
        
        
        dc.on.message.blob    = function(data){
        }//blob

        
        dc.hello    = function(){
          
              $(root,'#status').src   = img.connected;
              sys.msg('remote connected');
              
        }//hello
        
        
        dc.msg    = function(data){
          
              if(txt in data){
                    dc.msg.txt(data);
              }
              
              
        }//msg
        
        
        dc.msg.txt    = function({txt}){
          
              var nremote           = remote.cloneNode(true);
              nremote.textContent   = txt;
              view.append(nremote);
              
        }//txt
        
        
  //:
  
  
        dc.send.json    = function(json){
          
              var str   = JSON.stringify(json);
              dc.con.send(str);
              
        }//json
        
        
        dc.send.txt   = function(txt){
          
              dc.send.json({type:'msg',txt});
              
        }//txt

        
  //:


        sys.msg   = function(str){
          
              var node    = sys.item.cloneNode(true);
              node.textContent    = str;
              view.append(node);
              
        }//msg
        
        
  //:
  
  
        function complete(){
        }//complete

        
  //:
  
  
        server.init   = async function(){
          
              var url       = $(root,'#server').value;
              
              var headers   = {mode:'init'};
              var res       = await fetch(url,{headers});
              var txt       = await res.text();
              console.log(txt);
          
        }//init
        
        
  //:
  
  
        img.connected       = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAAARVBMVEVHcEwBpDcJoTwMoD4BpDcFojkCpDgEozkRnUIEozkCpDgCpDgEozkEpDgHozsHojsCpDgDpDgLoD0FozkDozgLoj4BpDfMtSLJAAAAFnRSTlMA+SEQ/mHWpAeT8dyCsVVC6Lsad8gwX3sn2gAAAQNJREFUKM+FU1myhCAMZAmrbDoO9z/qQzaDNa/Ml9Ik6U4HQkYwoaQFsFIJRp7BnKS5B5VuvaCFzEtIoW+UG5ofQQ2fqMo/QnVcmzVvfJhWX+DKoKIf90TljFlBaRlg8Lv4u5uuSwU99nngcPIWybegHsljd2cbrlYYvboPUfCpPGOqP/tZCSgyap9dZkiV4FHPJbFLcsOLYrbVhqSroHGOODhOWKMPA7Zx8a+Lg1lcYAMHXzup7RzhoSfJKYzi6iF118ZYkL83WsbSh7qV8evmIP9Y5EmzBPzBlflqzaMHZMn0xJdpp92fFjvyXIfVkB/LlB/L9LKKb4v89gzeHtG/T/APK5Aru0Zgf4kAAAAASUVORK5CYII=';
        img.disconnected    = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAAAPFBMVEVHcEzmSD/vQTbsQjjvQTbvQTbqRDruQjftQzjsRDnuQjftQjftQzjuQTbjSD7rRDnqRTvuQjftQzjvQTaizp94AAAAE3RSTlMAD/lh5fEg1p5Pp5GC2AY7J8ZuteK7EAAAAQdJREFUKM+Fk1mShSAMRcMYGRRb9r/XDkgivNdd3g/L4kC4GQBgeRPR1eowGg+f8hl1HdKY1w2H2eui3RwPVUnXD+mkhG71D22DH2ledc1fV7rjmzmyMypzfNM97/ch2uSIAlzir/m/N2eVaiyRaLASKtNh7H9RKaoGuSkPrejl5mF0pu32uCZy/rR/e+XuPwLWb24DqL4NYWSpNyucKIS+7oDzLUF4eewz1gWET8lx8Jaj8IP9OrGG58Q5PZTEbAHh0uDIZXGGLyUetJRlFLXh0w/Op6mooyXEy45XOVOrz12UZnc0lLjtn5ZJvKw0dB2HtSHfw/RoDNPLKL4N8tszeHtE/z7BX1bhJ1cDwoQWAAAAAElFTkSuQmCC';
        
  //:
  
  
        function debug(){
          
          if(!df)return;
          var str   = [...arguments].join(' ');
          console.log('[ file-transfer ]',str);
          
        }//debug
        
        
        debug.log   = function(){
        
              if(!df)return;  
              console.log.apply(console,arguments);
              console.trace();
              
        }//log
        

  //:
  
  
        init.stack.complete;

      
      </script>
      
      
      
      
</html>


