

<html>

      <head>

            <title>file-transfer-http</title>
            
            <base href='https://ext-code.com/utils/webrtc/file-transfer-http/'>
            <base href='https://javascript-2020.github.io/utils/webrtc/file-transfer-http/'>
            
            <link rel=icon type='image/png' href='image/file-transfer-http-30.png'>


            <script src='https://libs.ext-code.com/js/dom/component/component.js'></script>
            
            <script init>
                                                                                console.clear();
                                                                                console.log('webrtc-file-transfer-http.html');
                                                                                console.log();
                                                                                console.json=v=>console.log(JSON.stringify(v,null,4));
        var df=true,did='webrtc-file-transfer-http'
        ;

        
        var ext;
        var $;
        var datatype;
        var menumod;
        var keydown;
        var debug;

        var menu;
        
        var filemod;                                                                                
        var log;


  //:
  
  
        mod.stack.add   = init;
        
        async function init(){


              //keydown                   = keydown();
              menu                      = menumod();
              
              filemod                   = mod.filemod;
              log                       = mod.log;

              filemod.initmod({ext,$,menu,menumod,complete});


              log.initmod({ext,$});



              await filemod.init();


              await log.init();


  //:
          


              await initdom(document.body);

              focus();
              ready();

              


        }//init


(async()=>{

        mod.stack.add;
        
        ({ext}    = await import('https://libs.ext-code.com/js/io/ext-loader/ext-loader.m.js'));
          
        var promise   = ext.load.libs(
              'js/dom/$.js',
              'js/core/datatype.js',
              'js/dom/menumod/menumod.js',
              'js/dom/keydown/keydown.js',
        );
        [$,datatype,menumod,keydown]   = await promise;
  
        mod.stack.complete;
              
})();

                  
            </script init>


            <style id=page-inline>
            
  html
    {height:100%;font-family:arial}
    
  body
    {height:calc(100% - 40px);margin:20px;display:flex;flex-direction:column;gap:10px}
    
  input
    {font-size:16px;padding:5px 10px}
  input[type=button]
    {cursor:pointer}

  .icon
    {border:1px solid gray;border-radius:3px;box-sizing:border-box;width:30px;height:30px;cursor:pointer}
    
  .spc
    {flex:1}
    
  #server-root
    {display:flex;align-items:center;gap:10px}
    
  #status
    {padding:2px}
    
  #server-init
    {padding:2px;
      content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAAA81BMVEVHcExUrLxOr7/pXWA1r6pdrtffYWb813JttLRJrrbjYWToXWBertY2r6kzsKr713H71nP812/813A0r6per9ddr9f+129er9foXWFMr8D31oDmX2PpXGD812/oXWH813Bdr9foXWBertb51nc0r6o1r6rmXmI2r6lir9Ner9Y2r6per9boXWE1r6lfrtU3rqn613Ndr9fpXWD31n00r6r812/713H713HnXWHoXmHnXmL613X613XpXWDlYGP713HoXWA1r6k1r6rsW183r6lfr9Zfr9bnXmFfr9b71nL813A2r6k1r6rpXWA0r6pdr9f812+Zt6BJAAAATXRSTlMABSH52oMFXwwSD9VhYYSZLOnx+974g9KQVQEihvql1/xfpxj5pz+SFZiVvrm7Q0FG8O4G7/6QvmB/VCMe4h6myoDKgqKhkZ6SLsmk9w12AA0AAAGGSURBVCjPbZBXYsIwEETXvWA7wQGbEgiYlkoJpEBo6Q0k3/80WYnqoPmy9TSzowVI6lRJlR+neweFJF4ul0pqWNwe1IIjpvvaFqNSVX3jNvwY5R/zv8f5RGFcydkbv1FCnF5h3S6Oyrfswuea9+/vdphfaV4zntN35n0MYOdwglJln09ncXz3kPb3cUHPsX6sf4DWh5px9p14oM3yhwBjNPtdgO44uZ8m9ktN+eRZ/2A9oJf59FkclwwQaITtyoDZ6ScRLk4wHXBlP6YI23NMhyAIjIII69XT11fQNM2RRFhyPc+DLKWhMNx8IWQBIaUZWUALskqIChGllbzInT8hpAEOpkeC4VKDkLoLMqb32oe4M8BsnKpRSq/O/1PrhhDi4Qez04t/5c1LsjIDn165SPityxM+mZf4oCy/ve0ndVgyaa0PrHfGe1FeNiXJlPONAaNv1jbrK8suVDKh476odQYXLWvvkU6Gcmke4VLd5CpkLaxscF19Plyz7ERhVnteqL/uDv4BF0ZImcToH4gAAAAASUVORK5CYII=);
    }
    
  [value=read]
    {margin-left:50px}
    
  #message
    {display:flex;flex-direction:column;gap:10px}
    
  #txt
    {display:block;width:100%;padding:10px;box-sizing:border-box;resize:vertical}
    
  [value=send]
    {display:block}
    
  #view-hdr
    {display:flex;gap:10px}
    
  #view-clear
    {padding:2px;width:20px;height:20px;
      content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAdCAMAAACKeiw+AAABm1BMVEVHcEySFg+BHxuWGBGZFg+DDwt4EA66IReRGROXEwybFAx2FROQEwyEEg2FGRShGQ+TFQ2jHhexIBaeFAurFw6lFg2fFw+nFgyoGRCdFg6EEAymGRCeFAuYFQ6bFQyfHBXUQDWXFQ/KMSanHRXEKh/CJRqWEgrUTEKeFAueFg66HxW3GxCyGQ6fFQugFQu+KB28IxnHNSqPEQytHxe3HxWOHxy5LCSUFAuWEgrHLCG4KSDINCqUEwvOOzGREQqlGhGMEg2/IxilFgyuGA2tGA6dGA6aFAu1Gg+2GxC4HxW3HBLBKyDAJBm/Ihe7IBXHLSK8IRjOQjivHRTDKB2QEAqNEQqUGBKHIBrGOzLKOCy+JRrWXFOtFgyyGAywFwypFQu2GQ3BHRGmFQuhFAq7Gw/EHxTcT0TIIxfRMSXIJhvHLCDZS0CdFArmfnfqop7PLCG/IBXSNyvYRTrTQDXhWU7OOy/ma2PVOy/fU0nNNSnmdWzkYljohH7rt7TNKR7lZVzTUUfkYFboi4Xkdm/YQDXkbmXfamPqmJPqqKUi9jteAAAAXHRSTlMAMwMtOh0FQBKPxQh1IxVXaRoowNW3ReerfCV3+IPPD/Jh7Y+Zpf7s20394evn/ebZ+Uiobw3WpOGmx+C329ZcsF3t5fCe1uzo9M76iLO1+H72v7vy3V0L775T7MqXpbYAAAHuSURBVCjPbZJle+JAFIUHdylSpECBInWXrbfbdXedCIGECO5QoKVd+9lNutmlhJxPc5935sqZC5TfviaThzGdEkik1cVXHeD0e6HXK+STMYcE7kbZdxMgnu/9KRQKv38dng4TKHW74Up0RgPA8Zfrq6tuPt/thF9Mi9QRC9e4vXXhutK2fXndzXcajYtqfEKA+s391uCt8PRWGt/25c9OY1Cjyi95rntfGdT2I9phH5bgCnVx3uKq7CvVmyh1zu2pR6dQbKxRLa7OllbaVK26oZFOaYqs1it1lilz1NrMNBiXyvu83W5WKq+ntEBO6gW2+aPJ4JuyVPeMocvlEo4vTsrQuQWGpul5FEEQl2OM2p5ki3TxqcGI8vJuSejxY7JfLM77gN8JUYhOSd4uprL9fslg4i1yQgg9I7ZMnqXILFNyW4XAb8QwzK2/M7ErQ5JZ0qUSwxCGEcP0ejeSSZHkg7n/BswShEfxL/JBPJNKIcFhuvUlgvCaxN/wIDzOOK13mrEH0gHb3715iCE4nrk/YpXWkEsbb+8rliCK4NAwOqn1ILdsFw7mZQgRZNYi8UlxLxcSVmsnjUGUMI+5bA/k7CKGj8bWA2h3EiG+ejBHYGmzzBf6jxKfhCJpsUmpIomDz3xvH47UsvuxdfLRcgP/mm5ojkTjOQAAAABJRU5ErkJggg==);
    }
    
  #view
    {flex:1;display:flex;flex-direction:column;gap:10px;border:1px solid lightgray;border-radius:5px;padding:10px;
      overflow:auto;
    }
    
  #view>div
    {display:flex;gap:10px;border-radius:5px;padding:5px 10px;white-space:pre-wrap;align-items:center;
      }
    
  .sys
    {background:whitesmoke;font-family:monospace;border:1px solid gray}
    
  .local
    {border:1px solid lightblue}
    
  .remote
    {border:1px solid lightgreen}
    
  .transfer
    {border:1px solid lightgreen}
    
  .transfer .name
    {}
    
  .transfer .size
    {}
    
  .rem
    {width:20px;height:20px;box-sizing:border-box;cursor:pointer;
      content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAAAS1BMVEX9QF3+P1z+P1z3Ql76QV7/P1zzQ2D8P1z8QV39QFz7QF3+P1zrQl7+P1z8QFz5QV38QFz9P1z6QV38QF37P139P1z8QFz9QFz/P1xS9pPTAAAAGHRSTlOR4+0aLvkOfW66ZPoD9rs7Y7dHnGLXmdfqOSKwAAAAtElEQVQoz52TWQ7DIAxEbcy+ZmvD/U9aUqmVkiZY6YgPNA8sjG2IJad6qpRLhPKol1oL5NpRhtTDCWpXt7BAFFdYuUESycWpM4xeSwtgpfb4i3EieAcWQBMesfI0fryRvDpgp6E+obkK5graHfAiRXNNCKadE3LYYyFtu2i0aauFsFLsMNK2CSZGEzaX8A5mgjNPeyc2XyfGfAvzqVxJvgUdzgvKtcM/vcY0MjMGZe0OUX8EX8BZRcLWsjTuAAAAAElFTkSuQmCC);
    }
  .down
    {width:20px;height:20px;box-sizing:border-box;
      content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAAAb1BMVEUBcu1HcEwJdekHdOoCcu0NdugVeOMQduYOduYDc+wMdecFc+sIdOkEc+sfedsGc+oKdOldi7kAcu4Ace4AcO4cge42j+8TfO7S5vr///4LeO7y+P0jhe/n8vyv0vfg7vuZxvXC3vja6/pNnO/4/P2x2eepAAAAEnRSTlP4AFiR7VAYLzjdRsJ8zQqufQLMZvMcAAABDUlEQVQoz62T2XqDIBCFicElVlvrIJtKUfP+z1gWl2mbxJuem/ngh4GBM+TileVlmiClZZF9ekA8bGpKfonernnE+Vv7ULfU4+wJdbxwuPkxBXjw8U6yGk9ogUe0IDnF1E4d2k8SUiIMQvacoeUNSckLfD3DyX9hWDE8xFqwgFHtCLuaucfCHLXj3UbJRfaLC38xtNAZNY93qSSH7e037M9jjjtJf/f1/BVrawREHmhrpwF2DN3cD8xHMwWqp3uI8VFjvQDAtA7BLUfYJVOGD4esmkRMHj4UuFT9eEiNS7h6Fe0AjNv5a9dsllh3spkJ2g5Js81Ml2r/kEOHFc+MfNIGromqmtKnTfSqBb8Bqo85bt4CVEwAAAAASUVORK5CYII=);
    }
    
            </style>
            

      </head>
      
      
      <body>

            
<!--
            <hdr-grp-api>
                  <script src='https://html-loader-1024713184986.us-central1.run.app/'></script>
                  <img class=title src='images/html-editor.png' style='top:-5px;height:55px'>
                  <span slot=date>11 Jun 2025</span>
            </hdr-grp-api>
-->            


            <h3>
                  file transfer http
            </h3>

                  
            <div id=server-root>
            
                  <label>
                        server
                  </label>
                  
                  <input id=server>
            
                  <input value=connect type=button>

                  <img id=status class=icon src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAAAPFBMVEVHcEzmSD/vQTbsQjjvQTbvQTbqRDruQjftQzjsRDnuQjftQjftQzjuQTbjSD7rRDnqRTvuQjftQzjvQTaizp94AAAAE3RSTlMAD/lh5fEg1p5Pp5GC2AY7J8ZuteK7EAAAAQdJREFUKM+Fk1mShSAMRcMYGRRb9r/XDkgivNdd3g/L4kC4GQBgeRPR1eowGg+f8hl1HdKY1w2H2eui3RwPVUnXD+mkhG71D22DH2ledc1fV7rjmzmyMypzfNM97/ch2uSIAlzir/m/N2eVaiyRaLASKtNh7H9RKaoGuSkPrejl5mF0pu32uCZy/rR/e+XuPwLWb24DqL4NYWSpNyucKIS+7oDzLUF4eewz1gWET8lx8Jaj8IP9OrGG58Q5PZTEbAHh0uDIZXGGLyUetJRlFLXh0w/Op6mooyXEy45XOVOrz12UZnc0lLjtn5ZJvKw0dB2HtSHfw/RoDNPLKL4N8tszeHtE/z7BX1bhJ1cDwoQWAAAAAElFTkSuQmCC'>
                  <img id=server-init class=icon src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAAAPFBMVEVHcEzmSD/vQTbsQjjvQTbvQTbqRDruQjftQzjsRDnuQjftQjftQzjuQTbjSD7rRDnqRTvuQjftQzjvQTaizp94AAAAE3RSTlMAD/lh5fEg1p5Pp5GC2AY7J8ZuteK7EAAAAQdJREFUKM+Fk1mShSAMRcMYGRRb9r/XDkgivNdd3g/L4kC4GQBgeRPR1eowGg+f8hl1HdKY1w2H2eui3RwPVUnXD+mkhG71D22DH2ledc1fV7rjmzmyMypzfNM97/ch2uSIAlzir/m/N2eVaiyRaLASKtNh7H9RKaoGuSkPrejl5mF0pu32uCZy/rR/e+XuPwLWb24DqL4NYWSpNyucKIS+7oDzLUF4eewz1gWET8lx8Jaj8IP9OrGG58Q5PZTEbAHh0uDIZXGGLyUetJRlFLXh0w/Op6mooyXEy45XOVOrz12UZnc0lLjtn5ZJvKw0dB2HtSHfw/RoDNPLKL4N8tszeHtE/z7BX1bhJ1cDwoQWAAAAAElFTkSuQmCC'>
                  
                  <input value=read type=button>
                  <input value=process type=button>
                  
            </div>


            <filemod component v2.0></filemod>


            <div id=message>
            
                  <textarea id=txt></textarea>
                  
                  <div>
                        <input value=send type=button>
                  </div>
                  
            </div>


            <div id=view-hdr>
                  <div class=spc></div>
                  <img id=view-clear class=icon>
            </div>

            
            <div id=view style='display:none'>
            
                  <div class=sys>
                        <div class=txt></div>
                        <div class=spc></div>
                        <img class=rem>
                  </div>
                  
                  <div class=local>
                        <div class=txt></div>
                        <div class=spc></div>
                        <img class=rem>
                  </div>
                  
                  
                  <div class=remote>
                        <div class=spc></div>
                        <div class=txt></div>
                        <img class=rem>
                  </div>

                  <div class=transfer>
                        <img class=down>
                        <div class=size></div>
                        <div class=name></div>
                        <div class=spc></div>
                        <img class=rem>
                  </div>
                  
            </div>
                  
            

            <log component v2.0></log>

            
      
      </body>



      <script>


        var img                             = {};
        
        var url                             = 'https://localhost:3001';
        
        var mode;
        var makingOffer                     = false;
        var ignoreOffer                     = false;
        var isSettingRemoteAnswerPending    = false;
        

        var inf                             = Number.MAX_SAFE_INTEGER;
        
        var ui                              = {};
        ui.view                             = {};
        var root;
        var txt;
        
        var view;
        var sys;
        var local;
        var remote;
        var transfer;
        
        
        
        var http            = {};
        http.send           = {};
        http.read           = {};
        var poll            = {};
        poll.time           = 1000;
        poll.max            = 30_000;
        poll.timer          = null;

/*        
        var ws              = {};
        ws.on               = {};
        ws.send             = {};
*/

        var pc              = {};
        pc.on               = {};
        var dc              = {};
        dc.on               = {};
        dc.send             = {};
        var btn             = {};
        btn.click           = {};
        var create          = {};
        var send            = {};
        var server          = {};
        var kd              = {};


  //:
  

        function ready(){

              ui.view.sys('ready');
              
        }//ready
        
        
  //:
  
  
        async function initdom(rootnode){   //c
                                                                                debug('initdom');

                                                                                
              root                                    = rootnode;
              
              keydown.initdom();


              img.disconnected                        = $(root,'#status').src;
              
              $(root,'#server').value                 = url;
              btn.connect                             = $(root,'[value=connect]');
              btn.connect.onclick                     = btn.click.connect;
              $(root,'#server-init').onclick          = btn['server-init'];

              $(root,'[value=read]').onclick          = btn.read;
              $(root,'[value=process]').onclick       = btn.process;

              
              filemod.initdom(root);


              //message                                 = $(root,'#message');
              txt                                     = $(root,'#txt');
              txt.onkeydown                           = kd.txt;
              
              $(root,'#view-clear').onclick           = btn['view-clear'];
              
              view                                    = $(root,'#view');
              
              sys                                     = $(view,'.sys');
              sys.remove();
              
              local                                   = $(view,'.local');
              local.remove();
              
              remote                                  = $(view,'.remote');
              remote.remove();
              
              transfer                                = $(view,'.transfer');
              transfer.remove();
              
              

              log.initdom();


              view.style.display    = '';
              

        }//initdom


        function focus(){
          
              txt.focus();
              
        }//focus
        

  //:
  
  
        kd.txt    = function(e){
          
              if(e.ctrlKey){
                    if(e.key=='Enter'){
                          btn.send();
                          e.preventDefault();
                          return false;
                    }
              }
              
        }//txt
        
        
  //:
  

        btn.click.connect   = async function(){
                                                                                console.clear();
              focus();
              
              if(btn.connect.value=='connect'){
                    await http.create(url);
                    poll.start();
                    await pc.create();
                    btn.connect.value   = 'close';
              }else{
                    pc.close();
                    btn.connect.value   = 'connect';
              }

        }//connect
        
  
        btn['server-init']    = async function(){
          
              focus();
              await http.send.init();

        }//server-init
        
        
        btn.send    = function(){
          
              var str   = txt.value;
              ui.view.local(str);
              dc.send.txt(str);
              txt.value   = '';
              focus();
          
        }//send
        
        
        btn['view-clear']   = function(){
          
              view.replaceChildren();
              focus();
              
        }//view-clear
  
  
        btn.read    = async function(){
          
              focus();
              http.send.read();
              
        }//read


        btn.process   = function(){
          
              pc.process();
              
        }//process
        
  
  //:
  
  
        ui.view.add   = function(node){
          
              var img    = $(node,'.rem');
              if(img){
                    img.onclick    = e=>node.remove();
              }
              
              view.append(node);
              
              view.scrollTop    = inf;
              
              
        }//add
        
        
        ui.view.sys   = function(str){
          
              var nsys    = sys.cloneNode(true);
              
              $(nsys,'.txt').textContent    = str;
              
              ui.view.add(nsys);
              
              return nsys;
              
        }//sys
        
        
        ui.view.sys.green   = function(str){
          
              var nsys    = ui.view.sys.apply(null,arguments);
              nsys.style.borderColor    = 'rgb(102,255,0)';
              return nsys;
              
        }//green
        
        
        ui.view.sys.red   = function(str){
          
              var nsys    = ui.view.sys.apply(null,arguments);
              nsys.style.borderColor    = 'red';
              return nsys;
                
        }//red
        
        
        ui.view.local   = function(txt){
          
              var nlocal            = local.cloneNode(true);
              
              $(nlocal,'.txt').textContent    = txt;
              
              ui.view.add(nlocal);
          
        }//local
        
        
        ui.view.remote    = function(txt){
          
              var nremote           = remote.cloneNode(true);
              
              $(nremote,'.txt').textContent   = txt;
              
              ui.view.add(nremote);
          
        }//remote
        
        
        ui.view.transfer    = function(name,blob){
          
              var size    = hs(blob.size);
              
              var ntransfer                       = transfer.cloneNode(true);
              ntransfer.onclick                   = click;
              
              $(ntransfer,'.name').textContent    = name;
              $(ntransfer,'.size').textContent    = size;
              
              ui.view.add(ntransfer);

              
              function click(e){
                
                    var href      = window.URL.createObjectURL(blob);
                    
                    var a         = document.createElement('a');
                    a.href        = href;
                    a.download    = name;
                    a.click();
                    
              }//click
              
        }//transfer
        
  
  
  
  //:
  
  
        http.create   = async function(url){
          
              var url   = $(root,'#server').value;
              url      += '/setup';

              ui.view.sys(`connect ${url}`);
              
              var err;
              try{
                
                    var res   = await fetch(url);
                    
              }
              catch(err2){
                
                    err   = err2;
                    
              }
              if(err){
                                                                                console.log('http.create error');
                                                                                console.error(err);
                    ui.view.sys.red('http.create error');
                    ui.view.sys.red(err.toString());
                    return;
              }

              var txt   = await res.text();
              mode      = txt;
              
              ui.view.sys(`mode : ${mode}`);
              
              if(mode=='master'){
                    ui.view.sys('waiting for remote ...');
              }
              
        }//create
  
  
  //:
  
  
        http.send.init    = async function(){
          
              var url       = $(root,'#server').value;
              url          += '/init';

              ui.view.sys(`server init ${url}`);
              
              var err;
              try{
                
                    var res       = await fetch(url);
                    
              }//err
              catch(err2){
                
                    err   = err2;
                    
              }//catch
              if(err){
                                                                                console.log('http.send.init error');
                                                                                console.error(err);
                    ui.view.sys.red('http.send.init error');
                    ui.view.sys.red(err.toString());
                    return;
              }
              
              var txt       = await res.text();
              ui.view.sys(txt);
                                                                                console.log(txt);
        }//init
        
        
        http.send.offer   = async function(offer){
                                                                                debug('http.send.offer');
              var url       = $(root,'#server').value;
              url          += '/offer';
              
              var headers   = {mode};
              
              var str       = JSON.stringify(offer);
              var body      = str;
              
              var res       = await fetch(url,{headers,method:'post',body});
              var txt       = await res.text();
              
              console.log(txt);
              
        }//offer


        http.send.answer   = async function(answer){
                                                                                debug('http.send.answer');
              var url       = $(root,'#server').value;
              url          += '/answer';
              
              var headers   = {mode};
              
              var str       = JSON.stringify(answer);
              var body      = str;
              
              var res       = await fetch(url,{headers,method:'post',body});
              var txt       = await res.text();
              
              console.log(txt);
              
        }//answer
        
        
        http.send.ice   = async function(ice){
          
              var url       = $(root,'#server').value;
              url          += '/ice';
              var headers   = {mode};
              var str       = JSON.stringify(ice);
              var body      = str;
              
              var res       = await fetch(url,{headers,method:'post',body});
              var txt       = await res.text();
              console.log(txt);
              
        }//ice
        
        
        http.send.read    = async function(){
          
              var url       = $(root,'#server').value;
              url          += '/read';
              var headers   = {mode};
              
              var res       = await fetch(url,{headers});
              var txt       = await res.text();
              
              
              var parts     = txt.split('\n\n').filter(Boolean);
              var n         = parts.length;
              for(var i=0;i<n;i+=2){
                
                    var type    = parts[i];
                    var value   = parts[i+1];
                    
                    console.log(type);
                    
                    switch(type){
                      
                      case 'offer'    : await http.read.offer(value);         break;
                      case 'answer'   : await http.read.answer(value);        break;
                      case 'ice'      : await http.read.ice(value);           break;
                        
                    }//switch
                    
              }//for

              pc.process();
              
        }//read
  
  
  //:
  
  
        http.read.offer   = async function(offer){
                                                                                debug('http.read.offer');
              var sdp   = JSON.parse(offer);
                                                                                console.log(sdp);
              await pc.con.setRemoteDescription(sdp);
              
              if(mode=='master'){
                    ui.view.sys('offer received');
                    pc.create.answer();
              }else{
                    ui.view.sys('offer received');
              }
                    
        }//offer


        http.read.answer   = async function(answer){
                                                                                debug('http.read.answer');
              var sdp   = JSON.parse(answer);
                                                                                console.log(sdp);
              await pc.con.setRemoteDescription(sdp);
              
              if(mode=='master'){
                    ui.view.sys('answer received');
                    pc.create.answer();
              }else{
                    ui.view.sys('answer received');
              }
                    
        }//answer
        
        
        http.read.ice   = async function(ice){
          
              var str         = ice;
              var candidate   = JSON.parse(str);
                                                                //console.log(candidate);

              ui.view.sys('remote ice candidate');
              
              pc.process(candidate);
              
        }//ice
        

  //:
  
  
        poll.start    = function(){
                                                                                console.log('poll.start');
              setTimeout(poll.stop,poll.max);
              poll.send();
              
        }//start


        poll.send   = async function(){
                                                                                console.log('poll.send');
              await http.send.read();
              
              poll.timer    = setTimeout(poll.send,poll.time);
              
        }//send
        
        
        poll.stop   = function(){
                                                                                console.log('poll.stop');
              clearTimeout(poll.timer);
          
        }//stop
        
        
  //:



/*


        ws.create   = function(url){
                                                                                debug('ws.create');
              var promise           = new Promise(res=>ws.create.resolve=res);
              
              ws.con                = new WebSocket(url);
              ws.con.onopen         = ws.on.open;
              ws.con.onclose        = ws.on.close;
              ws.con.onerror        = ws.on.error;
              ws.con.onmessage      = ws.on.message;
              
              return promise;
              
        }//create.ws


        ws.on.open    = function(){
                                                                                debug('ws.on.open');
              ui.view.sys('signalling open');
              
        }//on.open
        
        
        ws.on.close    = function(){
                                                                                debug('ws.on.close');
              ui.view.sys('signalling closed');
        }//close
        
        
        ws.on.error   = function(){
                                                                                debug('ws.on.error');          
        }//error
        
        
        ws.on.message   = function({data}){
                                                                                debug('ws.on.message');
                                                                                //debug.log(data);
              data    = JSON.parse(data);
              
              switch(data.type){
                
                case 'init'       : ws.on.message.init(data);         break;
                case 'remote'     : ws.on.message.remote(data);       break;
                case 'offer'      : ws.on.message.offer(data);        break;
                case 'answer'     : ws.on.message.answer(data);       break;
                case 'sdp'        : ws.on.message.sdp(data);          break;
                case 'ice'        : ws.on.message.ice(data);          break;
                                      
                default           :
                                                                                debug('ws.on.message unknown');
              }//switch
              
        }//message
        
        
        ws.on.message.init    = function(data){
                                                                                debug('ws.on.message.init');
                                                                                //debug.log(data);
              mode    = data.mode;
              ui.view.sys(`mode : ${mode}`);
              
              if(mode=='master'){
                    ui.view.sys('waiting for remote ...');
              }
              
              ws.create.resolve();

              
        }//init
        
        
        ws.on.message.remote    = function(){
        }//remotee
        
          
        ws.on.message.offer   = async function({offer}){
                                                                                debug('ws.on.message.offer');
              ui.view.sys('offer received');
              
              await pc.con.setRemoteDescription(offer);
              
              pc.create.answer();
              
        }//offer
        
        
        ws.on.message.answer    = async function({answer}){
                                                                                debug('ws.on.message.answer');
              ui.view.sys('answer received');
              
              await pc.con.setRemoteDescription(answer);
              
        }//answer
        
        
        ws.on.message.sdp   = function(data){
        }//sdp
        
        
        ws.on.message.ice   = async function({candidate}){
                                                                                debug('ws.on.message.ice');
                                                                                console.log(candidate);              
              ui.view.sys('ice candidate received');
              
              var err;
              try{
                
                    await pc.con.addIceCandidate(candidate);
                    
              }//try
              catch(err2){
                
                    err   = err2;
                    
              }//catch
              if(err){
                                                                                console.log('ice candidate error');
                                                                                console.error(err);
                    ui.view.sys.red('ice cadidate received error');
                    ui.view.sys.red(err.toString());
                    return;
              }
              
        }//ice
        

  //:
  
  
        ws.send.json    = function(json){
          
              var str   = JSON.stringify(json);
              ws.con.send(str);
              
        }//json
        
        
        ws.send.offer   = function(offer){
                                                                                debug('ws.send.offer');
                                                                                //debug.log(offer);
              ws.send.json({type:'offer',offer});
              
        }//offer


        ws.send.answer    = function(answer){
                                                                                debug('ws.send.answer');
                                                                                //debug.log(answer);
              ws.send.json({type:'answer',answer});
              
        }//answer


        ws.send.ice    = function(candidate){
          
              ws.send.json({type:'ice',candidate});
              
        }//ice
        
*/


  //:
  
        
        pc.create   = function(){
                                                                                debug('pc.create',mode);
              var promise   = new Promise(res=>pc.create.resolve=res);
              
              var config    = {
                
                    iceServers: [
                          {urls:'stun:stun.l.google.com:19302'},
                          {urls:'stun:stun1.l.google.com:19302'},
                          {urls:'stun:stun2.l.google.com:19302'},
                          {urls:'stun:stun3.l.google.com:19302'},
                          {urls:'stun:stun4.l.google.com:19302'}
                    ],
                    
              };
              
              pc.con                            = new RTCPeerConnection(config);
              pc.con.onnegotiationneeded        = pc.on.negotiationneeded;
              pc.con.onicecandidate             = pc.on.ice;
              pc.con.ondatachannel              = pc.on.datachannel;
              pc.onconnectionstatechange        = pc.on.connectionstatechange
              
              pc.con.ontack                     = pc.on.track;
              
              
              if(mode==='polite'){
                    dc.create();
                    pc.create.offer();
              }
              

              return promise;
              
        }//create
        
        
        pc.create.offer   = async function(){
                                                                                debug('pc.create.offer');
              ui.view.sys('offer created');
              
              var offer   = await pc.con.createOffer();
              await pc.con.setLocalDescription(offer);
              
              http.send.offer(offer);
              //ws.send.offer(offer);
              
              
        }//offer
        
        
        pc.create.answer    = async function(){
                                                                                debug('pc.create.answer');  
              ui.view.sys('answer created');
              
              var answer    = await pc.con.createAnswer();
              await pc.con.setLocalDescription(answer);
              
              http.send.answer(answer);
              //ws.send.answer(answer);
              
        }//answer
        

        pc.close    = function(){
          
              if(!pc.con){
                    return;
              }
              pc.con.close();
              pc.con    = null;
              
        }//close
        
        
  //:
  

        pc.on.connectionstatechange   = function(e){
    
    
              var state   = peerConnection.connectionState;
              
              switch(state){
                
                case 'new'              : ui.view.sys('pc new');                      break;
                case 'connecting'       : ui.view.sys('pc connecting');               break;
                case 'connected'        : ui.view.sys('pc connected');                break;
                case 'disconnected'     : ui.view.sys('pc disconnecting');            break;
                case 'closed'           : ui.view.sys('pc closed');                   break;
                case 'failed'           : ui.view.sys('pc failed');                   break;
                  
                default                 : ui.view.sys('pc unknown');                  break;
                  
              }//switch
              
        }//connectionstatechange


        var buf   = [];
        
        pc.on.ice   = async function(e){
                                                                                debug('pc.on.ice');
                                                                                //console.log(e);
              var {candidate}   = e;

/*              
              if(!candidate){
                    return;
              }
*/              
              
              ui.view.sys('local ice candidate');

              http.send.ice(candidate);
              pc.process(candidate);
              
        }//onice
        

        pc.on.negotiationneeded   = async function(){
                                                                                debug('pc.on.negotiationneeded');
              ui.view.sys('negotiation needed');
              
              //makingOffer = true;
              //pc.create.offer();
    
        }//onnegotiationneeded

        
        async function onsdp({description}){
                                                                                debug('onsdp');
              var readyForOffer     = !makingOffer && (pc.signalingState==='stable' || isSettingRemoteAnswerPending);
              var offerCollision    = description.type === 'offer' && !readyForOffer;
          
              ignoreOffer           = !polite && offerCollision;
              if(ignoreOffer){
                    return;
              }
              
              isSettingRemoteAnswerPending    = description.type==='answer';
              
              await pc.setRemoteDescription(description);
              
              isSettingRemoteAnswerPending    = false;
              
              if(description.type==='offer'){
                    await pc.setLocalDescription();
                    send.sdp(pc.localDescription);
                    
              }
      
        }//sdp




        pc.on.datachannel   = function(e){
                                                                                debug('pc.on.datachannel');
              dc.con                = e.channel;
              dc.con.onmessage      = dc.on.message;
              dc.con.onopen         = dc.on.open;
              dc.con.onclose        = dc.on.close;
              dc.con.onerror        = dc.on.error;
                                                                                
        }//ondatachannel


        pc.on.track   = function({track,streams}){
                                                                                debug('pc.on.track');
                                                                                
        }//ontrack
        
        
        pc.process    = function(candidate){

              if(candidate){
                    buf.push(candidate);
              }
                
              if(!pc.con || !pc.con.localDescription || !pc.con.remoteDescription){
                    return;
              }
              
              var buf2    = buf;
              buf         = [];
              
              console.log('process',buf2.length);
              
              buf2.forEach(async candidate=>{
                    
                    ui.view.sys('add ice');
                    console.log(candidate);
                    
                    try{
                      
                          await pc.con.addIceCandidate(candidate);
                      
                    }//try
                    
                    catch(err){
                      
                          ui.view.sys.red('add ice error');
                          ui.view.sys.red(err.toString());
                          
                          
/*                    
                          if(!ignoreOffer){
                                throw err;
                          }
*/                    
      
                          
                    }//catch
      
            
              });

              //buf.length    = 0;
              
        }//process
        
        
  //:
  
  
        dc.create   = function(){
                                                                                debug('dc.create');
              dc.con                = pc.con.createDataChannel('data');
              dc.con.onopen         = dc.on.open;
              dc.con.onclose        = dc.on.close;
              dc.con.onerror        = dc.on.error;
              dc.con.onmessage      = dc.on.message;

        }//create
        
        
        dc.on.open    = function(){
                                                                                debug('dc.on.open');
              ui.view.sys('data channel open');
              
              dc.send.json({type:'hello'});
              
        }//open
        
        
        dc.on.close   = function(){
                                                                                debug('dc.on.close');
              ui.view.sys('data channel closed');
              
        }//close


        dc.on.error   = function(){
                                                                                console.log('dc.on.error');
              ui.view.sys('data channel error');
              
        }//dc.on.error
          
        
        dc.on.message   = function(e){
                                                                                debug('dc.on.message');
                                                                                console.log(e);
              if(dc.on.message.callback){
                    dc.on.message.callback(e);
                    return;
              }
              
              var data    = e.data;
              dc.on.message.string(data);
              
        }//dc.on.message
        
        
        dc.on.message.string    = function(data){
          
              data    = JSON.parse(data);
              switch(data.type){
                
                case 'hello'          : dc.hello(data);           break;
                case 'msg'            : dc.msg(data);             break;
                case 'transfer'       : dc.transfer(data);        break;
                
              }//switch
              
        }//string


  //:
  
        
        dc.hello    = function(){
          
              ui.view.sys.green('remote connected');
              poll.stop();
              
              $(root,'#status').src   = img.connected;
              
        }//hello
        
        
        dc.msg    = function(data){
          
              if('txt' in data){
                    var txt   = data.txt;
                    ui.view.remote(txt);
              }
              
              
        }//msg
        
        
        dc.transfer   = function(data){
          
              var name                  = data.name;
              
              dc.on.message.callback    = callback;
              
              
              function callback(e){
                
                    dc.on.message.callback    = null;
                    
                    var buf     = e.data;
                    var blob    = buf_blob(buf);
                    ui.view.transfer(name,blob);

              }//callback

        }//transfer
        
        
  //:
  
  
        dc.send.json    = function(json){
          
              var str   = JSON.stringify(json);
              dc.con.send(str);
              
        }//json
        
        
        dc.send.txt   = function(txt){
          
              dc.send.json({type:'msg',txt});
              
        }//txt

        
  //:
  
  
        function complete(){
        }//complete


        complete.load   = function(file,blob){
          
              var name    = file.filename;
              var size    = hs(blob.size);
              
              dc.send.json({type:'transfer',name});
              dc.con.send(blob);
              
              //var str   = `${name} ${size} sent`;
              ui.view.transfer(name,blob);
              
        }//load
        
        
        complete.save   = function(file,confirm){
        }//save
        
        
  //:
  

        function sdp_str(sdp){
          
              var o   = {
                    sdp     : btoa(sdp.sdp),
                    type    : sdp.type
              };
              
        }//sdp_str
        
        
        function buf_blob(buf){
          
              var uint8   = new Uint8Array(buf);
              var blob    = new Blob([uint8]);
              return blob;
              
        }//buf_blob


        function hs(size){

              size        = Number(size);
              
              var i       = 0;
              if(size!=0){
                    var t   = Math.log(size)/Math.log(1000);
                    i       = Math.floor(t);
              }
              
              var unit    = ['B','kB','MB','GB','TB'][i];
              var n       = (size/Math.pow(1000,i)).toFixed(2);
              
              var str     = n+' '+unit;
              return str;
              
        }//hs

        
  //:
  
  
        img.connected       = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAAARVBMVEVHcEwBpDcJoTwMoD4BpDcFojkCpDgEozkRnUIEozkCpDgCpDgEozkEpDgHozsHojsCpDgDpDgLoD0FozkDozgLoj4BpDfMtSLJAAAAFnRSTlMA+SEQ/mHWpAeT8dyCsVVC6Lsad8gwX3sn2gAAAQNJREFUKM+FU1myhCAMZAmrbDoO9z/qQzaDNa/Ml9Ik6U4HQkYwoaQFsFIJRp7BnKS5B5VuvaCFzEtIoW+UG5ofQQ2fqMo/QnVcmzVvfJhWX+DKoKIf90TljFlBaRlg8Lv4u5uuSwU99nngcPIWybegHsljd2cbrlYYvboPUfCpPGOqP/tZCSgyap9dZkiV4FHPJbFLcsOLYrbVhqSroHGOODhOWKMPA7Zx8a+Lg1lcYAMHXzup7RzhoSfJKYzi6iF118ZYkL83WsbSh7qV8evmIP9Y5EmzBPzBlflqzaMHZMn0xJdpp92fFjvyXIfVkB/LlB/L9LKKb4v89gzeHtG/T/APK5Aru0Zgf4kAAAAASUVORK5CYII=';
        img.disconnected    = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAMAAAAM7l6QAAAAPFBMVEVHcEzmSD/vQTbsQjjvQTbvQTbqRDruQjftQzjsRDnuQjftQjftQzjuQTbjSD7rRDnqRTvuQjftQzjvQTaizp94AAAAE3RSTlMAD/lh5fEg1p5Pp5GC2AY7J8ZuteK7EAAAAQdJREFUKM+Fk1mShSAMRcMYGRRb9r/XDkgivNdd3g/L4kC4GQBgeRPR1eowGg+f8hl1HdKY1w2H2eui3RwPVUnXD+mkhG71D22DH2ledc1fV7rjmzmyMypzfNM97/ch2uSIAlzir/m/N2eVaiyRaLASKtNh7H9RKaoGuSkPrejl5mF0pu32uCZy/rR/e+XuPwLWb24DqL4NYWSpNyucKIS+7oDzLUF4eewz1gWET8lx8Jaj8IP9OrGG58Q5PZTEbAHh0uDIZXGGLyUetJRlFLXh0w/Op6mooyXEy45XOVOrz12UZnc0lLjtn5ZJvKw0dB2HtSHfw/RoDNPLKL4N8tszeHtE/z7BX1bhJ1cDwoQWAAAAAElFTkSuQmCC';

        
  //:
  
  
  
        function debug(){
          
              if(!df)return;
              var str   = [...arguments].join(' ');
              console.log(`[ ${did} ]`,str);
              
        }//debug


      
      </script>
      
      
      
      
</html>

