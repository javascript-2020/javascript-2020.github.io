<html>

      <head>
      
            <title>encrypt</title>
            
            <base href='https://javascript-2020.github.io/utils/x509/encrypt/encrypt.html'>
            
            <style>
           
  html
      {height:100%}
  body
      {height:calc(100% - 40px);margin:20px;display:flex;flex-direction:column}
  
  #view
      {flex:1}
      
  input
      {font-size:16px;padding:5px 10px}
  input[type=button]
      {cursor:pointer}
      
  .icon
      {border:1px solid gray;border-radius:3px;box-sizing:border-box;width:30px;height:30px;cursor:pointer}
  .spc
      {flex:1}
            
            </style>
            
            <script>            
                                                                                console.clear();
                                                                                console.log('html-editor');
                                                                                console.log();
                                                                                console.json=v=>console.log(JSON.stringify(v,null,4));
        var mod   = {};

        var ext,$,datatype,menumod,keydown,aes
        ;

        var filemod;
        var editor;
        var log;
        
        
        var password;

        
        var btn       = {};
        var encrypt   = {};
        var decrypt   = {};
        
        
  //:
  
  
        async function init(){

              menumod                   = menumod();
          
              filemod                   = filemod();
              editor                    = editor();
              log                       = log();


              filemod.initmod({menumod,complete,editor,init,ext});
              editor.initmod({});
              log.initmod({});


              filemod.init();
              editor.init();
              log.init();


              menumod.on.close          = ()=>editor.focus();

          
              await initdom(document.body);


        }//init

      
        init.stack            = [];
        init.stack.ct         = 0;
        init.stack.total      = 1;
        init.stack.mode       = '';
        init.stack.complete   = false;
        Object.defineProperty(init.stack,'add',{get:()=>{
              init.stack.total++;
              init.stack.mode && console[init.stack.mode]('add',init.stack.ct,init.stack.total);
        }});
        Object.defineProperty(init.stack,'complete',{get:()=>{
              init.stack.ct++;
              init.stack.mode && console[init.stack.mode]('complete',init.stack.ct,init.stack.total);
              init.stack.ct>=init.stack.total && init();
        }});
        init.complete         = function(){init.complete.stack.forEach(fn=>fn())}//complete
        init.complete.stack   = [];
        init.complete.add     = fn=>init.complete.stack.push(fn);
        //  (typeof init!='undefined' && init?.stack && init.stack.add)
        //  (typeof init!='undefined' && init?.stack && init.stack.complete)
      
            </script>

            <script libs>

        init.stack.add;
        
        fetch('https://raw.githubusercontent.com/javascript-2020/ext-code/main/ext-loader.js')
          .then(res=>res.text().then(async txt=>{

              ext           = eval(txt);
              var promise   = ext.load.libs(
                    'js/dom/$.js.api',
                    'js/core/datatype.js',
                    'js/dom/menumod/menumod.js',
                    'js/dom/keydown/keydown.js',
                    'js/crypto/aes/aes.js'
              );
              [$,datatype,menumod,keydown,aes]   = await promise;

              init.stack.complete;

          }));

            </script>
            
      </head>
      
      <body>
      
            <div>
                  <h3>encrypt</h3>
            </div>
            
            <div id=hdr>
            
                  <div id=encrypt-root>
                  
                        <input id=password>
                        
                        <input id=encrypt value=encrypt type=button>
                        <input id=decrypt value=decrypt type=button>
                        
                  </div>
                  
                  <filemod-api>
                        <script src='https://html-loader-1024713184986.us-central1.run.app/'></script>
                  </filemod-api>
                  
            </div>
            
            <div id=view>

                  <editor-api>
                        <script src='https://html-loader-1024713184986.us-central1.run.app/'></script>
                  </editor-api>
            
            </div>

            <log-api>
                  <script src='https://html-loader-1024713184986.us-central1.run.app/'></script>
            </log-api>
            
            
            <script>
            
        async function initdom(rootnode){
          
              var root                  = rootnode;

              $('#encrypt').onclick     = btn.encrypt;
              $('#decrypt').onclick     = btn.decrypt;
              
              
              filemod.initdom(root);
              
              
              view                      = $('#view');
              

              await editor.initdom(view,'text');

              log.initdom();


              editor.focus();
              
          
        }//initdom
        
        
  //:
  
  
        btn.encrypt   = function(){
          
              var password    = $('#password').value;
              var txt         = editor.getValue();
              var mode        = ['simple'];
              var cipher      = encrypt(txt,password);
              
        }//encrypt
        
        
        btn.decrypt   = function(){
          
              var password    = $('#password').value;
              var txt         = editor.getValue();
              var mode        = ['simple'];
              var text        = decrypt(txt,password,'text');
              console.log(text);
              
              
        }//decrypt
        
        
  //:
  
  
        function complete(file){
          
              editor.filename(file);
              editor.filename.save.hide();
              filemod.cur   = file;
              menumod.close();
              editor.focus();
              
        }//complete


        complete.load   = async function(file,blob){
        
              var txt;
              if(typeof blob=='string'){
                    txt   = blob;
              }else{
                    txt   = await blob.text();
              }
              
              editor.clear();
              editor.setValue(txt,-1);
              complete(file);
              
        }//complete.load

        
        complete.save   = function(file,confirm=true){

              complete(file);
              
              if(confirm){
                    log.green(file.filename,'saved');
              }
              
        }//save

        
  //:

  
        function encrypt(text,password){
          
              var fn        = encrypt;
              mode.forEach(name=>fn=fn[name]);
              
              var cipher    = fn(text,password);
              return cipher;
              
        }//encrypt
        
        
        function decrypt(cipher,password){
          
              var fn    = decrypt;
              mode.forEach(name=>fn   = fn[name]);
              
              var text    = fn(cipher,password);
              return text;
              
        }//decrypt
        

  //:
  
  
        encrypt.crypto['aes-ctr']   = async function(text,password){
                                                                                console.log('encrypt :');
                                                                                output_str('text',text);
              var type    = datatype(text);
              var buf     = text;
              switch(type){
              
                case 'string'       : buf   = encoder.encode(text);           break;
                case 'uint8array'   : buf   = text.buffer;                    break;
                case 'blob'         : buf   = await text.arrayBuffer();       break;
                
              }//switch
              
              
              var buf           = encoder.encode(text);
              password          = encoder.encode(password);

              
              var alg           = {name:'PBKDF2'};
              var usage         = ['deriveBits','deriveKey'];
              var imported      = await window.crypto.subtle.importKey('raw',password,alg,false,usage);
              
              var salt          = window.crypto.getRandomValues(new Uint8Array(16));
                                                                                output('salt',salt);
              var iv            = window.crypto.getRandomValues(new Uint8Array(12));
                                                                                output('iv',iv);
              var iterations    = 100000;
              
              var alg           = {name:'PBKDF2',salt,iterations,hash:'SHA-256'};
              var derived       = {name:'AES-GCM',length:256};
              var usage         = ['encrypt','decrypt'];
              var key           = await window.crypto.subtle.deriveKey(alg,imported,derived,true,usage);
      
              
              var cipher        = await window.crypto.subtle.encrypt({name:'AES-GCM',iv},key,buf);
              cipher            = new Uint8Array(cipher);
                                                                                output('cipher',cipher);
              
              var len           = salt.length+iv.length+cipher.length;
              var full          = new Uint8Array(len);
              full.set(salt,0);
              full.set(iv,salt.length);
              full.set(cipher,salt.length+iv.length);
                                                                                output('full',full);              
              return full;

        }//aes-ctr
        
        
        decrypt.crypto['aes-ctr']   = async function(full,password){
                                                                                console.log('decrypt :');

              var type    = datatype(full);
              var buf     = full;
              switch(type){
                
                case 'string'       : buf   = encoder.encode(full);           break;
                case 'uint8array'   : buf   = full.buffer;                    break;
                case 'blob'         : buf   = await full.arrayBuffer();       break;
                
              }//switch
                                                                                
              password          = encoder.encode(password);
              buf               = new Uint8Array(buf);
              
              var salt          = new Uint8Array(16);
              salt.set(full.slice(0,16));
                                                                                output('salt',salt);
              var iv            = new Uint8Array(12);
              iv.set(full.slice(16,28));
                                                                                output('iv',iv);
              var cipher        = new Uint8Array(full.length-28);
              cipher.set(full.slice(28));
                                                                                output('cipher',cipher);
              cipher            = cipher.buffer;
              
              var alg           = {name:'PBKDF2'};
              var usage         = ['deriveBits','deriveKey'];
              var imported      = await window.crypto.subtle.importKey('raw',password,alg,false,usage);
              
              var iterations    = 100000;
              
              var alg           = {name:'PBKDF2',salt,iterations,hash:'SHA-256'};
              var derived       = {name:'AES-GCM',length:256};
              var usage         = ['encrypt','decrypt'];
              var key           = await window.crypto.subtle.deriveKey(alg,imported,derived,true,usage);
              
              
              var decrypted     = await window.crypto.subtle.decrypt({name:'AES-GCM',iv},key,cipher);
                                                                                output_str('text',decrypted);
              return decrypted;
              
          
        }//aes-ctr
        

  //:
  
  
        encrypt.simple    = function(text,password){
          
              aes.encrypt();
              
        }//simple


        decrypt.simple    = function(cipher,password){
          
              aes.decrypt();
              
        }//simple

        
  //:
  
  
  
  //:
  
  
        function output(name,buf){
        
              var b64   = buf_b64(buf);
              var pad   = name.padStart(10);
              console.log(pad,':',b64);
              
        }//output
        
        
        function output_str(name,buf){

              var str;        
              if(typeof buf=='string'){
                    str   = buf;
              }else{
                    str   = buf_str(buf);
              }
              var pad   = name.padStart(10);
              console.log(pad,':',str);
              
        }//output_str


        function buf_str(buf){
        
              var txt   = decoder.decode(buf);
              return txt;
              
        }//buf_str
        
        
        function buf_b64(buf){
        
              var bytes   = new Uint8Array(buf);
              var bin     = bytes.reduce((acc,byte)=>acc+=String.fromCharCode(byte),'');
              var b64     = btoa(bin);
              return b64;
        
        }//blob_b64
            
  
        function b64_buf(b64,type='text/plain'){
        
              var bin     = atob(b64);
              var bytes   = [...bin].map(c=>c.charCodeAt(0));
              var uint8   = new Uint8Array(bytes);
              var buf     = uint8.buffer;
              return buf;
              
        }//b64_blob


      
      
      function b64_blob(b64,type='text/plain'){
      
            var bin     = atob(b64);
            var bytes   = [...bin].map(c=>c.charCodeAt(0));
            var buf     = new Uint8Array(bytes);
            var blob    = new Blob([buf],{type});
            return blob;
            
      }//b64_blob


      async function blob_b64(blob){
      
            var buf     = await blob.arrayBuffer();
            var bytes   = new Uint8Array(buf);
            var bin     = bytes.reduce((acc,byte)=>acc+=String.fromCharCode(byte),'');
            var b64     = btoa(bin);
            return b64;
      
      }//blob_b64


  //:
  
  
        init.stack.complete;
        
            </script>
            
      </body>
      
</html>
      
      