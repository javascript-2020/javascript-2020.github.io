<style>
      html,body{margin:0;height:100%}
      body {display:flex;flex-direction:column}
      #hdr {padding:5px 0;height:30px;display:flex;align-items:center;gap:10px}
      #view {display:flex;flex:1}
      #editor{flex:1}
      iframe{flex:1;box-sizing:border-box}
      .icon{border:1px solid lightgray;border-radius:5px;box-sizing:border-box;width:30px;height:30px;}
      button {padding:5px 10px;cursor:pointer;height:30px}
      
      .slider {position:relative;display:inline-flex;align-items:center;cursor:pointer}
      .slider input {opacity:0;width:0;height:0}
      .slider .label {margin-left:30px}
      .slider .hldr {position:absolute;top:0;left:0;width:30px;height:20px;background-color:#ccc}
      .slider .hldr:before {position:absolute;content:"";height:17px;width:17px;left:2px;bottom:2px;background-color:white;transition:.2s}
      .slider input:checked + .hldr {background-color:#2196F3}
      .slider input:checked + .hldr:before {transform:translateX(9px)}
      .slider .hldr {border-radius:34px}
      .slider .hldr:before {border-radius:50%}
      
</style>

<body>
      <div id=hdr>
            <img class=icon title='ctrl-enter - run & autosave&#013;ctrl-s - save&#013;ctrl-del - delete' style='padding:1px' src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABANJREFUSEvNl2tsVEUUx39n224pEVNsTcGqAYM1gYYP0mCUaILGLqVptzVGKZCArxIU2VYTYpQapU2Mj9jWR9H6wUesUdcGWoRSJIQYjUhETUkkRUVIoGztLqB9bOm2OzL7urtst3eXhsT77c495/+bOXPmzLlCEk9JydOZKsNi8ws2QYqAW4DskOsF4IRC/WRRdIvP393V9fZFM1mZyqC0dONsX8aMZ0SpjUCOmVjou0eJbM/wjb65e/f284l8YsCqbNN8JK0Ii5JeJXN2IXVjkJskMMbMCu4yVP1tolyBD4ohrNftF+dLY/o1AlbljsUIh4CsKwEl5aPoks7mlbFg++bnQF5JSmA6RlbLTHE2eo0V22teANUwHc2kfK2+WeJsGYqABysc9dcotiblPB2jaLDO3rXp1uOrrjCRUpmH02ed+9Ce112BFRdX1NavVmrrOlRQ4/nH4YN2GDgP826AiuXQ1AY1a2B+vsE5dBRO9UF+Hjj3GeMr7wbbncH3f4fB+Q30HA+8Voml4fOdjXWii4PfmnamCnIi4A+3wcvvwck+WFwAj1WC41Vo2gKdB+HYX0HRwWG4747gZJo+NcCPVEBWJuw4AIULYF0ZrK+D8QkeQDyjYxP5sqLcUa5EOqqApMAfdcCvvQbEvnxy8MQEfLILROCrN+CJbXDuHyoRRpWyS7Hd8a4gT8aB/zwNwyOQfS1kzzJWrEPr8sDX3wZXnAicZoEvu6HwVtjwIDz6Ikz4A+ARVIvY7DU/AkvjwB93wlk3LLgJiu8ywEd+g1Nn4fBRGB1LDL7n9mCOXBiE9v3QezIQJQ32wmENHgByr1qoL0v5ENitwT4gPWnwd7/AidNBuf5LIS9aBEsWws4DwTGXG2zLILzHk4PHJwfrLNbh0WGamwv3LoW2PbC2FG7MM6R6foczf0PJMmPs52Mw7AW/H37oiTvioRUHwPGhTqUipGgbHer45EpRLBXzSHKFj9MqYH24cqWilKJtRSCrVUukgBQCr6GwpCiUirkumpsRRBeQcMnUrc1CYFF0dxClOhtFpQmlD9hr9BYx1l7goK6y4LHokqm/6ktClDK9Eh0oShLA9ZmsRfjDZHJKpGGfviS0nb4Wx9MzdSSm7K8ygWYU8yYRb0HoNI+7O338YoFuAiONgM1euxpUm5nvzcBbKGZEGX4P1CcIcayerOnuaPxMj8V0mSvKa95XQrUZ/P5Le/Vs6AT0A08hDJk4iaJ1b2fThrBZDHhJdXVGTn/WF4KY5VFgrwtQtCOECmhCtELt8OR5Hz7S2qpTIfDENfQafr1r5jvJrNwsMgGAonVgzsimaOik4LBYaM+bzRJuCrgbxBHe08vt/h+/MIlmfzV+2v4DHQu0lKRbJa4AAAAASUVORK5CYII='>
            <button id=run>run</button>
            <label class=slider>
                  <span class=track></span>
                  <input type=checkbox>
                  <span class=hldr></span>
                  <span class=label>autosave</span>
            </label>
      </div>
      <div id=view>
            <div id=editor></div>
            <iframe id=iframe></iframe>
      </div>
</body>

<script type=module>
                                                                                console.clear();
      import ace from 'https://cdn.jsdelivr.net/npm/ace-builds/+esm';
      var ui    = {};
      var $     = sel=>document.querySelector(sel);
      
      jsonblob                      = jsonblob();
      var enabled                   = true;
      
      document.addEventListener('keydown',keydown,true);
      
      $('#run').onclick             = run;
      var slider                    = $('.slider input');
      slider.checked                = enabled;
      
      
      var editor                    = ace.edit('editor');
      editor.setShowInvisibles(false);
      editor.setShowPrintMargin(false);
      editor.setPrintMarginColumn(false);
      editor.setBehavioursEnabled(false);
      editor.setDisplayIndentGuides(false);
      editor.setScrollSpeed(2);
      editor.setFontSize(16);
      editor.session.setOptions({tabSize:2,useSoftTabs:true});
      //editor.setGhostText('\n\nctrl-enter - run & autosave\nctrl-s - save\nctrl-del - delete');
      editor.focus();
      
      var json    = await jsonblob.util.query();
      if(json){
            editor.setValue(json.txt,-1);
      }
      
      
      ui.read=function(){
      
            var json    = {v:1,txt:editor.getValue()};
            return json;
            
      }//read
      
      function keydown(e){
      
            if(e.key=='Enter' && e.ctrlKey){
                  run();
            }
            if(e.key=='s' && e.ctrlKey){
                  e.preventDefault();
                  var json    = ui.read();
                  jsonblob.util.save(json);
            }
            if(e.key=='Delete' && e.ctrlKey){
                  jsonblob.util.delete()
            }
            
      }//keydown
      
      function run(){
      
            iframe.srcdoc   = editor.getValue();
            if(!slider.checked)return;
            jsonblob.util.save.debounce(()=>ui.read());
            
      }//run
      
      
      
function jsonblob(){
//  https://jsonblob.com/api
  var obj   = {};
  
        var url           = 'https://jsonblob.com/api/jsonBlob/';
        var id;
        var time          = 500;
        var timer;
        var headers       = {'content-type':'application/json'};
        
        var util          = {};
        util.query        = {};
        obj.util          = {};
  //:
        obj.util.query=async function(){
        
              var tst     = window.location.search.slice(1);
              if(!tst)return;
              var json    = await read(tst);
              if(!json)return;
              id          = tst;
              return json;
              
        }//query
        
        obj.util.query.set=function(){return util.query.set()}
        util.query.set=function(){
        
              var url       = window.location.toString();
              var search    = window.location.search;
              if(search){
                    url     = url.slice(0,-search.length);
              }
              if(id){
                    url    += '?'+id;
              }
              window.history.replaceState(null,'',url);
              
        }//set
        
        obj.util.save=function(json,set=true){return util.save(json,set=true)}
        util.save=async function(json,set=true){
        
              if(id){
                    await update(id,json);
              }else{
                    await create(json);
              }
              if(set){
                    util.query.set();
              }
              
        }//save
        
        obj.util.save.debounce=function(fn){
        
              clearTimeout(timer);
              var json    = fn();
              timer       = setTimeout(util.save,time,json);
              
        }//debounce
        
        obj.util.delete=async function(set=true){
        
              if(id){
                    var result    = await del(id);
                    if(result){
                          id    = null;
                    }
              }
              if(!set)return;
              util.query.set();
              
        }//delete
        
  //:
  
        obj.create=function(json){return create(json)}
        async function create(json){
        
              var body    = JSON.stringify(json);
              var res     = await fetch(url,{method:'post',headers,body});
              if(!res.ok)return;
              var loc     = res.headers.get('location');
              var i       = loc.lastIndexOf('/');
              id          = loc.slice(i+1);
              return id;
              
        }//create
        
        obj.read=function(id){return read(id)}
        async function read(id){
        
              var res     = await fetch(url+id);
              if(!res.ok)return;
              var json    = await res.json();
              return json;
              
        }//read
        
        obj.update=async function(id,json){return update(id,json)}
        async function update(id,json){
        
              var body    = JSON.stringify(json);
              var res     = await fetch(url+id,{method:'put',headers,body});
              return res.ok;
              
        }//update
        
        obj.delete=function(id){return del(id)}
        async function del(id){
        
              var res   = await fetch(url+id,{method:'delete'});
              return res.ok;
              
        }//delete
        
  return obj;
  
}//jsonblob

</script>
