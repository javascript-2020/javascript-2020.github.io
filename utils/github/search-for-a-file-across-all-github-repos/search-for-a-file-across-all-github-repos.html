


<html>

      <head>
      
            <style>

  html
    {height:100%;font-family:arial}
  body
    {height:calc(100% - 40px);margin:20px;display:flex;flex-direction:column;gap:20px}
    
  #title
    {margin-bottom:10px}
  #desc
    {}
    
  .field
    {display:flex;gap:20px;align-items:center}
  .label
    {width:120px;text-align:right;display:flex;align-items:center}
  .field input
    {flex:1}
    
  #token-root
    {margin-top:20px;margin-bottom:20px}
    
  #type
    {display:flex;gap:20px}
  #type>div
    {display:flex;align-items:center}
    
  #type [type=checkbox]
    {width:20px;height:20px;margin-left:10px}
    
  [value=search]
    {padding:5px 20px}
    
  #results
    {flex:1;border:1px solid lightgray;padding:10px;overflow:auto;border-radius:10px}
  .item:nth-child(odd)
    {background:lightgray}
    
  .item
    {display:flex;gap:20px;margin:5px auto;white-space:nowrap}
  .item .repo
    {}
  .item .path
    {flex:1}
  .item .size
    {}
    
  #progress
    {}


  .icon
    {cursor:pointer;width:32px;height:32px;padding:2px;border:1px solid gray;border-radius:3px;box-sizing:border-box}
  .copy
    {content:url(data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAABSlBMVEVHcEwnz/4C8P4g1P4L6P43wf5Mr/4a2v4Y3P4/uv5PrP4+vf5Auv4ozv5KsP4vyv45wP5Jsf5Auf49vP5Mrv4zxf44wf5Lr/46wP4h1P5Lr/46vv5Jsv4R5P5Hs/5Etv44wf5Hs/41w/4uyv47vv49vP5Ftf5GtP4c2f4rzP4tyv4m0f5Etv5Nrv4xxv4xxv4xx/4W3/5KsP5Mr/4/u/4uyv5Isv4K6f4l0f4qzv4W3/4V3/5Nrv5Mrv5Mrv5Mr/4W3v4e2P5BuP5Hsv4N5v4K6f4O5v42w/5Dt/4E7/4uyf4C8P4nz/4M5/4K6v4oz/4P5f4k0v4b2v5Gs/4E7v4I6/5Nrf4e1/4H7P4E7v5Auv5Dtv4sy/5Isv5GtP4wx/49vP4zxf47vv44wP42w/5LsP5Jsf4i1P4n0P4N5v4k0v4a2v4S4v4X3v6OfcqkAAAAVnRSTlMACo7CjQWN/VczjgIJMfIXJzHtjj5iVekR71Hvtz7CjelXjre2wiJj2PCFIWbR7+fEnXaodz3544/USfOC22Tm7CXOnqfUZ+/3VTV9bsTzqGDahpb2tyRB6bIAAAIDSURBVDjLrZVpV9pAFIYntdFiQkZsLCQECtJSlqAsFRBU3Kuta1sncYGuJEDt///aISkkkyHo6enzLTlP5s5758wNAC526pd3d1++/fzx/evNze1tp210wxURUMTWBz2v2EWtLc7jBTPmoJfNrqy8i0ajixgB00VISJIeW9JMKbcWDAYDNiFMQN1EqAAJcUfSBif0fsQWQjLxpjGnXUJa5CoIbTiP8KJ0OqfNMLQIZhGad/Ke3t///vWwGKv1+yPxfW55+TnmJWZW5ggxcqX3m6WSVTpSdPcxHCLExmf97AI8e1j8cK1f8X9Fq/Sotrf0k2v9KRiJ08L8mwhf2CQx8oK/yJyPw3Q67ULaV4Tr7tRCwFfkllLF4ushccwGPyUMzwzhMQz/X1Kz+QVMmh2LcjgsTxDZ3OpqIpFYfDu+KGwoxE5JvTtpF9NX9BEB792jn0gD4eNEsVAQHyXOO7fQFmNNLZOnPV5BqEyI+Yxm1qkluS0BCWRp8FEze6mTJQtVVd8MUfcEhBSGFOGMOWmaoc0AmRoXP5cmiHEReEXANOopzCsLRYlXjWolGXE2jK/r/ujEWAdOFIxWGrjO8ljXazG6MeynthEn2gAP9P7B4XCE2thzdG2v2jbK5LfHZ3hINbclSco6o/kIh1Einq4e1qxp5m2PkqZ/CPvbXvFot+xe7w/EpaiUrJ24NAAAAABJRU5ErkJggg==);
    }
  .paste
    {content:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAAXNSR0IArs4c6QAAAYxJREFUOE/NlLFKw1AUhs9thDSSNhYEC1LIdWj2bl07OPcJxMUXMFsHjUsXrdBdB3HwARxLwIIQXJxcUooHbCOEutRKh9AYucXGtknTGhw8Y3Lud89//stP4I+LRPEopdb3/31EbKxydyhQluVjQoiaTCZTPM9Dv98Hz/M0nufPTdMcRIF9oKIoKcdx3ifNHMeBJEkgiiJYlgWu605zsohoh4F9IJsqs+5pp+UeHNxsgSAIQMiPgOFwCGflHjTbAtw+ia+IuL0UmE1/asbhyxgYVuyyq4c01JuZ3wGjdlS/2/hnQNcDePvg/KEvDQkuDMkejUYF9rHT6TBzfMdmTJnscFry3nUW7p+FqC00EHF30rAUuHNCoVqtQrFYDEANw4BKpQKI6HNWBtZqtQBQVdX4QNM0A0BFUeIDmbT5YquILXmRK7GBsSZcSxBtU5wJAbAH3NjlfD4fGLLVai2WzLpZQMyfIoQclUqlRC6XCwC73S7ouh7+bBbtiFLKkuIx4mUXpqMsMrFXSej5ni+XXuAVg6oGswAAAABJRU5ErkJggg==');
    }

    
  input
    {font-size:16px;padding:5px 10px}
  [type=button],[type=checkbox]
    {cursor:pointer}
    
            </style>
            
      </head>
      
      
      <body>
    
    
            <div id=hdr>
                  <div id=title>
                        github file search
                  </div>
                  
                  <div id=desc>
                        search for a file across all github repos, you can use an ephemeral read only token
                        <div>
                              <a href='https://github.com/settings/personal-access-tokens'>
                                    github.com : Fine-grained personal access tokens
                              </a>
                        </div>
                  </div>
            </div>
            
            <div id=token-root class=field>
                  <span class=label>
                        <span>
                              <img id=token-copy class='copy icon' title=copy>
                              <img id=token-paste class='paste icon' title=paste>
                        </span>
                        <span style='margin-left:10px'>
                              token
                        </span>
                  </span>
                  <input id=token>
            </div>
            
            <div class=field>
                  <span class=label>
                        username
                  </span>
                  <input id=username>
            </div>
            
            <div class=field>
                  <span class=label>
                        search
                  </span>
                  <input id=search>
            </div>
            
            <div id=type>
            
                  <input value=search type=button>
                  <div>
                        plain
                        <input id=plain type=checkbox checked>
                  </div>
                  <div>
                        wildcard
                        <input id=wildcard type=checkbox>
                  </div>
                  <div>
                        regex
                        <input id=regex type=checkbox>
                  </div>
            </div>
            
            <div id=progress>
                  <div id=bar>
                  </div>
            </div>

            <div id=results>
            
                  <div class=item>
                        <span class=repo></span>
                        <span class=path></span>
                        <span class=size></span>
                  </div>
                  
                  <div id=not-found>
                        no files found
                  </div>
            </div>
                  
      </body>
      
      
      <script>
                                                                                console.clear();
                                                                                console.json=v=>console.log(JSON.stringify(v,null,4));
      
        window.onload   = init;

        var ext;
        var $;
        var datatype;
        var github;
        
        
        async function init(){
        
              await libs();
        
              initdom(document.body);
              
              
        }//init
        
        
  //:
  
  
        var ui              = {};
        ui.token            = null;
        var token           = localStorage['github-token']||'';
        var username;
        var search;
        var type            = 'plain';
        var chk             = {};
        var results;
        var item;
        var notfound;
        var progress;
        var bar;
        
        var node            = {};
        
        var btn             = {};
        btn.token           = {};
        var create          = {};
        var fn              = {};
        
  
        function initdom(rootnode){
        
        
              ui.token                          = $('#token');
              ui.token.value                    = token;
              $('#token-copy').onclick          = btn.token.copy;
              $('#token-paste').onclick         = btn.token.paste;
              
              username                          = $('#username');
              username.value                    = 'octocat';
              
              search                            = $('#search');
              search.value                      = 'index.html';
              $('[value=search]').onclick       = btn.search;
              
              
              chk.plain                         = $('#plain');
              chk.plain.onclick                 = btn.plain;
              
              chk.wildcard                      = $('#wildcard');
              chk.wildcard.onclick              = btn.wildcard;
              
              chk.regex                         = $('#regex');
              chk.regex.onclick                 = btn.regex;
              
              
              results                           = $('#results');
              node.item                         = $('.item');
              node.item.remove();
              node.notfound                     = $('#not-found');
              node.notfound.remove();
              
              progress                          = $('#progress');
              progress.remove();
              
        }//initdom
        
        
  //:
  
  
        btn.token.copy    = async function(){
        
              var txt   = token.value;
              await navigator.clipboard.writeText(txt);
              
        }//copy
        
        
        btn.token.paste   = async function(){
        
              var txt       = await navigator.clipboard.readText();
              token.value   = txt;
              
        }//paste
        
        
        btn.search    = function(){
        
              var params    = {
                    username    : username.value,
                    search      : search.value,
                    type,
              };
              fn.search(params);
              
        }//search
        
        
        btn.plain   = function(){
        
              type                    = 'plain';
              
              chk.plain.checked       = true;
              chk.wildcard.checked    = false;
              chk.regex.checked       = false;
              
        }//plain


        btn.wildcard    = function(){
        
              type                    = 'wildcard';
              
              chk.plain.checked       = false;
              chk.wildcard.checked    = true;
              chk.regex.checked       = false;
        
        }//wildcard
        
        
        btn.regex   = function(){

              type                    = 'regex';
              
              chk.plain.checked       = false;
              chk.wildcard.checked    = false;
              chk.regex.checked       = true;
        
        }//regex
        

  //:
  
  
        var max   = 0;
        
        function update(w){
        
              if(w>max){
                    max   = w;
              }
              
              var list    = $.all(results,'.item');
              list.forEach(node=>{
              
                    $(node,'.repo').style.width   = max+'px';
                    
              });
              
        }//update
        
        
        create.item   = function(repo,item){
        
              var nitem   = node.item.cloneNode(true);
              
              $(nitem,'.repo').textContent    = repo;
              $(nitem,'.path').textContent    = item.path;
              $(nitem,'.size').textContent    = hs(item.size);
              
              nitem.title   = item.path;
              
              results.append(nitem);
              
              var w   = $(nitem,'.repo').offsetWidth;
              update(w);
              
        }//create.item
        
        
  //:
  
  
        fn.search   = async function({username,search,type}){
        
              var owner   = username;
              
              var {list,error}    = await github.user.repolist({owner});
              if(error){
                                                                                console.log(error);
                    return;
              }

              var ct    = 0;
              
              await Promise.all(list.map(async repo=>{
              
                    var {branch,error}    = await github.repo.default({owner,repo,token});
                    var {tree,error}      = await github.repo.tree({owner,repo,branch,token});
                    
                    tree.forEach(item=>{
                    
                          var i           = item.path.lastIndexOf('/');
                          var name        = item.path.slice(i+1);
                          
                          var result      = fn[type](name,search,item);
                          if(result){
                                ct++;
                                create.item(repo,item);
                          }
                          
                    });
                    
              }));
              
              if(ct==0){
                    results.append(node.notfound);
              }
        
        }//search
        
        
        fn.plain    = function(name,search){
        
              var result    = name.includes(search);
              return result;
              
        }//plain

        
        fn.wildcard   = function(name,search){
        
              var result    = wildcard(name,search);
              return result;
              
        }//wildcard
        
        
        fn.regex    = function(name,search){
        }//regex
        
        
        
        function wildcard(search,pattern,mode){
                                                                                
              var re      = '';
              var esc     = '.+^${}()|[]\\';
              var n       = pattern.length;              
              for(var i=0;i<n;i++){
              
                    var c   = pattern[i];
                    
                    if(esc.indexOf(c)!=-1){
                          re   += '\\'+c;
                    }
                    else if(c=='?'){
                          re   += '.';
                    }
                    else if(c=='*'){
                          while(pattern[i+1]=='*')i++;
                          re   += '.*';
                    }
                    else if(c=='~'){
                          var c1    = pattern[i+1];
                          if(c1=='*' || c1=='?' || c1=='~'){
                                if(c1=='*' || c1=='?'){
                                      re   += '\\';
                                }
                                re   += c1;
                                i++;
                          }else{
                                re   += c;
                          }
                    }
                    else{
                          re   += c;
                    }
                    
              }//for
              
              if(!mode || mode=='starts'){
                    re    = '^'+re
              }
              if(!mode || mode=='ends'){
                    re    = re+'$';
              }              
              var regex   = new RegExp(re);
              
              var result    = regex.test(search);
              return result;
              
        }//wildcard



        
        function hs(size){

              size    = Number(size);
              
              var t   = Math.floor(Math.log(size)/Math.log(1000));
              var i   = size==0 ? 0 : t;
              
              var h   = size/Math.pow(1000,i);
              var n   = h.toFixed(2);
              
              var u   = ['B','kB','MB','GB','TB'][i];
              
              var s   = n+' '+u
              return s;
              
        }//hs

        
        
  //:
  
  
        async function libs(){
        
              var res   = await fetch('https://raw.githubusercontent.com/javascript-2020/ext-code/main/ext-loader.js');
              var txt   = await res.text();
              ext       = eval(txt);
              
              var promise   = ext.load.libs(
                    'js/dom/$.js',
                    'js/core/datatype.js',
                    'github/github.js.api',
              );
              [$,datatype,github]   = await promise;
              
        }//libs
        
        
        
        
        
      </script>
      
      
</html>