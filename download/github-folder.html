

<h3>download github folder as zip</h3>

<pre>
      https://javascript-2020.github.io/download/github-folder?user=javascript-2020,repo=stackoverflow,branch=main,raw=true,&lt;path>
</pre>

<pre id=output>
</pre>

<script type=module>

        import jszip from 'https://cdn.jsdelivr.net/npm/jszip/+esm';
                                                                                console.clear();

        fetch.import          = url=>fetch(url).then(res=>res.text().then(js=>Promise.resolve(eval(`(${js})`))));
        fetch.import.gitraw   = url=>fetch.import('https://raw.githubusercontent.com/'+url);
        fetch.import.me       = url=>{var i=url.indexOf('/'),repo=url.slice(0,i),path=url.slice(i+1);
                                      return fetch.import.gitraw(`javascript-2020/${repo}/main/${path}`)};

        var hs    = fetch.import.me('libs/js/string/hs');

        
(async ()=>{

        var url       = window.location.toString();
        var i         = url.indexOf('?');
        if(i==-1)return;
        var search    = url.slice(i+1);
        var parts     = search.split(',');
        var path      = parts.pop();
        if(!path)return;
        
        var params    = {};
        parts.forEach(param=>{
        
              var [key,value]   = param.split('=');
              params[key]       = value;
              
        });
        
        var user      = params.user||'javascript-2020';
        var repo      = params.repo||'stackoverflow';
        var branch    = params.branch||'main';
        path          = params.path||path;
        var raw       = params.raw||true;
        
                                                                                dispn('user='+user,'repo='+repo,'branch='+branch,'path='+path,'raw='+raw);
        if(path[0]=='/')path    = path.slice(1);
        if(path && path.slice(-1)!='/')path  += '/';
        
        var zip     = new jszip();
        
        var file    = `${path.split('/').filter(Boolean).at(-1)||repo}.zip`;
        
        var url     = `https://api.github.com/repos/${user}/${repo}/git/trees/${branch}?recursive=true`;
        var res     = await fetch(url);
        
        if(!res.ok){
              var br    = document.createElement('br');
              document.body.append('failed',br.cloneNode());
              var txt   = await res.text();
              document.body.append(txt);
              return;
        }
        
        var json    = await res.json();
        var c       = 0;
        await Promise.all(json.tree.map(async item=>{
        
              if(!item.path.startsWith(path))return;
              
              var fn      = item.path.slice(path.length);
              var node    = disp(++c,fn);
              
              if(item.type=='tree'){
                    zip.folder(fn);
              }else{
                    var url,opts;
                    if(raw){
                          url     = 'https://raw.githubusercontent.com/${user}/${repo}/${branch}/${path}';
                          opts    = {};
                    }else{
                          url     = `https://api.github.com/repos/${user}/${repo}/contents/${item.path}?ref=${branch}`;
                          opts    = {headers:{accept:'application/vnd.github.raw+json'}};
                    }
                    
                    var res   = await fetch(url,opts);
                    try{
                          var hdr   = res.headers.get('content-length')
                          node.append(' ','content-length',' ',hdr);
                    }
                    catch(err){}
                    
                    var blob    = await res.blob();
                    zip.file(fn,blob);
                    
                    node.append(' ',hs(blob.size),' MB');
              }
              
        }));
        
        var blob      = await zip.generateAsync({type:'blob'});
        var url       = window.URL.createObjectURL(blob);
        var a         = document.createElement('a');
        a.href        = url;
        a.download    = file;
        a.click();
        
  //:
  
        function disp(fn){
        
              var str             = [...arguments].join(' ');
              var node            = document.createElement('div');
              node.textContent    = str;
              output.append(node);
              return node;
              
        }//disp
        
        function dispn(fn){
        
              var node;
              [...arguments].forEach(str=>{
              
                    node                = document.createElement('div');
                    node.textContent    = str;
                    output.append(node);
                    
              });
              return node;
              
        }//dispn


})();        

</script>
